<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faizana Raza Madrassa - Complete Result System</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Poppins:wght@300;400;500;600;700&family=Lateef:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a5f7a;
            --secondary: #2a9d8f;
            --accent: #ffd166;
            --light: #f8f9fa;
            --dark: #2d3436;
            --success: #38b000;
            --warning: #ffaa00;
            --danger: #e63946;
            --gold: #ffd700;
            --silver: #c0c0c0;
            --bronze: #cd7f32;
            --shadow: 0 5px 15px rgba(0,0,0,0.1);
            --border-radius: 12px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: #f5f7fa; color: var(--dark); line-height: 1.6; }
        .arabic { font-family: 'Amiri', serif; direction: rtl; }
        .urdu { font-family: 'Lateef', serif; direction: rtl; font-size: 1.2rem; }
        .container { width: 95%; max-width: 1400px; margin: 0 auto; padding: 0 15px; }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white; padding: 1.5rem 0; box-shadow: var(--shadow); position: relative; overflow: hidden;
        }
        .header::before, .header::after {
            content: "Ô∑Ω"; font-family: 'Amiri', serif; position: absolute; top: 50%; transform: translateY(-50%);
            font-size: 3rem; opacity: 0.1;
        }
        .header::before { right: 30px; }
        .header::after { left: 30px; }
        .logo-area { display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 10px; flex-wrap: wrap; }
        .logo-icon { font-size: 2.5rem; color: var(--accent); }
        .madrassa-name { font-size: 1.8rem; font-weight: 800; text-align: center; }
        .madrassa-subtitle { font-size: 1.1rem; opacity: 0.9; text-align: center; font-weight: 300; }
        .sub-header { text-align: center; margin-top: 10px; font-size: 1.1rem; color: rgba(255,255,255,0.9); }
        
        /* Navigation */
        .nav-bar { background: white; padding: 1rem 0; box-shadow: var(--shadow); margin-bottom: 2rem; }
        .nav-container { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
        .nav-link { color: var(--primary); text-decoration: none; font-weight: 600; padding: 10px 20px; border-radius: 50px; transition: all 0.3s; cursor: pointer; }
        .nav-link:hover { background: var(--primary); color: white; }
        .nav-link.active { background: var(--primary); color: white; }
        
        /* Main Content */
        .main-content { min-height: 70vh; padding: 1rem 0; }
        
        /* Cards */
        .card { background: white; border-radius: var(--border-radius); box-shadow: var(--shadow); padding: 2rem; margin-bottom: 2rem; }
        .card-title { color: var(--primary); font-size: 1.8rem; margin-bottom: 1.5rem; border-bottom: 3px solid var(--primary); padding-bottom: 10px; }
        
        /* Search Panel (Public Result) */
        .search-panel {
            background: white; padding: 2rem; border-radius: var(--border-radius); box-shadow: var(--shadow);
            margin: 2rem auto; max-width: 800px;
        }
        .search-title { color: var(--primary); font-size: 1.8rem; margin-bottom: 1.5rem; text-align: center; }
        
        /* Result Display */
        .result-card { background: white; border-radius: var(--border-radius); box-shadow: var(--shadow); padding: 2rem; margin-top: 2rem; }
        .student-header { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; border-left: 8px solid var(--primary); }
        .student-info h3 { color: var(--primary); font-size: 1.8rem; margin-bottom: 0.5rem; }
        .position-badge { padding: 12px 25px; border-radius: 50px; font-weight: 800; font-size: 1.3rem; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .position-1 { background: linear-gradient(135deg, var(--gold) 0%, #ffec80 100%); color: #856404; }
        .position-2 { background: linear-gradient(135deg, var(--silver) 0%, #e0e0e0 100%); color: #495057; }
        .position-3 { background: linear-gradient(135deg, var(--bronze) 0%, #e6b17e 100%); color: white; }
        .position-pass { background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); color: #155724; }
        
        /* Flowers Animation - ONLY FOR POSITION HOLDERS */
        .flower-fall { 
            position: relative; height: 200px; width: 100%; 
            overflow: hidden; margin: 1rem 0; z-index: 1;
        }
        .falling-flower { 
            position: absolute; top: -50px; font-size: 2.5rem; 
            animation: fall linear infinite; z-index: 1;
            filter: drop-shadow(0 2px 5px rgba(0,0,0,0.2));
        }
        @keyframes fall {
            0% { transform: translateY(-50px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(250px) rotate(360deg); opacity: 0; }
        }
        
        /* Marks Table */
        .marks-table { width: 100%; border-collapse: collapse; margin-bottom: 1.5rem; }
        .marks-table th { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; padding: 15px; text-align: left; font-weight: 600; }
        .marks-table td { padding: 15px; border-bottom: 1px solid #eee; }
        .total-section { background: linear-gradient(135deg, #e7f5ff 0%, #d0ebff 100%); padding: 1.5rem; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .percentage { font-size: 2.2rem; font-weight: 800; color: var(--success); }
        
        /* Fine Notice */
        .fine-notice { 
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); 
            border-left: 6px solid var(--warning); padding: 1.2rem; 
            margin: 1.5rem 0; border-radius: 8px;
        }
        
        /* Forms */
        .form-group { margin-bottom: 1.5rem; }
        .form-label { display: block; margin-bottom: 0.8rem; font-weight: 600; color: var(--dark); font-size: 1.1rem; }
        .form-control { width: 100%; padding: 12px 15px; border: 2px solid #e1e5eb; border-radius: 10px; font-size: 1rem; }
        .form-control:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(26,95,122,0.2); }
        .form-row { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 1rem; }
        .form-col { flex: 1; min-width: 200px; }
        
        /* Buttons */
        .btn { padding: 12px 25px; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.2); }
        .btn-block { width: 100%; }
        .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; }
        .btn-secondary { background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: white; }
        .btn-success { background: linear-gradient(135deg, var(--success) 0%, #2dc653 100%); color: white; }
        .btn-warning { background: linear-gradient(135deg, var(--warning) 0%, #ffc107 100%); color: white; }
        .btn-danger { background: linear-gradient(135deg, var(--danger) 0%, #c82333 100%); color: white; }
        .btn-small { padding: 8px 15px; font-size: 0.9rem; }
        
        /* Admin Panel */
        .admin-panel { background: white; border-radius: var(--border-radius); box-shadow: var(--shadow); padding: 2rem; margin: 2rem auto; }
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 2px solid #e1e5eb; flex-wrap: wrap; }
        .admin-title { color: var(--primary); font-size: 1.8rem; }
        .admin-tabs { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 1.5rem; background: #f8f9fa; padding: 1rem; border-radius: var(--border-radius); }
        .tab-btn { padding: 10px 20px; background: white; border: 2px solid #e1e5eb; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s; }
        .tab-btn:hover { background: #f8f9fa; }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Marks Entry Table with Fine Inputs */
        .marks-entry-container { max-height: 500px; overflow-y: auto; border: 1px solid #e1e5eb; border-radius: 8px; padding: 1rem; margin-top: 1rem; }
        .student-row { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #eee; gap: 15px; flex-wrap: wrap; background: #f9f9f9; border-radius: 6px; margin-bottom: 10px; }
        .student-info { flex: 2; min-width: 250px; }
        .student-name { font-weight: 600; color: var(--primary); }
        .student-roll { color: #666; font-size: 0.9rem; }
        .marks-inputs { flex: 3; display: flex; flex-wrap: wrap; gap: 10px; }
        .marks-input { width: 100px; padding: 8px; border: 2px solid #e1e5eb; border-radius: 5px; text-align: center; }
        .position-select { width: 120px; padding: 8px; border: 2px solid #e1e5eb; border-radius: 5px; }
        
        /* Fine Inputs in Marks Entry */
        .fine-inputs-row { flex: 3; display: flex; gap: 10px; min-width: 350px; }
        .fine-amount-input { width: 100px; padding: 8px; border: 2px solid #e1e5eb; border-radius: 5px; text-align: center; }
        .fine-reason-input { flex: 1; padding: 8px; border: 2px solid #e1e5eb; border-radius: 5px; }
        .fees-paid-checkbox { display: flex; align-items: center; gap: 5px; white-space: nowrap; }
        
        /* Tables */
        .data-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .data-table th { background: #f1f3f4; padding: 12px 15px; text-align: left; color: var(--primary); font-weight: 600; border-bottom: 2px solid #e1e5eb; }
        .data-table td { padding: 12px 15px; border-bottom: 1px solid #eee; }
        .data-table tr:hover { background: #f9f9f9; }
        
        /* Alerts */
        .alert { padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
        .alert-info { background: #e7f5ff; color: #0c5460; border-left: 4px solid #17a2b8; }
        .alert-warning { background: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }
        .alert-danger { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
        .alert-success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        
        /* Login Modal */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.7); display: flex; justify-content: center; 
            align-items: center; z-index: 1000; 
        }
        .modal-box { 
            background: white; border-radius: var(--border-radius); padding: 2rem; 
            width: 90%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
        }
        
        /* Utility */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .mt-2 { margin-top: 0.8rem; }
        .mt-3 { margin-top: 1.5rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        .status-badge { padding: 8px 16px; border-radius: 25px; font-weight: 700; }
        .status-present { background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); color: #155724; }
        .status-absent { background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); color: #721c24; }
        .status-paid { background: #d4edda; color: #155724; padding: 5px 10px; border-radius: 20px; font-weight: 600; }
        .status-unpaid { background: #f8d7da; color: #721c24; padding: 5px 10px; border-radius: 20px; font-weight: 600; }
        .loading-spinner { 
            border: 6px solid #f3f3f3; border-top: 6px solid var(--primary); 
            border-radius: 50%; width: 60px; height: 60px; 
            animation: spin 1s linear infinite; margin: 0 auto; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Footer */
        .footer { 
            background: linear-gradient(135deg, var(--dark) 0%, #1a1a1a 100%); 
            color: white; padding: 2rem 0; margin-top: 3rem; 
            text-align: center;
        }
        
        /* Responsive */
        @media (max-width: 992px) {
            .student-row { flex-direction: column; align-items: flex-start; }
            .marks-inputs, .fine-inputs-row { width: 100%; }
            .marks-input { width: 80px; }
        }
        @media (max-width: 768px) {
            .container { width: 100%; padding: 0 10px; }
            .madrassa-name { font-size: 1.4rem; }
            .card, .result-card, .search-panel { padding: 1.5rem; }
            .student-header { flex-direction: column; align-items: flex-start; gap: 15px; }
            .btn { padding: 10px 20px; font-size: 1rem; }
            .nav-container { gap: 10px; }
            .nav-link { padding: 8px 15px; font-size: 0.9rem; }
            .header::before, .header::after { font-size: 2rem; }
            .flower-fall { height: 150px; }
            .admin-tabs { gap: 5px; }
            .tab-btn { padding: 8px 12px; font-size: 0.9rem; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="logo-area">
                <i class="fas fa-mosque logo-icon"></i>
                <div>
                    <h1 class="madrassa-name">Faizana Raza Madrassa</h1>
                    <p class="madrassa-subtitle">Islamic Education & Quran Learning Center</p>
                </div>
            </div>
            <p class="sub-header urdu">ŸÜŸàÿ±ÿßŸÜ€å ŸÇÿßÿπÿØ€Å ÿßŸàÿ± ÿ≥Ÿæÿßÿ±€Å ⁄©ŸÑÿßÿ≥ÿ≤ ⁄©ÿß ÿ±ÿ≤ŸÑŸπ ⁄Ü€å⁄© ⁄©ÿ±ŸÜ€í ⁄©ÿß ŸæŸàÿ±ŸπŸÑ</p>
        </div>
    </header>
    
    <!-- Navigation -->
    <nav class="nav-bar">
        <div class="container nav-container">
            <a class="nav-link active" data-page="public-result">
                <i class="fas fa-search"></i> Check Result
            </a>
            <a class="nav-link" data-page="admin-panel">
                <i class="fas fa-user-shield"></i> Admin Panel
            </a>
        </div>
    </nav>
    
    <!-- Main Content -->
    <div class="container">
        <!-- Public Result Section -->
        <div id="public-result" class="page-content">
            <!-- Search Panel -->
            <div class="search-panel">
                <h2 class="search-title"><i class="fas fa-graduation-cap"></i> Check Your Result</h2>
                <div class="form-group">
                    <label for="rollNumber" class="form-label">Enter Your Roll Number</label>
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <input type="text" id="rollNumber" class="form-control" placeholder="e.g., 2024001" autofocus>
                        <button id="checkResultBtn" class="btn btn-primary" style="min-width: 150px;">
                            <i class="fas fa-search"></i> Check Result
                        </button>
                    </div>
                </div>
                <div class="text-center mt-3">
                    <p style="color: #666;">
                        <i class="fas fa-info-circle"></i> Enter your roll number to view your result
                    </p>
                </div>
            </div>
            
            <!-- Loading -->
            <div id="loadingSpinner" class="hidden text-center">
                <div class="loading-spinner"></div>
                <p class="mt-3" style="font-size: 1.2rem; color: var(--primary);">Loading result...</p>
            </div>
            
            <!-- Error Message -->
            <div id="errorMessage" class="hidden">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="errorText"></span>
                </div>
            </div>
            
            <!-- Result Display -->
            <div id="resultSection" class="result-card hidden">
                <!-- Flowers ONLY for position holders (1st, 2nd, 3rd) -->
                <div id="flowerFall" class="flower-fall hidden"></div>
                
                <!-- Student Header -->
                <div class="student-header">
                    <div class="student-info">
                        <h3 id="studentName">Student Name</h3>
                        <p><i class="fas fa-id-card"></i> Roll No: <span id="resultRollNo">-</span></p>
                        <p><i class="fas fa-school"></i> Class: <span id="studentClass">-</span></p>
                        <p><i class="fas fa-calendar-alt"></i> <span id="examDate">Exam Date: June 2024</span></p>
                        <p id="studentStatus" class="status-badge status-present mt-2">Status: Present</p>
                    </div>
                    <div class="position-badge" id="positionBadge">Position: -</div>
                </div>
                
                <!-- Marks Table -->
                <table class="marks-table">
                    <thead>
                        <tr>
                            <th>Subject</th>
                            <th>Total Marks</th>
                            <th>Obtained Marks</th>
                        </tr>
                    </thead>
                    <tbody id="marksTableBody">
                        <!-- Marks will be inserted here -->
                    </tbody>
                </table>
                
                <!-- Total Marks -->
                <div class="total-section">
                    <div>
                        <h3 style="color: var(--primary); margin-bottom: 10px;">Total Result</h3>
                        <p style="font-size: 1.2rem;">
                            Obtained Marks: <strong id="obtainedMarks">0</strong> / <strong id="totalMarks">100</strong>
                        </p>
                    </div>
                    <div class="percentage" id="percentage">0%</div>
                </div>
                
                <!-- Fine Notice -->
                <div id="fineSection" class="fine-notice hidden">
                    <h4><i class="fas fa-exclamation-circle"></i> Fine Notice</h4>
                    <p id="fineAmount" style="margin-top: 10px; font-size: 1.1rem;"></p>
                </div>
                
                <!-- Prayer Message -->
                <div style="background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%); 
                          color: white; padding: 1.5rem; border-radius: 10px; text-align: center; margin-top: 2rem; font-weight: 700;">
                    <p class="urdu" style="font-size: 1.3rem;">
                        ÿßŸÑŸÑ€Å ÿ™ÿπÿßŸÑ€åŸ∞ €ÅŸÖ ÿ≥ÿ® ⁄©Ÿà ÿπŸÑŸÖ ŸÜÿßŸÅÿπ ÿπÿ∑ÿß ŸÅÿ±ŸÖÿßÿ¶€í ÿßŸàÿ± €ÅŸÖÿßÿ±€å ŸÖÿ≠ŸÜÿ™Ÿà⁄∫ ⁄©Ÿà ŸÇÿ®ŸàŸÑ ŸÅÿ±ŸÖÿßÿ¶€í€î ÿ¢ŸÖ€åŸÜ
                        <br>
                        ŸÜŸÖÿßÿ≤ ⁄©€å Ÿæÿßÿ®ŸÜÿØ€å ÿ±⁄©⁄æ€å⁄∫€î
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Admin Panel Section -->
        <div id="admin-panel" class="page-content hidden">
            <!-- Login Modal -->
            <div id="adminLoginModal" class="modal-overlay">
                <div class="modal-box">
                    <h2 style="color: var(--primary); margin-bottom: 1.5rem; text-align: center;">
                        <i class="fas fa-lock"></i> Admin Login
                    </h2>
                    <div class="form-group">
                        <input type="password" id="adminPassword" class="form-control" placeholder="Enter admin password" autofocus>
                    </div>
                    <div class="form-group">
                        <button id="loginBtn" class="btn btn-primary btn-block">Login</button>
                    </div>
                    <div class="text-center mt-3">
                        <small class="text-muted">Go back to <a href="#" class="nav-link" data-page="public-result">Home Page</a></small>
                    </div>
                </div>
            </div>
            
            <div id="adminContent" class="hidden">
                <!-- Admin Header -->
                <div class="admin-header">
                    <h1 class="admin-title">
                        <i class="fas fa-user-shield"></i> Admin Control Panel
                    </h1>
                    <div>
                        <button id="logoutBtn" class="btn btn-danger">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
                
                <!-- Tabs -->
                <div class="admin-tabs">
                    <button class="tab-btn active" data-tab="examSetup">Exam Setup</button>
                    <button class="tab-btn" data-tab="subjects">Subjects</button>
                    <button class="tab-btn" data-tab="addStudents">Add Students</button>
                    <button class="tab-btn" data-tab="enterMarks">Enter Marks & Fees</button>
                    <button class="tab-btn" data-tab="viewResults">View All Results</button>
                    <button class="tab-btn" data-tab="manageFees">Manage Fees</button>
                    <button class="tab-btn" data-tab="deleteData">Delete Data</button>
                    <button class="tab-btn" data-tab="changePassword">Change Password</button>
                </div>
                
                <!-- Exam Setup -->
                <div id="examSetup" class="tab-content active">
                    <h2 class="card-title">Exam Date Setup</h2>
                    <div class="form-group">
                        <label class="form-label">Exam Date</label>
                        <input type="date" id="examDateInput" class="form-control">
                    </div>
                    <button id="saveExamDateBtn" class="btn btn-success">Save Exam Date</button>
                </div>
                
                <!-- Subjects -->
                <div id="subjects" class="tab-content">
                    <h2 class="card-title">Manage Subjects</h2>
                    <div id="subjectInputs">
                        <!-- Subjects will be loaded here -->
                    </div>
                    <button id="addSubjectBtn" class="btn btn-secondary mt-2">
                        <i class="fas fa-plus"></i> Add Subject
                    </button>
                    <button id="saveSubjectsBtn" class="btn btn-success mt-2">
                        <i class="fas fa-save"></i> Save Subjects
                    </button>
                </div>
                
                <!-- Add Students -->
                <div id="addStudents" class="tab-content">
                    <h2 class="card-title">Add Students (Batch Entry)</h2>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        Add up to 5 students at a time. Roll numbers must be unique.
                    </div>
                    <div id="studentFormsContainer">
                        <!-- Student forms will be added here -->
                    </div>
                    <div class="form-group mt-3">
                        <button id="addFiveStudentsBtn" class="btn btn-primary">
                            <i class="fas fa-plus-circle"></i> Add 5 Student Forms
                        </button>
                        <button id="saveAllStudentsBtn" class="btn btn-success">
                            <i class="fas fa-save"></i> Save All Students
                        </button>
                    </div>
                </div>
                
                <!-- Enter Marks & Fees -->
                <div id="enterMarks" class="tab-content">
                    <h2 class="card-title">Enter Marks, Positions & Fees</h2>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Note:</strong> 
                        <ul style="margin: 10px 0 0 20px;">
                            <li>Leave position as "Auto" for automatic calculation</li>
                            <li>Only one student each for 1st, 2nd, 3rd positions</li>
                            <li>You can add fees/fine directly in this section</li>
                            <li>Check "Fees Paid" if student has paid their fees</li>
                        </ul>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label class="form-label">Filter by Class</label>
                            <select id="marksClass" class="form-control">
                                <option value="all">All Classes</option>
                                <option value="Separa">Separa</option>
                                <option value="Noorani Qayda">Noorani Qayda</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label class="form-label">Actions</label>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button id="saveAllMarksBtn" class="btn btn-success">Save All</button>
                                <button id="autoCalculatePositionsBtn" class="btn btn-primary">
                                    <i class="fas fa-calculator"></i> Auto-Calc Positions
                                </button>
                                <button id="resetAllFeesBtn" class="btn btn-warning">
                                    <i class="fas fa-redo"></i> Reset All Fees
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="marksEntryContainer" class="marks-entry-container">
                        <!-- Student entries will be loaded here -->
                    </div>
                </div>
                
                <!-- View Results -->
                <div id="viewResults" class="tab-content">
                    <h2 class="card-title">View All Results</h2>
                    <div class="form-row">
                        <div class="form-col">
                            <label class="form-label">Filter by Class</label>
                            <select id="filterClass" class="form-control">
                                <option value="all">All Classes</option>
                                <option value="Separa">Separa</option>
                                <option value="Noorani Qayda">Noorani Qayda</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label class="form-label">Actions</label>
                            <div>
                                <button id="deleteAllResultsBtn" class="btn btn-danger">
                                    <i class="fas fa-trash"></i> Delete ALL Results
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Warning:</strong> Deleting results will remove all marks, positions, and fees but keep student info.
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Pos</th><th>Roll</th><th>Name</th><th>Class</th>
                                    <th>Marks</th><th>%</th><th>Status</th>
                                    <th>Fees</th><th>Status</th><th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="allResultsTable">
                                <tr><td colspan="10" class="text-center">Loading results...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Manage Fees Section -->
                <div id="manageFees" class="tab-content">
                    <h2 class="card-title"><i class="fas fa-money-check-alt"></i> Manage Student Fees</h2>
                    
                    <!-- Search Student -->
                    <div class="card" style="margin-bottom: 2rem;">
                        <h3 class="card-title">Search Student</h3>
                        <div class="form-group">
                            <label class="form-label">Enter Roll Number</label>
                            <div class="form-row">
                                <div class="form-col">
                                    <input type="text" id="feeSearchRoll" class="form-control" placeholder="e.g., 2024001">
                                </div>
                                <div class="form-col">
                                    <button id="searchFeeBtn" class="btn btn-primary btn-block">
                                        <i class="fas fa-search"></i> Search
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Fee Details -->
                        <div id="feeDetails" class="hidden">
                            <div class="form-row mt-3">
                                <div class="form-col">
                                    <p><strong>Name:</strong> <span id="feeStudentName">-</span></p>
                                    <p><strong>Roll No:</strong> <span id="feeStudentRoll">-</span></p>
                                    <p><strong>Class:</strong> <span id="feeStudentClass">-</span></p>
                                </div>
                            </div>
                            
                            <h3 class="mt-3">Fee Details</h3>
                            <div class="form-row mt-2">
                                <div class="form-col">
                                    <label class="form-label">Fee/Fine Amount (Rs.)</label>
                                    <input type="number" id="feeAmountInput" class="form-control" placeholder="Enter amount">
                                </div>
                                <div class="form-col">
                                    <label class="form-label">Reason</label>
                                    <input type="text" id="feeReason" class="form-control" placeholder="Enter reason">
                                </div>
                                <div class="form-col">
                                    <label class="form-label">Payment Status</label>
                                    <div class="form-row" style="align-items: center; gap: 10px; margin-top: 10px;">
                                        <input type="checkbox" id="feePaidCheckbox">
                                        <label for="feePaidCheckbox" style="margin: 0;">Fees Paid</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-row mt-3">
                                <div class="form-col">
                                    <button id="assignFeeBtn" class="btn btn-warning">
                                        <i class="fas fa-plus-circle"></i> Assign/Update Fee
                                    </button>
                                    <button id="clearFeeBtn" class="btn btn-danger">
                                        <i class="fas fa-times-circle"></i> Clear Fee
                                    </button>
                                    <button id="markFeePaidBtn" class="btn btn-success">
                                        <i class="fas fa-check-circle"></i> Mark as Paid
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- All Students with Fees -->
                    <div class="card">
                        <h3 class="card-title">All Students with Fees/Fines</h3>
                        <div style="overflow-x: auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Roll No</th>
                                        <th>Name</th>
                                        <th>Class</th>
                                        <th>Amount</th>
                                        <th>Reason</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="allFeesTable">
                                    <tr><td colspan="7" class="text-center">Loading fees data...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Delete Data -->
                <div id="deleteData" class="tab-content">
                    <h2 class="card-title">Delete Data</h2>
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Danger Zone:</strong> These actions cannot be undone!
                    </div>
                    
                    <div class="form-group">
                        <h3>Delete Single Student</h3>
                        <div class="form-row">
                            <div class="form-col">
                                <input type="text" id="deleteRollNo" class="form-control" placeholder="Enter Roll Number">
                            </div>
                            <div class="form-col">
                                <button id="deleteStudentBtn" class="btn btn-danger btn-block">Delete Student</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <h3>Delete Selected Student</h3>
                        <select id="deleteStudentSelect" class="form-control">
                            <option value="">Select student to delete</option>
                        </select>
                        <button id="deleteSelectedBtn" class="btn btn-danger mt-2">Delete Selected Student</button>
                    </div>
                    
                    <div class="form-group">
                        <h3>Delete All Results Only</h3>
                        <div class="alert alert-warning">
                            <i class="fas fa-file-alt"></i>
                            This will delete ALL RESULTS (marks, positions, fees) but keep student info!
                        </div>
                        <button id="deleteAllResultsOnlyBtn" class="btn btn-danger btn-block">
                            <i class="fas fa-trash"></i> Delete ALL Results Only
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <h3>Delete All Data from Firebase</h3>
                        <div class="alert alert-danger">
                            <i class="fas fa-skull-crossbones"></i>
                            This will delete ALL students, subjects, and settings!
                        </div>
                        <button id="deleteAllDataBtn" class="btn btn-danger btn-block">
                            <i class="fas fa-trash"></i> Delete ALL Data from Firebase
                        </button>
                    </div>
                </div>
                
                <!-- Change Password -->
                <div id="changePassword" class="tab-content">
                    <h2 class="card-title">Change Admin Password</h2>
                    <div class="form-group">
                        <label class="form-label">Previous Password</label>
                        <input type="password" id="prevPassword" class="form-control" placeholder="Enter current password">
                    </div>
                    <div class="form-group">
                        <label class="form-label">New Password</label>
                        <input type="password" id="newPassword" class="form-control" placeholder="Enter new password">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm New Password</label>
                        <input type="password" id="confirmPassword" class="form-control" placeholder="Confirm new password">
                    </div>
                    <button id="changePasswordBtn" class="btn btn-success">Change Password</button>
                    
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-key"></i>
                        <strong>Current Password Code:</strong>
                        <div id="currentPasswordCode" style="font-family: monospace; font-size: 1.2rem; margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;"></div>
                        <small>Copy this code when changing password</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p class="arabic" style="font-size: 1.8rem; margin-bottom: 1rem;">ÿ±Ÿéÿ®ŸêŸë ÿ≤ŸêÿØŸíŸÜŸêŸä ÿπŸêŸÑŸíŸÖŸãÿß</p>
            <p style="font-size: 1.1rem; margin-bottom: 1rem;">"My Lord, increase me in knowledge." (Quran 20:114)</p>
            <p>&copy; 2024 Faizana Raza Madrassa - Complete Result System</p>
            <p style="margin-top: 1rem; color: #aaa; font-size: 0.9rem;">
                <i class="fas fa-phone"></i> Contact: 0300-1234567 | 
                <i class="fas fa-map-marker-alt"></i> Address: Madrassa Chowk, City
            </p>
        </div>
    </footer>

    <!-- JavaScript -->
    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDp8fdbDJRs17iFgcj1lN1YAmhiWccEkuc",
            authDomain: "result-app-8cdd1.firebaseapp.com",
            databaseURL: "https://result-app-8cdd1-default-rtdb.firebaseio.com",
            projectId: "result-app-8cdd1",
            storageBucket: "result-app-8cdd1.firebasestorage.app",
            messagingSenderId: "1000820695282",
            appId: "1:1000820695282:web:82a4f0ee1e51de2305f06b"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Global Variables
        let currentAdminPassword = "admin123";
        let isAdminLoggedIn = false;
        let subjects = [];
        let currentStudentRoll = null;
        
        // DOM Elements
        const pageContents = document.querySelectorAll('.page-content');
        const navLinks = document.querySelectorAll('.nav-link');
        
        // Initialize App
        function initApp() {
            // Load admin password
            loadAdminPassword();
            
            // Navigation
            navLinks.forEach(link => {
                link.addEventListener('click', () => switchPage(link.getAttribute('data-page')));
            });
            
            // Initialize Public Result Page
            initPublicResult();
            
            // Initialize Admin Panel
            initAdminPanel();
            
            // Default page
            switchPage('public-result');
            
            // Check if admin already logged in
            if(localStorage.getItem('adminLoggedIn') === 'true') {
                isAdminLoggedIn = true;
                document.getElementById('adminLoginModal').style.display = 'none';
                document.getElementById('adminContent').classList.remove('hidden');
            }
        }
        
        // Page Switching
        function switchPage(pageId) {
            // Hide all pages
            pageContents.forEach(page => page.classList.add('hidden'));
            
            // Show selected page
            document.getElementById(pageId).classList.remove('hidden');
            
            // Update navigation
            navLinks.forEach(link => link.classList.remove('active'));
            document.querySelector(`[data-page="${pageId}"]`).classList.add('active');
            
            // Special handling for admin panel
            if(pageId === 'admin-panel' && !isAdminLoggedIn) {
                document.getElementById('adminLoginModal').style.display = 'flex';
            }
        }
        
        // ==================== PUBLIC RESULT PAGE ====================
        function initPublicResult() {
            const rollNumberInput = document.getElementById('rollNumber');
            const checkResultBtn = document.getElementById('checkResultBtn');
            
            checkResultBtn.addEventListener('click', checkResult);
            rollNumberInput.addEventListener('keypress', e => { 
                if(e.key === 'Enter') checkResult(); 
            });
        }
        
        function checkResult() {
            const rollNo = document.getElementById('rollNumber').value.trim();
            if(!rollNo) return showMessage("Please enter your roll number", 'error');
            
            showLoading(true);
            database.ref(`students/${rollNo}`).once('value').then(snapshot => {
                showLoading(false);
                if(!snapshot.exists()) {
                    showMessage("Student not found. Please check your roll number.", 'error');
                    return;
                }
                
                const student = snapshot.val();
                displayPublicResult(student, rollNo);
            }).catch(error => {
                showLoading(false);
                showMessage("Error: " + error.message, 'error');
            });
        }
        
        function displayPublicResult(student, rollNo) {
            const resultSection = document.getElementById('resultSection');
            resultSection.classList.remove('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
            
            // Student Info
            document.getElementById('studentName').textContent = student.name;
            document.getElementById('resultRollNo').textContent = rollNo;
            document.getElementById('studentClass').textContent = student.class;
            
            // Exam Date
            database.ref('examDate').once('value').then(snapshot => {
                if(snapshot.exists()) {
                    document.getElementById('examDate').textContent = `Exam Date: ${snapshot.val()}`;
                }
            });
            
            // Load subjects
            database.ref('subjects').once('value').then(snapshot => {
                subjects = snapshot.val() || [];
                
                // Calculate marks
                let totalObtained = 0, totalMaximum = 0;
                if(student.marks && subjects.length > 0) {
                    subjects.forEach((subject, index) => {
                        const mark = student.marks && student.marks[index] ? student.marks[index] : 0;
                        totalObtained += parseInt(mark) || 0;
                        totalMaximum += subject.total;
                    });
                }
                
                // Status
                const hasMarks = student.marks && student.marks.some(m => m > 0);
                const isAbsent = student.status === 'absent' || !hasMarks;
                
                const statusEl = document.getElementById('studentStatus');
                if(isAbsent) {
                    statusEl.textContent = 'Status: Absent';
                    statusEl.className = 'status-badge status-absent';
                } else {
                    statusEl.textContent = 'Status: Present';
                    statusEl.className = 'status-badge status-present';
                }
                
                // Position - FLOWERS ONLY FOR 1st, 2nd, 3rd
                const position = student.position || 0;
                const positionBadge = document.getElementById('positionBadge');
                const flowerContainer = document.getElementById('flowerFall');
                
                // Clear previous flowers
                flowerContainer.classList.add('hidden');
                flowerContainer.innerHTML = '';
                
                // Check for position and show flowers ONLY for 1st, 2nd, 3rd
                if(position === 1) {
                    positionBadge.textContent = 'ü•á 1st Position';
                    positionBadge.className = 'position-badge position-1';
                    startFlowerAnimation(); // FLOWERS HERE
                } else if(position === 2) {
                    positionBadge.textContent = 'ü•à 2nd Position';
                    positionBadge.className = 'position-badge position-2';
                    startFlowerAnimation(); // FLOWERS HERE
                } else if(position === 3) {
                    positionBadge.textContent = 'ü•â 3rd Position';
                    positionBadge.className = 'position-badge position-3';
                    startFlowerAnimation(); // FLOWERS HERE
                } else if(position === -1) {
                    // Auto position
                    const percentage = totalMaximum > 0 ? (totalObtained/totalMaximum)*100 : 0;
                    if(percentage >= 33) {
                        positionBadge.textContent = 'Position: Pass üéâ';
                        positionBadge.className = 'position-badge position-pass';
                    } else {
                        positionBadge.textContent = 'Position: Fail';
                        positionBadge.className = 'position-badge';
                    }
                } else if(position === 0 && !isAbsent) {
                    // No position set
                    const percentage = totalMaximum > 0 ? (totalObtained/totalMaximum)*100 : 0;
                    if(percentage >= 33) {
                        positionBadge.textContent = 'Position: Pass üéâ';
                        positionBadge.className = 'position-badge position-pass';
                    } else {
                        positionBadge.textContent = 'Position: Fail';
                        positionBadge.className = 'position-badge';
                    }
                } else {
                    positionBadge.textContent = 'Position: -';
                    positionBadge.className = 'position-badge';
                }
                
                // Marks Table
                const marksBody = document.getElementById('marksTableBody');
                marksBody.innerHTML = '';
                
                if(isAbsent) {
                    marksBody.innerHTML = `
                        <tr>
                            <td colspan="3" class="text-center" style="padding: 30px; color: #666;">
                                <i class="fas fa-user-times" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                <br>Student was absent for the exam
                            </td>
                        </tr>
                    `;
                } else if(subjects.length > 0) {
                    subjects.forEach((subject, index) => {
                        const mark = student.marks && student.marks[index] ? student.marks[index] : 0;
                        const row = `<tr><td>${subject.name}</td><td>${subject.total}</td><td>${mark}</td></tr>`;
                        marksBody.innerHTML += row;
                    });
                }
                
                // Totals
                document.getElementById('obtainedMarks').textContent = totalObtained;
                document.getElementById('totalMarks').textContent = totalMaximum;
                const percentage = totalMaximum > 0 ? ((totalObtained/totalMaximum)*100).toFixed(2) : 0;
                document.getElementById('percentage').textContent = `${percentage}%`;
                
                // Color code percentage
                const percentageEl = document.getElementById('percentage');
                if(percentage >= 80) {
                    percentageEl.style.color = '#28a745';
                } else if(percentage >= 60) {
                    percentageEl.style.color = '#ffc107';
                } else if(percentage >= 33) {
                    percentageEl.style.color = '#17a2b8';
                } else {
                    percentageEl.style.color = '#dc3545';
                }
                
                // Fine/Fee Section
                const fineSection = document.getElementById('fineSection');
                if(student.fee && student.fee.amount > 0) {
                    const paid = student.fee.paid || false;
                    document.getElementById('fineAmount').innerHTML = `
                        <strong>Fee/Fine Amount:</strong> Rs. ${student.fee.amount}<br>
                        <strong>Reason:</strong> ${student.fee.reason || "Not specified"}<br>
                        <strong>Status:</strong> ${paid ? '<span style="color: #28a745;">Paid</span>' : '<span style="color: #dc3545;">Unpaid</span>'}
                    `;
                    fineSection.classList.remove('hidden');
                } else {
                    fineSection.classList.add('hidden');
                }
                
                // Scroll to result
                resultSection.scrollIntoView({ behavior: 'smooth' });
            });
        }
        
        // Flower Animation - ONLY for position holders (1st, 2nd, 3rd)
        function startFlowerAnimation() {
            const container = document.getElementById('flowerFall');
            container.innerHTML = '';
            container.classList.remove('hidden');
            
            // Create beautiful flowers for celebration
            const flowerTypes = ['üíê', 'üå∏', 'üå∫', 'üåª', 'üå∑', 'ü•Ä', 'üåº'];
            
            for(let i = 0; i < 20; i++) {
                const flower = document.createElement('div');
                flower.className = 'falling-flower';
                flower.textContent = flowerTypes[Math.floor(Math.random() * flowerTypes.length)];
                flower.style.left = `${Math.random() * 100}%`;
                flower.style.animationDuration = `${3 + Math.random() * 5}s`;
                flower.style.animationDelay = `${Math.random() * 3}s`;
                flower.style.fontSize = `${1.8 + Math.random() * 1.5}rem`;
                flower.style.opacity = `${0.7 + Math.random() * 0.3}`;
                container.appendChild(flower);
            }
        }
        
        // ==================== ADMIN PANEL ====================
        function initAdminPanel() {
            // Login
            document.getElementById('loginBtn').addEventListener('click', handleAdminLogin);
            document.getElementById('adminPassword').addEventListener('keypress', e => {
                if(e.key === 'Enter') handleAdminLogin();
            });
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => switchAdminTab(btn.getAttribute('data-tab')));
            });
            
            // Exam Setup
            document.getElementById('saveExamDateBtn').addEventListener('click', saveExamDate);
            
            // Subjects
            document.getElementById('addSubjectBtn').addEventListener('click', addSubjectField);
            document.getElementById('saveSubjectsBtn').addEventListener('click', saveSubjects);
            
            // Students
            document.getElementById('addFiveStudentsBtn').addEventListener('click', addFiveStudentForms);
            document.getElementById('saveAllStudentsBtn').addEventListener('click', saveAllStudents);
            
            // Marks & Fees
            document.getElementById('marksClass').addEventListener('change', loadStudentsForMarksWithFees);
            document.getElementById('saveAllMarksBtn').addEventListener('click', saveAllMarksWithFees);
            document.getElementById('autoCalculatePositionsBtn').addEventListener('click', autoCalculatePositions);
            document.getElementById('resetAllFeesBtn').addEventListener('click', confirmResetAllFees);
            
            // View Results
            document.getElementById('filterClass').addEventListener('change', loadAllResults);
            document.getElementById('deleteAllResultsBtn').addEventListener('click', confirmDeleteAllResults);
            document.getElementById('deleteAllResultsOnlyBtn').addEventListener('click', confirmDeleteAllResults);
            
            // Manage Fees
            document.getElementById('searchFeeBtn').addEventListener('click', searchFee);
            document.getElementById('assignFeeBtn').addEventListener('click', assignFee);
            document.getElementById('clearFeeBtn').addEventListener('click', clearFee);
            document.getElementById('markFeePaidBtn').addEventListener('click', markFeePaid);
            
            // Delete Data
            document.getElementById('deleteStudentBtn').addEventListener('click', deleteStudent);
            document.getElementById('deleteSelectedBtn').addEventListener('click', deleteSelectedStudent);
            document.getElementById('deleteAllDataBtn').addEventListener('click', confirmDeleteAllData);
            
            // Change Password
            document.getElementById('changePasswordBtn').addEventListener('click', changeAdminPassword);
        }
        
        // Load Admin Password
        function loadAdminPassword() {
            database.ref('adminPassword').once('value').then(snapshot => {
                if(snapshot.exists()) {
                    currentAdminPassword = snapshot.val();
                } else {
                    database.ref('adminPassword').set(currentAdminPassword);
                }
                document.getElementById('currentPasswordCode').textContent = currentAdminPassword;
            });
        }
        
        // Admin Login
        function handleAdminLogin() {
            const password = document.getElementById('adminPassword').value;
            if(password === currentAdminPassword) {
                isAdminLoggedIn = true;
                localStorage.setItem('adminLoggedIn', 'true');
                document.getElementById('adminLoginModal').style.display = 'none';
                document.getElementById('adminContent').classList.remove('hidden');
                document.getElementById('adminPassword').value = '';
                loadAdminData();
                setTimeout(addFiveStudentForms, 100);
            } else {
                alert("Invalid password!");
            }
        }
        
        // Admin Logout
        function handleLogout() {
            if(confirm("Are you sure you want to logout?")) {
                isAdminLoggedIn = false;
                localStorage.removeItem('adminLoggedIn');
                document.getElementById('adminLoginModal').style.display = 'flex';
                document.getElementById('adminContent').classList.add('hidden');
            }
        }
        
        // Switch Admin Tab
        function switchAdminTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
            
            if(tabId === 'deleteData') {
                loadDeleteStudentDropdown();
            }
            
            if(tabId === 'manageFees') {
                setTimeout(() => {
                    loadAllFees();
                }, 100);
            }
        }
        
        // Load Admin Data
        function loadAdminData() {
            loadSubjects();
            loadExamDate();
            loadStudentsForMarksWithFees();
            loadAllResults();
            loadDeleteStudentDropdown();
        }
        
        // Load Subjects
        function loadSubjects() {
            database.ref('subjects').once('value').then(snapshot => {
                subjects = snapshot.val() || [];
                if(subjects.length === 0) {
                    subjects = [{name: "Quran Recitation", total: 50}];
                    database.ref('subjects').set(subjects);
                }
                updateSubjectInputs();
            });
        }
        
        function updateSubjectInputs() {
            const container = document.getElementById('subjectInputs');
            container.innerHTML = '';
            subjects.forEach((subject, index) => {
                const div = document.createElement('div');
                div.className = 'form-row subject-row mt-2';
                div.innerHTML = `
                    <div class="form-col">
                        <input type="text" class="form-control subject-name" value="${subject.name}" placeholder="Subject Name">
                    </div>
                    <div class="form-col">
                        <input type="number" class="form-control subject-total" value="${subject.total}" placeholder="Total Marks">
                    </div>
                    <div class="form-col">
                        <button class="btn btn-danger remove-subject-btn">
                            <i class="fas fa-times"></i> Remove
                        </button>
                    </div>
                `;
                container.appendChild(div);
                div.querySelector('.remove-subject-btn').addEventListener('click', () => {
                    subjects.splice(index, 1);
                    updateSubjectInputs();
                });
            });
        }
        
        // Add Subject Field
        function addSubjectField() {
            const container = document.getElementById('subjectInputs');
            const div = document.createElement('div');
            div.className = 'form-row subject-row mt-2';
            div.innerHTML = `
                <div class="form-col">
                    <input type="text" class="form-control subject-name" placeholder="Subject Name">
                </div>
                <div class="form-col">
                    <input type="number" class="form-control subject-total" placeholder="Total Marks">
                </div>
                <div class="form-col">
                    <button class="btn btn-danger remove-subject-btn">
                        <i class="fas fa-times"></i> Remove
                    </button>
                </div>
            `;
            container.appendChild(div);
            div.querySelector('.remove-subject-btn').addEventListener('click', () => {
                div.remove();
            });
        }
        
        // Save Subjects
        function saveSubjects() {
            const rows = document.querySelectorAll('.subject-row');
            const newSubjects = [];
            rows.forEach(row => {
                const name = row.querySelector('.subject-name').value.trim();
                const total = parseInt(row.querySelector('.subject-total').value) || 0;
                if(name && total > 0) newSubjects.push({name, total});
            });
            if(newSubjects.length === 0) return alert("Add at least one subject");
            
            database.ref('subjects').set(newSubjects).then(() => {
                subjects = newSubjects;
                alert("Subjects saved successfully!");
                loadStudentsForMarksWithFees();
            });
        }
        
        // Load Exam Date
        function loadExamDate() {
            database.ref('examDate').once('value').then(snapshot => {
                if(snapshot.exists()) {
                    document.getElementById('examDateInput').value = snapshot.val();
                } else {
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('examDateInput').value = today;
                }
            });
        }
        
        // Save Exam Date
        function saveExamDate() {
            const date = document.getElementById('examDateInput').value;
            database.ref('examDate').set(date);
            alert("Exam date saved!");
        }
        
        // Add 5 Student Forms
        function addFiveStudentForms() {
            const container = document.getElementById('studentFormsContainer');
            for(let i = 0; i < 5; i++) {
                const formGroup = document.createElement('div');
                formGroup.className = 'form-row student-form mb-3';
                formGroup.innerHTML = `
                    <div class="form-col">
                        <input type="text" class="form-control student-roll" placeholder="Roll Number">
                    </div>
                    <div class="form-col">
                        <input type="text" class="form-control student-name" placeholder="Student Name">
                    </div>
                    <div class="form-col">
                        <select class="form-control student-class">
                            <option value="Separa">Separa</option>
                            <option value="Noorani Qayda">Noorani Qayda</option>
                        </select>
                    </div>
                    <div class="form-col">
                        <button class="btn btn-danger remove-student-form-btn">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                container.appendChild(formGroup);
                
                formGroup.querySelector('.remove-student-form-btn').addEventListener('click', () => {
                    formGroup.remove();
                });
            }
        }
        
        // Save All Students
        function saveAllStudents() {
            const forms = document.querySelectorAll('.student-form');
            if(forms.length === 0) {
                return alert("No student forms to save. Click 'Add 5 Student Forms' first.");
            }
            
            let validStudents = 0;
            let updates = {};
            
            forms.forEach((form, index) => {
                const rollNo = form.querySelector('.student-roll').value.trim();
                const name = form.querySelector('.student-name').value.trim();
                const cls = form.querySelector('.student-class').value;
                
                if(rollNo && name) {
                    updates[`students/${rollNo}`] = {
                        name,
                        class: cls,
                        position: 0,
                        status: 'present',
                        fee: {amount: 0, reason: "", paid: false},
                        marks: [],
                        createdAt: new Date().toISOString()
                    };
                    validStudents++;
                }
            });
            
            if(validStudents === 0) {
                alert("No valid students to save. Fill in roll number and name.");
                return;
            }
            
            database.ref().update(updates).then(() => {
                alert(`${validStudents} student(s) added successfully!`);
                document.getElementById('studentFormsContainer').innerHTML = '';
                loadStudentsForMarksWithFees();
                loadAllResults();
                loadDeleteStudentDropdown();
                addFiveStudentForms();
            }).catch(error => {
                alert("Error saving students: " + error.message);
            });
        }
        
        // Load Students for Marks Entry WITH FEE INPUTS
        function loadStudentsForMarksWithFees() {
            const selectedClass = document.getElementById('marksClass').value;
            const container = document.getElementById('marksEntryContainer');
            container.innerHTML = '<div class="loading-spinner" style="width: 40px; height: 40px;"></div><p>Loading students...</p>';
            
            database.ref('students').once('value').then(snapshot => {
                const students = snapshot.val() || {};
                container.innerHTML = '';
                
                if(Object.keys(students).length === 0) {
                    container.innerHTML = '<p class="text-center">No students found. Add students first.</p>';
                    return;
                }
                
                Object.keys(students).forEach(rollNo => {
                    const student = students[rollNo];
                    if(selectedClass !== 'all' && student.class !== selectedClass) return;
                    
                    const row = document.createElement('div');
                    row.className = 'student-row';
                    
                    // Marks inputs
                    let marksHTML = '';
                    subjects.forEach((subject, index) => {
                        const mark = student.marks && student.marks[index] ? student.marks[index] : '';
                        marksHTML += `
                            <input type="number" class="marks-input" 
                                   data-roll="${rollNo}" data-index="${index}" 
                                   max="${subject.total}" placeholder="${subject.name}" 
                                   value="${mark}" min="0" max="${subject.total}">
                        `;
                    });
                    
                    // Position select
                    const position = student.position || 0;
                    
                    // Fee data
                    const feeAmount = student.fee?.amount || 0;
                    const feeReason = student.fee?.reason || '';
                    const feePaid = student.fee?.paid || false;
                    
                    row.innerHTML = `
                        <div class="student-info">
                            <div class="student-name">${student.name}</div>
                            <div class="student-roll">${rollNo} - ${student.class}</div>
                        </div>
                        
                        <div class="marks-inputs">
                            ${marksHTML}
                        </div>
                        
                        <div>
                            <select class="position-select" data-roll="${rollNo}">
                                <option value="-1" ${position==-1?'selected':''}>Auto</option>
                                <option value="0" ${position==0?'selected':''}>No Position</option>
                                <option value="1" ${position==1?'selected':''}>1st</option>
                                <option value="2" ${position==2?'selected':''}>2nd</option>
                                <option value="3" ${position==3?'selected':''}>3rd</option>
                            </select>
                        </div>
                        
                        <div class="fine-inputs-row">
                            <input type="number" class="fine-amount-input" data-roll="${rollNo}" 
                                   placeholder="Fee/Fine" value="${feeAmount > 0 ? feeAmount : ''}">
                            <input type="text" class="fine-reason-input" data-roll="${rollNo}" 
                                   placeholder="Reason" value="${feeReason}">
                            <div class="fees-paid-checkbox">
                                <input type="checkbox" class="fees-paid-check" data-roll="${rollNo}" 
                                       ${feePaid ? 'checked' : ''}>
                                <span>Fees Paid</span>
                            </div>
                        </div>
                    `;
                    container.appendChild(row);
                });
            });
        }
        
        // Save All Marks WITH FEE DATA
        function saveAllMarksWithFees() {
            const marksInputs = document.querySelectorAll('.marks-input');
            const positionSelects = document.querySelectorAll('.position-select');
            const feeAmountInputs = document.querySelectorAll('.fine-amount-input');
            const feeReasonInputs = document.querySelectorAll('.fine-reason-input');
            const feePaidChecks = document.querySelectorAll('.fees-paid-check');
            
            let updates = {};
            let positionCount = {1:0,2:0,3:0};
            
            // Count positions
            positionSelects.forEach(select => {
                const pos = parseInt(select.value);
                if(pos > 0) positionCount[pos]++;
            });
            
            // Validate positions
            if(positionCount[1] > 1 || positionCount[2] > 1 || positionCount[3] > 1) {
                return alert("Only one student each for 1st, 2nd, and 3rd positions allowed!");
            }
            
            // Process marks
            marksInputs.forEach(input => {
                const rollNo = input.getAttribute('data-roll');
                const index = parseInt(input.getAttribute('data-index'));
                const mark = input.value.trim();
                
                if(!updates[`students/${rollNo}/marks`]) {
                    updates[`students/${rollNo}/marks`] = [];
                }
                updates[`students/${rollNo}/marks`][index] = mark === '' ? 0 : parseInt(mark);
                
                // Determine status
                const allMarks = Array.from(document.querySelectorAll(`.marks-input[data-roll="${rollNo}"]`));
                const hasMarks = allMarks.some(m => m.value.trim() !== '' && parseInt(m.value) > 0);
                updates[`students/${rollNo}/status`] = hasMarks ? 'present' : 'absent';
            });
            
            // Process positions
            positionSelects.forEach(select => {
                const rollNo = select.getAttribute('data-roll');
                updates[`students/${rollNo}/position`] = parseInt(select.value);
            });
            
            // Process fees
            feeAmountInputs.forEach(input => {
                const rollNo = input.getAttribute('data-roll');
                const amount = parseInt(input.value) || 0;
                const reason = Array.from(feeReasonInputs).find(r => r.getAttribute('data-roll') === rollNo)?.value || '';
                const paid = Array.from(feePaidChecks).find(c => c.getAttribute('data-roll') === rollNo)?.checked || false;
                
                updates[`students/${rollNo}/fee`] = {
                    amount,
                    reason,
                    paid
                };
            });
            
            database.ref().update(updates).then(() => {
                alert("All marks, positions, and fees saved successfully!");
                loadStudentsForMarksWithFees();
                loadAllResults();
            }).catch(error => {
                alert("Error saving data: " + error.message);
            });
        }
        
        // Auto Calculate Positions
        function autoCalculatePositions() {
            const selectedClass = document.getElementById('marksClass').value;
            
            database.ref('students').once('value').then(snapshot => {
                const students = snapshot.val() || {};
                let studentsWithMarks = [];
                
                Object.keys(students).forEach(rollNo => {
                    const student = students[rollNo];
                    if(selectedClass !== 'all' && student.class !== selectedClass) return;
                    
                    let totalMarks = 0;
                    if(student.marks && subjects.length > 0) {
                        subjects.forEach((subject, index) => {
                            const mark = student.marks && student.marks[index] ? student.marks[index] : 0;
                            totalMarks += parseInt(mark) || 0;
                        });
                    }
                    
                    if(totalMarks > 0) {
                        studentsWithMarks.push({
                            rollNo,
                            name: student.name,
                            class: student.class,
                            totalMarks
                        });
                    }
                });
                
                studentsWithMarks.sort((a, b) => b.totalMarks - a.totalMarks);
                
                let updates = {};
                studentsWithMarks.forEach((student, index) => {
                    let position;
                    if(index === 0) position = 1;
                    else if(index === 1) position = 2;
                    else if(index === 2) position = 3;
                    else position = -1;
                    
                    updates[`students/${student.rollNo}/position`] = position;
                });
                
                database.ref().update(updates).then(() => {
                    alert("Positions auto-calculated successfully!");
                    loadStudentsForMarksWithFees();
                    loadAllResults();
                });
            });
        }
        
        // Load All Results
        function loadAllResults() {
            const filter = document.getElementById('filterClass').value;
            const table = document.getElementById('allResultsTable');
            table.innerHTML = '<tr><td colspan="10" class="text-center">Loading...</td></tr>';
            
            database.ref('students').once('value').then(snapshot => {
                const students = snapshot.val() || {};
                table.innerHTML = '';
                
                let allStudents = [];
                
                Object.keys(students).forEach(rollNo => {
                    const student = students[rollNo];
                    if(filter !== 'all' && student.class !== filter) return;
                    
                    // Calculate marks
                    let totalObtained = 0, totalMaximum = 0;
                    if(student.marks && subjects.length > 0) {
                        subjects.forEach((subject, index) => {
                            const mark = student.marks && student.marks[index] ? student.marks[index] : 0;
                            totalObtained += parseInt(mark) || 0;
                            totalMaximum += subject.total;
                        });
                    }
                    
                    const percentage = totalMaximum > 0 ? ((totalObtained/totalMaximum)*100).toFixed(2) : 0;
                    const isAbsent = student.status === 'absent' || !student.marks || student.marks.every(m => m === 0);
                    
                    allStudents.push({
                        rollNo,
                        student,
                        totalObtained,
                        totalMaximum,
                        percentage,
                        isAbsent
                    });
                });
                
                // Sort by position
                allStudents.sort((a, b) => {
                    const posA = a.student.position || 0;
                    const posB = b.student.position || 0;
                    return posA - posB;
                });
                
                // Render table
                allStudents.forEach(data => {
                    const {rollNo, student, totalObtained, totalMaximum, percentage, isAbsent} = data;
                    
                    // Position text
                    let positionText = '-';
                    if(student.position === 1) positionText = 'ü•á';
                    else if(student.position === 2) positionText = 'ü•à';
                    else if(student.position === 3) positionText = 'ü•â';
                    else if(student.position === -1) {
                        positionText = percentage >= 33 ? 'Pass' : 'Fail';
                    }
                    
                    // Fee text
                    const feeAmount = student.fee?.amount || 0;
                    const feePaid = student.fee?.paid || false;
                    const feeText = feeAmount > 0 ? `Rs.${feeAmount}` : 'None';
                    const feeStatus = feeAmount > 0 ? (feePaid ? 'Paid' : 'Unpaid') : '-';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${positionText}</td>
                        <td>${rollNo}</td>
                        <td>${student.name}</td>
                        <td>${student.class}</td>
                        <td>${isAbsent ? 'Absent' : `${totalObtained}/${totalMaximum}`}</td>
                        <td>${isAbsent ? '-' : `${percentage}%`}</td>
                        <td>${isAbsent ? 'Absent' : 'Present'}</td>
                        <td>${feeText}</td>
                        <td>
                            <span class="${feePaid ? 'status-paid' : 'status-unpaid'}">
                                ${feeStatus}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-small btn-primary" onclick="viewStudentAdmin('${rollNo}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-small btn-danger" onclick="deleteStudentFromTable('${rollNo}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    table.appendChild(row);
                });
                
                if(table.innerHTML === '') {
                    table.innerHTML = '<tr><td colspan="10" class="text-center">No students found</td></tr>';
                }
            });
        }
        
        // View Student from Admin Panel
        function viewStudentAdmin(rollNo) {
            switchPage('public-result');
            document.getElementById('rollNumber').value = rollNo;
            setTimeout(() => checkResult(), 100);
        }
        
        // Delete Student from Table
        function deleteStudentFromTable(rollNo) {
            if(confirm(`Are you sure you want to delete student ${rollNo}?`)) {
                database.ref(`students/${rollNo}`).remove().then(() => {
                    alert(`Student ${rollNo} deleted!`);
                    loadAllResults();
                    loadDeleteStudentDropdown();
                    loadStudentsForMarksWithFees();
                });
            }
        }
        
        // Delete All Results Confirmation
        function confirmDeleteAllResults() {
            if(confirm("‚ö†Ô∏è WARNING! This will delete ALL results for ALL students!\n\nMarks, positions, and fees will be cleared.\n\nAre you sure?")) {
                if(prompt("Type 'DELETE ALL RESULTS' to confirm:") === "DELETE ALL RESULTS") {
                    deleteAllResults();
                }
            }
        }
        
        // Delete All Results
        function deleteAllResults() {
            database.ref('students').once('value').then(snapshot => {
                const students = snapshot.val() || {};
                let updates = {};
                
                Object.keys(students).forEach(rollNo => {
                    updates[`students/${rollNo}/marks`] = [];
                    updates[`students/${rollNo}/position`] = 0;
                    updates[`students/${rollNo}/status`] = 'absent';
                    updates[`students/${rollNo}/fee`] = {amount: 0, reason: "", paid: false};
                });
                
                database.ref().update(updates).then(() => {
                    alert("All results deleted successfully!");
                    loadAllResults();
                    loadStudentsForMarksWithFees();
                });
            });
        }
        
        // ==================== MANAGE FEES SECTION ====================
        // Search Fee
        function searchFee() {
            const rollNo = document.getElementById('feeSearchRoll').value.trim();
            if(!rollNo) return alert("Please enter roll number");
            
            currentStudentRoll = rollNo;
            
            database.ref(`students/${rollNo}`).once('value').then(snapshot => {
                if(!snapshot.exists()) {
                    alert("Student not found");
                    document.getElementById('feeDetails').classList.add('hidden');
                    return;
                }
                
                const student = snapshot.val();
                displayFeeDetails(student, rollNo);
            });
        }
        
        // Display Fee Details
        function displayFeeDetails(student, rollNo) {
            const feeDetails = document.getElementById('feeDetails');
            feeDetails.classList.remove('hidden');
            
            // Student info
            document.getElementById('feeStudentName').textContent = student.name;
            document.getElementById('feeStudentRoll').textContent = rollNo;
            document.getElementById('feeStudentClass').textContent = student.class;
            
            // Fee info
            if(student.fee && student.fee.amount > 0) {
                document.getElementById('feeAmountInput').value = student.fee.amount;
                document.getElementById('feeReason').value = student.fee.reason || '';
                document.getElementById('feePaidCheckbox').checked = student.fee.paid || false;
            } else {
                document.getElementById('feeAmountInput').value = '';
                document.getElementById('feeReason').value = '';
                document.getElementById('feePaidCheckbox').checked = false;
            }
        }
        
        // Assign Fee
        function assignFee() {
            if(!currentStudentRoll) return alert("Search for a student first");
            
            const amount = parseInt(document.getElementById('feeAmountInput').value) || 0;
            const reason = document.getElementById('feeReason').value.trim() || "Fee";
            const paid = document.getElementById('feePaidCheckbox').checked;
            
            if(amount <= 0) return alert("Enter valid fee amount");
            
            const fee = {
                amount,
                reason,
                paid
            };
            
            database.ref(`students/${currentStudentRoll}/fee`).set(fee).then(() => {
                alert("Fee assigned/updated successfully!");
                loadAllFees();
                loadStudentsForMarksWithFees();
            });
        }
        
        // Clear Fee
        function clearFee() {
            if(!currentStudentRoll) return alert("Search for a student first");
            
            if(confirm("Are you sure you want to clear the fee?")) {
                const fee = {amount: 0, reason: "", paid: false};
                database.ref(`students/${currentStudentRoll}/fee`).set(fee).then(() => {
                    alert("Fee cleared!");
                    displayFeeDetails({name: "Loading...", class: ""}, currentStudentRoll);
                    loadAllFees();
                    loadStudentsForMarksWithFees();
                });
            }
        }
        
        // Mark Fee as Paid
        function markFeePaid() {
            if(!currentStudentRoll) return alert("Search for a student first");
            
            database.ref(`students/${currentStudentRoll}/fee`).once('value').then(snapshot => {
                if(snapshot.exists() && snapshot.val().amount > 0) {
                    const fee = snapshot.val();
                    fee.paid = true;
                    database.ref(`students/${currentStudentRoll}/fee`).set(fee).then(() => {
                        alert("Fee marked as paid!");
                        document.getElementById('feePaidCheckbox').checked = true;
                        loadAllFees();
                        loadStudentsForMarksWithFees();
                    });
                } else {
                    alert("No fee assigned to this student");
                }
            });
        }
        
        // Load All Fees
        function loadAllFees() {
            const table = document.getElementById('allFeesTable');
            table.innerHTML = '<tr><td colspan="7" class="text-center">Loading...</td></tr>';
            
            database.ref('students').once('value').then(snapshot => {
                const students = snapshot.val() || {};
                table.innerHTML = '';
                
                let hasFees = false;
                
                Object.keys(students).forEach(rollNo => {
                    const student = students[rollNo];
                    if(student.fee && student.fee.amount > 0) {
                        hasFees = true;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${rollNo}</td>
                            <td>${student.name}</td>
                            <td>${student.class}</td>
                            <td>Rs. ${student.fee.amount}</td>
                            <td>${student.fee.reason || "Not specified"}</td>
                            <td>
                                <span class="${student.fee.paid ? 'status-paid' : 'status-unpaid'}">
                                    ${student.fee.paid ? 'Paid' : 'Unpaid'}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-small btn-primary" onclick="viewStudentFees('${rollNo}')">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button class="btn btn-small btn-success" onclick="quickMarkFeePaid('${rollNo}')">
                                    <i class="fas fa-check"></i> Paid
                                </button>
                            </td>
                        `;
                        table.appendChild(row);
                    }
                });
                
                if(!hasFees) {
                    table.innerHTML = '<tr><td colspan="7" class="text-center">No students with fees found</td></tr>';
                }
            });
        }
        
        // Quick Mark Fee Paid
        function quickMarkFeePaid(rollNo) {
            database.ref(`students/${rollNo}/fee`).once('value').then(snapshot => {
                if(snapshot.exists()) {
                    const fee = snapshot.val();
                    fee.paid = true;
                    database.ref(`students/${rollNo}/fee`).set(fee).then(() => {
                        alert(`Fee for ${rollNo} marked as paid!`);
                        loadAllFees();
                        loadStudentsForMarksWithFees();
                    });
                }
            });
        }
        
        // View Student Fee
        function viewStudentFees(rollNo) {
            document.getElementById('feeSearchRoll').value = rollNo;
            searchFee();
        }
        
        // Confirm Reset All Fees
        function confirmResetAllFees() {
            if(confirm("‚ö†Ô∏è WARNING! This will reset ALL fees for ALL students!\n\nAll fee amounts will be set to 0 and marked as unpaid.\n\nAre you sure?")) {
                if(prompt("Type 'RESET ALL FEES' to confirm:") === "RESET ALL FEES") {
                    resetAllFees();
                }
            }
        }
        
        // Reset All Fees
        function resetAllFees() {
            database.ref('students').once('value').then(snapshot => {
                const students = snapshot.val() || {};
                let updates = {};
                
                Object.keys(students).forEach(rollNo => {
                    updates[`students/${rollNo}/fee`] = {amount: 0, reason: "", paid: false};
                });
                
                database.ref().update(updates).then(() => {
                    alert("All fees reset successfully!");
                    loadAllFees();
                    loadStudentsForMarksWithFees();
                    loadAllResults();
                });
            });
        }
        
        // Load Delete Student Dropdown
        function loadDeleteStudentDropdown() {
            const select = document.getElementById('deleteStudentSelect');
            select.innerHTML = '<option value="">Select student to delete</option>';
            
            database.ref('students').once('value').then(snapshot => {
                const students = snapshot.val() || {};
                Object.keys(students).forEach(rollNo => {
                    const student = students[rollNo];
                    const option = document.createElement('option');
                    option.value = rollNo;
                    option.textContent = `${rollNo} - ${student.name} (${student.class})`;
                    select.appendChild(option);
                });
            });
        }
        
        // Delete Student
        function deleteStudent() {
            const rollNo = document.getElementById('deleteRollNo').value.trim();
            if(!rollNo) return alert("Enter roll number");
            
            if(confirm(`Delete student ${rollNo}?`)) {
                database.ref(`students/${rollNo}`).remove().then(() => {
                    alert(`Student ${rollNo} deleted!`);
                    document.getElementById('deleteRollNo').value = '';
                    loadDeleteStudentDropdown();
                    loadAllResults();
                    loadStudentsForMarksWithFees();
                });
            }
        }
        
        // Delete Selected Student
        function deleteSelectedStudent() {
            const select = document.getElementById('deleteStudentSelect');
            const rollNo = select.value;
            if(!rollNo) return alert("Select a student first");
            
            if(confirm(`Delete student ${rollNo}?`)) {
                database.ref(`students/${rollNo}`).remove().then(() => {
                    alert(`Student ${rollNo} deleted!`);
                    loadDeleteStudentDropdown();
                    loadAllResults();
                    loadStudentsForMarksWithFees();
                });
            }
        }
        
        // Delete All Data Confirmation
        function confirmDeleteAllData() {
            if(confirm("‚ö†Ô∏è DANGER! This will delete EVERYTHING from Firebase!\n\nStudents, subjects, settings - ALL GONE!\n\nAre you absolutely sure?")) {
                if(prompt("Type 'DELETE ALL' to confirm:") === "DELETE ALL") {
                    deleteAllData();
                }
            }
        }
        
        // Delete All Data
        function deleteAllData() {
            database.ref().remove().then(() => {
                alert("ALL data deleted!");
                currentAdminPassword = "admin123";
                database.ref('adminPassword').set(currentAdminPassword);
                document.getElementById('currentPasswordCode').textContent = currentAdminPassword;
                
                subjects = [];
                loadSubjects();
                loadDeleteStudentDropdown();
                loadAllResults();
                loadStudentsForMarksWithFees();
            });
        }
        
        // Change Admin Password
        function changeAdminPassword() {
            const prevPass = document.getElementById('prevPassword').value.trim();
            const newPass = document.getElementById('newPassword').value.trim();
            const confirmPass = document.getElementById('confirmPassword').value.trim();
            
            if(!prevPass || !newPass || !confirmPass) {
                return alert("All fields are required");
            }
            
            if(prevPass !== currentAdminPassword) {
                return alert("Previous password is incorrect");
            }
            
            if(newPass !== confirmPass) {
                return alert("New passwords don't match");
            }
            
            if(newPass.length < 4) {
                return alert("Password must be at least 4 characters");
            }
            
            database.ref('adminPassword').set(newPass).then(() => {
                currentAdminPassword = newPass;
                document.getElementById('currentPasswordCode').textContent = newPass;
                document.getElementById('prevPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                alert("Password changed successfully!");
            });
        }
        
        // ==================== UTILITY FUNCTIONS ====================
        function showLoading(show) {
            if(show) {
                document.getElementById('loadingSpinner').classList.remove('hidden');
                document.getElementById('resultSection').classList.add('hidden');
                document.getElementById('errorMessage').classList.add('hidden');
            } else {
                document.getElementById('loadingSpinner').classList.add('hidden');
            }
        }
        
        function showMessage(message, type) {
            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            
            errorText.textContent = message;
            errorDiv.className = type === 'error' ? 'alert alert-danger' : 'alert alert-success';
            errorDiv.classList.remove('hidden');
            
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }
        
        // Initialize App
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>