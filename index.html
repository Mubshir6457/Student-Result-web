<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faizana Raza Mudrasa Results System</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Tahoma', Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border: 3px solid #667eea;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            color: #4b0082;
            font-size: 2.2rem;
            margin-bottom: 8px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        .header h2 {
            color: #764ba2;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border: 2px solid #667eea;
            flex-wrap: wrap;
            gap: 1px;
        }

        .tab {
            flex: 1;
            padding: 16px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 700;
            color: #4b0082;
            font-size: 1rem;
            min-width: 120px;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            background: linear-gradient(135deg, #f3e8ff 0%, #e0f2fe 100%);
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom: 3px solid #ffd700;
        }

        .content {
            display: none;
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
            margin-bottom: 25px;
            border: 2px solid #667eea;
        }

        .content.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Public Results Page */
        .public-results {
            background: linear-gradient(135deg, #f8f4ff 0%, #f0f9ff 100%);
        }

        .search-box {
            background: white;
            padding: 22px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border: 2px solid #8b5cf6;
        }

        .search-box h3 {
            color: #4b0082;
            margin-bottom: 18px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #4b0082;
            font-weight: 600;
            font-size: 1rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #c4b5fd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8fafc;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .btn:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .btn-excel {
            background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%);
        }

        .btn-info {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        .btn-purple {
            background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .result-card {
            background: white;
            padding: 22px;
            border-radius: 15px;
            border-left: 6px solid #667eea;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            border: 2px solid #e9d5ff;
            position: relative;
            overflow: hidden;
        }

        .result-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
        }

        .result-card h3 {
            color: #4b0082;
            margin-bottom: 12px;
            font-size: 1.25rem;
            padding-bottom: 10px;
            border-bottom: 2px solid #f3f4f6;
        }

        .position-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 2;
            flex-direction: column;
            text-align: center;
        }

        .position-1 {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #8B4513 !important;
        }

        .position-2 {
            background: linear-gradient(135deg, #C0C0C0 0%, #A9A9A9 100%);
        }

        .position-3 {
            background: linear-gradient(135deg, #CD7F32 0%, #8B4513 100%);
        }

        .position-text {
            font-size: 0.7rem;
            margin-top: 2px;
        }

        .grade-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            margin-top: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .grade-a { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .grade-b { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
        .grade-c { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        .grade-d { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; }
        .grade-f { background: linear-gradient(135deg, #64748b 0%, #475569 100%); color: white; }

        /* Add Result Page */
        .add-result-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
        }

        @media (min-width: 1024px) {
            .add-result-container {
                grid-template-columns: 380px 1fr;
            }
        }

        .student-list-panel {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 22px;
            border-radius: 15px;
            border: 2px solid #c4b5fd;
            height: 500px;
            overflow-y: auto;
        }

        .student-list-panel h3 {
            color: #4b0082;
            margin-bottom: 18px;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .student-item {
            background: white;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #e2e8f0;
            position: relative;
        }

        .student-item:hover {
            background: linear-gradient(135deg, #f3e8ff 0%, #e0f2fe 100%);
            transform: translateX(5px);
            border-color: #c4b5fd;
        }

        .student-item.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #4b0082;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .student-item h4 {
            color: inherit;
            margin-bottom: 5px;
            font-size: 1.1rem;
        }

        .student-item .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ef4444;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .student-item:hover .delete-btn {
            display: flex;
        }

        .result-form-panel {
            background: white;
            padding: 22px;
            border-radius: 15px;
            border: 2px solid #c4b5fd;
        }

        .result-form-panel h3 {
            color: #4b0082;
            margin-bottom: 22px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 18px;
            margin-bottom: 18px;
        }

        @media (min-width: 768px) {
            .form-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Subjects Grid */
        .subjects-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 18px;
            margin: 20px 0;
        }

        @media (min-width: 768px) {
            .subjects-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
        }

        .subject-card {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .subject-card:hover {
            border-color: #c4b5fd;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .subject-card h4 {
            color: #4b0082;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1rem;
        }

        .marks-input {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .marks-input label {
            color: #4b0082;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .marks-input input {
            width: 100px;
            text-align: center;
            padding: 10px;
            border: 2px solid #c4b5fd;
            border-radius: 8px;
            background: white;
        }

        /* Attendance Page */
        .attendance-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
        }

        @media (min-width: 1024px) {
            .attendance-container {
                grid-template-columns: 350px 1fr;
            }
        }

        .attendance-controls {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 22px;
            border-radius: 15px;
            border: 2px solid #c4b5fd;
        }

        .attendance-list {
            background: white;
            padding: 22px;
            border-radius: 15px;
            border: 2px solid #c4b5fd;
            max-height: 600px;
            overflow-y: auto;
        }

        .attendance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 18px;
        }

        .attendance-card {
            background: #f8fafc;
            padding: 18px;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .attendance-card.present {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-color: #10b981;
        }

        .attendance-card.absent {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-color: #ef4444;
        }

        .status-toggle {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .status-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .present-btn {
            background: #d1fae5;
            color: #065f46;
        }

        .present-btn:hover, .present-btn.active {
            background: #10b981;
            color: white;
            box-shadow: 0 3px 10px rgba(16, 185, 129, 0.3);
        }

        .absent-btn {
            background: #fee2e2;
            color: #991b1b;
        }

        .absent-btn:hover, .absent-btn.active {
            background: #ef4444;
            color: white;
            box-shadow: 0 3px 10px rgba(239, 68, 68, 0.3);
        }

        /* Admin Management Page */
        .admin-management {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }

        /* Excel Management Page */
        .excel-management {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        }

        .export-section {
            background: white;
            padding: 22px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 2px solid #c4b5fd;
            transition: all 0.3s ease;
        }

        .export-section:hover {
            border-color: #8b5cf6;
            transform: translateY(-2px);
        }

        .export-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 20px;
        }

        /* Message Styling */
        .message {
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 22px;
            text-align: center;
            font-weight: 600;
            font-size: 1rem;
            border: 2px solid;
            animation: slideIn 0.4s ease;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        @keyframes slideIn {
            from { transform: translateY(-15px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .message.success {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            border-color: #10b981;
        }

        .message.error {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            border-color: #ef4444;
        }

        .message.info {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
            border-color: #3b82f6;
        }

        .message.warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
            border-color: #f59e0b;
        }

        /* Position Selection */
        .position-section {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 2px solid #f59e0b;
        }

        .position-section h3 {
            color: #92400e;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .position-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .position-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .position-card.selected {
            border-color: #f59e0b;
            box-shadow: 0 5px 15px rgba(245, 158, 11, 0.3);
        }

        .position-card h4 {
            color: #92400e;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .position-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .position-selector select {
            flex: 1;
            padding: 8px;
            border: 2px solid #c4b5fd;
            border-radius: 8px;
            background: white;
        }

        /* Results Summary Section */
        .results-summary {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 2px solid #3b82f6;
        }

        .results-summary h3 {
            color: #1e40af;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .summary-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            text-align: center;
        }

        .summary-card h4 {
            color: #1e40af;
            margin-bottom: 10px;
        }

        .summary-value {
            font-size: 2rem;
            font-weight: bold;
            color: #3b82f6;
        }

        /* Admin Panel */
        .admin-panel {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 1000;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .admin-btn {
            background: linear-gradient(135deg, #4b0082 0%, #667eea 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
            box-shadow: 0 4px 15px rgba(75, 0, 130, 0.2);
        }

        .admin-btn:hover {
            background: linear-gradient(135deg, #667eea 0%, #4b0082 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(75, 0, 130, 0.3);
        }

        .logout-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .logout-btn:hover {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                border-bottom: 2px solid #e2e8f0;
            }
            
            .content {
                padding: 18px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .header h2 {
                font-size: 1.1rem;
            }
            
            .admin-panel {
                position: static;
                margin-bottom: 15px;
                justify-content: center;
            }
            
            .results-grid,
            .attendance-grid {
                grid-template-columns: 1fr;
            }
            
            .export-buttons {
                grid-template-columns: 1fr;
            }
            
            .student-list-panel,
            .attendance-controls {
                height: auto;
                max-height: 400px;
            }
            
            .position-grid,
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .position-badge {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            
            .position-text {
                font-size: 0.6rem;
            }
            
            .file-input-container {
                flex-direction: column;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            border-left: 5px solid #667eea;
            z-index: 2000;
            animation: slideUp 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 350px;
        }

        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .toast.success {
            border-left-color: #10b981;
        }

        .toast.error {
            border-left-color: #ef4444;
        }

        .toast.info {
            border-left-color: #3b82f6;
        }

        /* Mobile Menu Toggle */
        .menu-toggle {
            display: none;
            background: #667eea;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 15px;
            width: 100%;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .menu-toggle {
                display: block;
            }
            
            .tabs {
                display: none;
            }
            
            .tabs.mobile-open {
                display: flex;
            }
        }

        /* File Input Styling */
        .file-input-container {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .file-input-container input[type="file"] {
            flex: 1;
            padding: 10px;
            border: 2px solid #c4b5fd;
            border-radius: 8px;
            background: white;
        }

        .excel-preview {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #c4b5fd;
            border-radius: 10px;
            padding: 15px;
            background: #f8fafc;
        }

        .excel-preview table {
            width: 100%;
            border-collapse: collapse;
        }

        .excel-preview th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px;
            text-align: left;
            position: sticky;
            top: 0;
        }

        .excel-preview td {
            padding: 8px;
            border-bottom: 1px solid #e2e8f0;
            background: white;
        }

        .excel-preview tr:nth-child(even) td {
            background: #f8fafc;
        }

        /* Class-wise Position Selection */
        .class-position-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .class-position-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .class-position-card:hover {
            border-color: #f59e0b;
            box-shadow: 0 5px 15px rgba(245, 158, 11, 0.1);
        }

        .class-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }

        .class-position-card.separa .class-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .class-position-card.noorani .class-header {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        /* Load Students Button */
        .load-students-btn {
            margin-bottom: 15px;
        }

        /* Excel File Upload Section */
        .excel-upload-section {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #10b981;
        }

        .excel-upload-section h3 {
            color: #065f46;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .fine-summary {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px solid #f59e0b;
        }

        .fine-summary h4 {
            color: #92400e;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .monthly-fine-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .monthly-fine-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #f59e0b;
        }

        .monthly-fine-card h5 {
            color: #92400e;
            margin-bottom: 10px;
        }

        /* Excel Management Page Specific Styles */
        .excel-management-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
        }

        @media (min-width: 1024px) {
            .excel-management-container {
                grid-template-columns: 400px 1fr;
            }
        }

        .excel-file-info {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 3px solid #10b981;
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .excel-file-info h3 {
            color: #065f46;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3rem;
        }

        .file-info-card {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #10b981;
            margin-bottom: 20px;
        }

        .file-info-card h4 {
            color: #065f46;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #bbf7d0;
        }

        .info-label {
            color: #065f46;
            font-weight: 600;
        }

        .info-value {
            color: #3b82f6;
            font-weight: 600;
        }

        .excel-operations {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 3px solid #0ea5e9;
        }

        .excel-operations h3 {
            color: #0369a1;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3rem;
        }

        .operation-section {
            margin-bottom: 25px;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            background: #f8fafc;
        }

        .operation-section h4 {
            color: #4b0082;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .operation-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            text-align: center;
        }

        .stat-card h4 {
            color: #4b0082;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        /* Excel Data Preview */
        .data-preview {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #c4b5fd;
            border-radius: 10px;
            margin-top: 20px;
            background: white;
        }

        .data-preview table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-preview th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            text-align: left;
            position: sticky;
            top: 0;
            font-size: 0.9rem;
        }

        .data-preview td {
            padding: 10px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.85rem;
        }

        .data-preview tr:nth-child(even) {
            background: #f8fafc;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        /* Enhanced Excel Preview */
        .full-data-preview {
            max-height: 600px;
            overflow: auto;
            border: 2px solid #667eea;
            border-radius: 10px;
            background: white;
            margin-top: 20px;
        }

        .full-data-preview table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }

        .full-data-preview th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px;
            text-align: center;
            position: sticky;
            top: 0;
            border-right: 1px solid white;
        }

        .full-data-preview td {
            padding: 6px;
            border: 1px solid #e2e8f0;
            text-align: center;
        }

        .full-data-preview tr:hover td {
            background-color: #f0f9ff;
        }

        .attendance-present {
            background-color: #d1fae5;
            color: #065f46;
            font-weight: bold;
        }

        .attendance-absent {
            background-color: #fee2e2;
            color: #991b1b;
            font-weight: bold;
        }

        .student-result-info {
            background: linear-gradient(135deg, #f3e8ff 0%, #e0f2fe 100%);
            padding: 10px;
            border-radius: 8px;
            margin: 5px 0;
        }

        /* Excel Management Enhanced Features */
        .excel-enhanced-features {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #f59e0b;
        }

        .excel-enhanced-features h3 {
            color: #92400e;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .enhanced-features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .feature-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #f59e0b;
            transition: all 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(245, 158, 11, 0.2);
        }

        .feature-card h4 {
            color: #92400e;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .data-summary-card {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #3b82f6;
            margin-bottom: 15px;
        }

        .data-summary-card h4 {
            color: #1e40af;
            margin-bottom: 10px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #93c5fd;
        }

        .summary-label {
            color: #1e40af;
            font-weight: 600;
        }

        .summary-value {
            color: #3b82f6;
            font-weight: bold;
        }
        
        /* Enhanced Mobile Responsive Design */
        @media (max-width: 768px) {
            /* Excel Management Container */
            .excel-management-container {
                grid-template-columns: 1fr !important;
                gap: 15px;
            }
            
            .excel-file-info {
                position: static !important;
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .excel-operations {
                padding: 15px;
            }
            
            /* Enhanced Excel Features */
            .excel-enhanced-features {
                padding: 15px;
            }
            
            .enhanced-features-grid {
                grid-template-columns: 1fr !important;
                gap: 10px;
            }
            
            .feature-card {
                padding: 12px;
                margin-bottom: 10px;
            }
            
            /* Excel File Info Panel - Mobile Optimized */
            .file-info-card {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px;
            }
            
            .stat-card {
                padding: 12px;
            }
            
            .stat-value {
                font-size: 1.5rem;
            }
            
            /* Operation Sections */
            .operation-section {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .operation-buttons {
                grid-template-columns: 1fr !important;
            }
            
            /* Preview Header */
            .preview-header {
                flex-direction: column;
                gap: 10px;
            }
            
            .preview-header h4 {
                text-align: center;
                margin-bottom: 10px;
            }
            
            /* Data Preview Table */
            .data-preview {
                max-height: 300px;
                font-size: 0.8rem;
            }
            
            .data-preview th,
            .data-preview td {
                padding: 8px 6px;
                font-size: 0.75rem;
            }
            
            /* Full Data Preview Modal */
            #enhancedPreviewModal > div {
                width: 95% !important;
                padding: 15px !important;
                max-height: 85vh !important;
            }
            
            .full-data-preview {
                font-size: 0.7rem;
            }
            
            .full-data-preview th,
            .full-data-preview td {
                padding: 4px !important;
                font-size: 0.7rem;
            }
            
            /* Enhanced Preview Title */
            #previewTitle {
                font-size: 1.2rem;
                flex-direction: column;
                text-align: center;
                gap: 5px;
            }
            
            /* Data Summary Card */
            .data-summary-card {
                padding: 12px;
            }
            
            .summary-row {
                flex-direction: column;
                gap: 5px;
                text-align: center;
            }
            
            /* Excel Upload Section */
            .excel-upload-section {
                padding: 15px;
            }
            
            .file-input-container {
                flex-direction: column;
                gap: 10px;
            }
            
            /* Quick Actions */
            .excel-file-info .btn {
                margin-bottom: 8px;
                width: 100%;
            }
            
            /* Fine Management */
            .form-group input[type="number"] {
                font-size: 16px;
            }
            
            /* Backup & Restore */
            .operation-buttons {
                gap: 8px;
            }
            
            .operation-buttons .btn {
                font-size: 0.9rem;
                padding: 10px;
            }
        }
        
        /* Small Mobile Devices */
        @media (max-width: 480px) {
            /* Excel File Status */
            .excel-file-info h3 {
                font-size: 1.2rem;
            }
            
            .file-info-card h4 {
                font-size: 1rem;
            }
            
            .info-item {
                flex-direction: column;
                gap: 5px;
            }
            
            /* Statistics */
            .stats-grid {
                grid-template-columns: 1fr !important;
            }
            
            .stat-card {
                padding: 10px;
            }
            
            .stat-value {
                font-size: 1.3rem;
            }
            
            /* Enhanced Features Cards */
            .feature-card h4 {
                font-size: 0.95rem;
            }
            
            .feature-card .btn {
                font-size: 0.85rem;
                padding: 8px;
            }
            
            /* Excel Operations */
            .excel-operations h3 {
                font-size: 1.2rem;
                text-align: center;
            }
            
            /* Preview Tables */
            .data-preview {
                font-size: 0.7rem;
            }
            
            .data-preview table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .full-data-preview table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            /* Enhanced Preview Modal */
            #enhancedPreviewModal > div {
                padding: 12px !important;
            }
            
            .enhanced-preview-content {
                font-size: 0.75rem;
            }
        }
        
        /* Tablet Devices */
        @media (min-width: 769px) and (max-width: 1024px) {
            .excel-management-container {
                grid-template-columns: 350px 1fr;
                gap: 20px;
            }
            
            .excel-file-info {
                position: sticky;
                top: 10px;
                height: fit-content;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .enhanced-features-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .operation-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Touch Device Optimizations */
        @media (hover: none) and (pointer: coarse) {
            /* Make buttons easier to tap */
            .btn, .tab, .student-item, .status-btn {
                min-height: 44px;
                min-width: 44px;
            }
            
            /* Increase touch target size */
            input[type="file"] {
                min-height: 44px;
            }
            
            /* Improve dropdown usability */
            select {
                font-size: 16px;
                padding: 12px;
            }
            
            /* Scrollable tables with better touch */
            .data-preview, .full-data-preview {
                -webkit-overflow-scrolling: touch;
                overflow-scrolling: touch;
            }
            
            /* Better touch feedback */
            .btn:active, .tab:active, .student-item:active {
                opacity: 0.7;
                transform: scale(0.98);
            }
        }
        
        /* Landscape Mode Optimizations */
        @media (max-height: 600px) and (orientation: landscape) {
            .excel-file-info {
                max-height: 80vh;
                overflow-y: auto;
            }
            
            .excel-operations {
                max-height: 80vh;
                overflow-y: auto;
            }
            
            .data-preview {
                max-height: 200px;
            }
        }
        
        /* High DPI Screens */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .btn, .tab, .student-item {
                border-width: 1px;
            }
            
            .excel-file-info, .excel-operations {
                border-width: 2px;
            }
        }
        
        /* Print Styles */
        @media print {
            .excel-management, .excel-file-info, .excel-operations {
                background: white !important;
                border: 1px solid #000 !important;
            }
            
            .btn, .menu-toggle, .admin-panel {
                display: none !important;
            }
        }
        
        /* Loading States for Mobile */
        .mobile-loading {
            display: none;
        }
        
        @media (max-width: 768px) {
            .mobile-loading {
                display: block;
                text-align: center;
                padding: 20px;
                color: #666;
            }
            
            /* Excel Loading States */
            .excel-file-info.loading {
                opacity: 0.7;
                pointer-events: none;
            }
            
            .excel-operations.loading {
                opacity: 0.7;
                pointer-events: none;
            }
        }
        
        /* Mobile-optimized modal for Excel preview */
        @media (max-width: 768px) {
            #enhancedPreviewModal {
                padding: 10px;
            }
            
            #enhancedPreviewModal > div {
                width: 100% !important;
                max-height: 90vh !important;
                border-radius: 15px;
            }
            
            #enhancedPreviewContent {
                max-height: 60vh;
                overflow: auto;
            }
            
            /* Close button positioning */
            #enhancedPreviewModal > div > div:first-child {
                position: sticky;
                top: 0;
                background: white;
                padding: 10px 0;
                z-index: 10;
            }
            
            #enhancedPreviewModal button[onclick="closeEnhancedPreview()"] {
                position: absolute;
                top: 10px;
                right: 10px;
                z-index: 11;
            }
        }
        
        /* Better scrollbars for mobile */
        @media (max-width: 768px) {
            ::-webkit-scrollbar {
                width: 6px;
                height: 6px;
            }
            
            ::-webkit-scrollbar-thumb {
                background: rgba(102, 126, 234, 0.7);
            }
            
            .excel-file-info::-webkit-scrollbar,
            .excel-operations::-webkit-scrollbar {
                width: 4px;
            }
        }
        
        /* Excel File Info Mobile Layout */
        @media (max-width: 480px) {
            .excel-file-info h3 {
                text-align: center;
            }
            
            .file-info-card {
                text-align: center;
            }
            
            .info-item {
                justify-content: center;
                text-align: center;
            }
            
            .stats-grid {
                text-align: center;
            }
            
            .excel-operations h3 {
                text-align: center;
            }
            
            .operation-section h4 {
                text-align: center;
            }
        }
        
        /* Enhanced Data Tables for Mobile */
        @media (max-width: 768px) {
            .full-data-preview {
                font-size: 0.6rem;
            }
            
            .full-data-preview th {
                padding: 6px 3px;
                font-size: 0.65rem;
            }
            
            .full-data-preview td {
                padding: 4px 2px;
                font-size: 0.65rem;
            }
            
            .attendance-present,
            .attendance-absent {
                font-size: 0.6rem;
                padding: 2px 4px;
            }
        }
        
        /* Excel Management Specific Improvements */
        @media (max-width: 768px) {
            /* Better button spacing */
            .excel-file-info .btn {
                margin-bottom: 10px;
            }
            
            /* Operation sections spacing */
            .operation-section:not(:last-child) {
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 2px solid #e2e8f0;
            }
            
            /* File input improvements */
            input[type="file"] {
                padding: 12px;
                font-size: 14px;
            }
            
            /* Better form controls */
            .form-group input,
            .form-group select {
                font-size: 16px;
                padding: 12px;
            }
            
            /* Improved data preview */
            .data-preview {
                border-radius: 8px;
                border-width: 1px;
            }
        }
        
        /* Excel Quick Actions Mobile Layout */
        @media (max-width: 480px) {
            .excel-file-info > div:last-child {
                display: grid;
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .excel-file-info .btn {
                width: 100%;
                margin-bottom: 8px;
            }
        }
        
        /* Add smooth transitions for mobile */
        @media (max-width: 768px) {
            .excel-management-container,
            .excel-file-info,
            .excel-operations,
            .operation-section,
            .feature-card,
            .file-info-card {
                transition: all 0.3s ease;
            }
        }
        
        /* Mobile-first adjustments for very small screens */
        @media (max-width: 360px) {
            .excel-management-container {
                gap: 10px;
            }
            
            .excel-file-info,
            .excel-operations {
                padding: 12px;
            }
            
            .feature-card {
                padding: 10px;
            }
            
            .feature-card .btn {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            
            .stat-value {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Public Results Page (Default) -->
        <div class="header">
            <h1> Faizana Raza Mudrasa</h1>
            <h2>Islamic Education Management System</h2>
        </div>

        <!-- Mobile Menu Toggle -->
        <button class="menu-toggle" onclick="toggleMobileMenu()"> Menu</button>

        <!-- Admin Panel -->
        <div class="admin-panel">
            <a href="#" class="admin-btn" onclick="showAdminLogin()"> Admin Login</a>
            <a href="#" class="admin-btn logout-btn" onclick="logout()" style="display: none;" id="logoutBtn"> Logout</a>
        </div>

        <!-- Tabs Navigation -->
        <div class="tabs" id="mobileTabs">
            <div class="tab active" onclick="showTab('publicResults')"> Check Results</div>
            <div class="tab" onclick="showTab('addResult')" id="adminTab1" style="display: none;"> Add Result</div>
            <div class="tab" onclick="showTab('addStudent')" id="adminTab2" style="display: none;"> Add Student</div>
            <div class="tab" onclick="showTab('attendance')" id="adminTab3" style="display: none;"> Attendance</div>
            <div class="tab" onclick="showTab('excelManagement')" id="adminTab5" style="display: none;"> Excel Management</div>
            <div class="tab" onclick="showTab('adminManagement')" id="adminTab4" style="display: none;"> Admin Panel</div>
        </div>

        <!-- Message Container -->
        <div id="messageContainer"></div>

        <!-- Public Results Tab -->
        <div id="publicResults" class="content active public-results">
            <!-- Individual Search -->
            <div class="search-box">
                <h3> Check Individual Student Result</h3>
                <div class="form-group">
                    <label>Enter Student Roll Number:</label>
                    <input type="text" id="searchQuery" placeholder="e.g., 101, 102, etc.">
                </div>
                <button class="btn" onclick="searchResults()">Check Result</button>
            </div>

            <!-- Individual Results Display -->
            <div id="searchResults" class="results-grid"></div>
        </div>

        <!-- Add Result Tab -->
        <div id="addResult" class="content">
            <div class="add-result-container">
                <!-- Student List Panel -->
                <div class="student-list-panel">
                    <h3> Select Student</h3>
                    <input type="text" id="studentSearch" placeholder="Search by roll number or name..." 
                           onkeyup="filterStudents()" class="form-group" style="margin-bottom: 20px;">
                    <div id="studentList"></div>
                </div>

                <!-- Result Form Panel -->
                <div class="result-form-panel">
                    <h3> Add Result for <span id="selectedStudentName">[Select Student]</span></h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Roll Number</label>
                            <input type="text" id="resultStudentRoll" readonly>
                        </div>
                        <div class="form-group">
                            <label>Student Name</label>
                            <input type="text" id="resultStudentName" readonly>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Exam Month</label>
                        <select id="examMonth">
                            <option value="January">January</option>
                            <option value="February">February</option>
                            <option value="March">March</option>
                            <option value="April">April</option>
                            <option value="May">May</option>
                            <option value="June">June</option>
                            <option value="July">July</option>
                            <option value="August">August</option>
                            <option value="September">September</option>
                            <option value="October">October</option>
                            <option value="November">November</option>
                            <option value="December">December</option>
                        </select>
                    </div>
                    
                    <h4 style="color: #4b0082; margin: 20px 0 15px 0; display: flex; align-items: center; gap: 10px;"> Subjects Marks</h4>
                    
                    <div class="subjects-grid">
                        <!-- Nazra -->
                        <div class="subject-card">
                            <h4>Nazra <span style="color: #666; font-size: 0.9em;">(Total: <span id="nazraTotalDisplay">100</span>)</span></h4>
                            <div class="marks-input">
                                <label>Obtained Marks:</label>
                                <input type="number" id="nazraMarks" min="0" max="100" placeholder="0-100">
                            </div>
                            <div class="marks-input">
                                <label>Total Marks:</label>
                                <input type="number" id="nazraTotal" value="100" min="1" max="200" onchange="updateSubjectTotal('nazra')">
                            </div>
                        </div>
                        
                        <!-- Kalma -->
                        <div class="subject-card">
                            <h4>Kalma <span style="color: #666; font-size: 0.9em;">(Total: <span id="kalmaTotalDisplay">100</span>)</span></h4>
                            <div class="marks-input">
                                <label>Obtained Marks:</label>
                                <input type="number" id="kalmaMarks" min="0" max="100" placeholder="0-100">
                            </div>
                            <div class="marks-input">
                                <label>Total Marks:</label>
                                <input type="number" id="kalmaTotal" value="100" min="1" max="200" onchange="updateSubjectTotal('kalma')">
                            </div>
                        </div>
                        
                        <!-- Namaz -->
                        <div class="subject-card">
                            <h4>Namaz <span style="color: #666; font-size: 0.9em;">(Total: <span id="namazTotalDisplay">100</span>)</span></h4>
                            <div class="marks-input">
                                <label>Obtained Marks:</label>
                                <input type="number" id="namazMarks" min="0" max="100" placeholder="0-100">
                            </div>
                            <div class="marks-input">
                                <label>Total Marks:</label>
                                <input type="number" id="namazTotal" value="100" min="1" max="200" onchange="updateSubjectTotal('namaz')">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row" style="margin-top: 20px;">
                        <div class="form-group">
                            <label>Total Obtained</label>
                            <input type="text" id="totalObtained" readonly>
                        </div>
                        <div class="form-group">
                            <label>Overall Total</label>
                            <input type="text" id="overallTotal" readonly>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Percentage</label>
                            <input type="text" id="percentage" readonly>
                        </div>
                        <div class="form-group">
                            <label>Grade</label>
                            <select id="grade">
                                <option value="A+">A+ (90-100%)</option>
                                <option value="A">A (80-89%)</option>
                                <option value="B">B (70-79%)</option>
                                <option value="C">C (60-69%)</option>
                                <option value="D">D (50-59%)</option>
                                <option value="F">F (Below 50%)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Fine Information in Add Result -->
                    <div id="fineInfoInAdd" style="display: none; margin: 20px 0; padding: 15px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 10px; border: 2px solid #f59e0b;">
                        <h4 style="color: #92400e; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;"> Fine Information</h4>
                        <p style="color: #92400e; margin: 5px 0;">Absent Days: <span id="absentDaysCount">0</span></p>
                        <p style="color: #92400e; margin: 5px 0;">Fine Amount: <span id="fineAmount">0</span></p>
                    </div>

                    <button class="btn btn-success" onclick="addResult()" style="width: 100%; padding: 16px; font-size: 18px;">
                         Save Result
                    </button>
                </div>
            </div>
        </div>

        <!-- Add Student Tab -->
        <div id="addStudent" class="content">
            <div class="add-student-container">
                <h3 style="color: #4b0082; margin-bottom: 30px; text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px;"> Register New Student</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Roll Number (Assigned by Admin)</label>
                        <input type="text" id="studentRoll" placeholder="e.g., 101, 102, etc.">
                    </div>
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="studentName" placeholder="Enter full name">
                    </div>
                </div>

                <div class="form-group">
                    <label>Class</label>
                    <select id="studentClass">
                        <option value="Noorani Qayda">Noorani Qayda</option>
                        <option value="Separa">Separa</option>
                    </select>
                </div>
                
                <button class="btn btn-purple" onclick="addStudent()" style="width: 100%; padding: 16px; font-size: 18px;">
                     Register Student
                </button>

                <!-- Students List -->
                <div style="margin-top: 40px;">
                    <h3 style="color: #4b0082; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;"> Registered Students</h3>
                    <div id="allStudentsList"></div>
                </div>
            </div>
        </div>

        <!-- Attendance Tab -->
        <div id="attendance" class="content">
            <div class="attendance-container">
                <div class="attendance-controls">
                    <h3> Attendance Controls</h3>
                    <div class="form-group">
                        <label>Select Date</label>
                        <input type="date" id="attendanceDate" value="<?php echo date('Y-m-d'); ?>">
                    </div>
                    <div class="form-group">
                        <label>Select Class</label>
                        <select id="attendanceClass">
                            <option value="all">All Classes</option>
                            <option value="Noorani Qayda">Noorani Qayda</option>
                            <option value="Separa">Separa</option>
                        </select>
                    </div>
                    
                    <button class="btn load-students-btn" onclick="loadAttendanceStudents()" style="width: 100%; margin-bottom: 15px;">
                         Load Students
                    </button>
                    
                    <button class="btn btn-success" onclick="markAllPresent()" style="width: 100%; margin-bottom: 10px;">
                         Mark All Present
                    </button>
                    <button class="btn btn-warning" onclick="markAllAbsent()" style="width: 100%; margin-bottom: 10px;">
                         Mark All Absent
                    </button>
                    <button class="btn" onclick="saveAttendanceToExcel()" style="width: 100%;">
                         Save to Excel File
                    </button>
                    
                    <!-- Fine Summary -->
                    <div class="fine-summary" id="fineSummary" style="display: none;">
                        <h4> Fine Summary (This Month)</h4>
                        <p>Total Absent Days: <span id="totalAbsentDays" style="color: #ef4444; font-weight: bold;">0</span></p>
                        <p>Total Fine Amount: <span id="totalFineAmount" style="color: #92400e; font-weight: bold;">0</span></p>
                        <div id="monthlyFineDetails" class="monthly-fine-grid"></div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 18px; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 10px; border: 2px solid #e2e8f0;">
                        <p style="color: #4b0082; font-weight: 600; margin-bottom: 10px;"> Today's Summary:</p>
                        <p> Present: <span id="presentCount" style="color: #10b981; font-weight: bold;">0</span></p>
                        <p> Absent: <span id="absentCount" style="color: #ef4444; font-weight: bold;">0</span></p>
                        <p> Total: <span id="totalCount" style="color: #667eea; font-weight: bold;">0</span></p>
                    </div>
                </div>

                <div class="attendance-list">
                    <h3> Student Attendance List</h3>
                    <div id="attendanceList" class="attendance-grid"></div>
                </div>
            </div>
        </div>

        <!-- Excel Management Tab -->
        <div id="excelManagement" class="content excel-management">
            <div class="excel-management-container">
                <!-- Excel File Information Panel -->
                <div class="excel-file-info">
                    <h3> Current Excel File Status</h3>
                    
                    <div class="file-info-card">
                        <h4> File Information</h4>
                        <div class="info-item">
                            <span class="info-label">File Name:</span>
                            <span class="info-value" id="currentExcelFileNameInfo">No file uploaded</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Last Updated:</span>
                            <span class="info-value" id="excelLastUpdatedInfo">Never</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">File Size:</span>
                            <span class="info-value" id="excelFileSize">0 KB</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Status:</span>
                            <span class="info-value" id="excelFileStatus" style="color: #ef4444;">Not Loaded</span>
                        </div>
                    </div>

                    <!-- Statistics Card -->
                    <div class="file-info-card">
                        <h4> Attendance Statistics</h4>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="totalStudentsStat">0</div>
                                <div class="stat-label">Total Students</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="totalDaysStat">0</div>
                                <div class="stat-label">Days Tracked</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="totalAbsentStat">0</div>
                                <div class="stat-label">Total Absent</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="totalFineStat">0</div>
                                <div class="stat-label">Total Fine</div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div style="margin-top: 20px;">
                        <h4 style="color: #065f46; margin-bottom: 15px;"> Quick Actions</h4>
                        <button class="btn btn-success" onclick="loadExcelData()" style="width: 100%; margin-bottom: 10px;">
                             Refresh Data
                        </button>
                        <button class="btn btn-info" onclick="downloadCurrentExcel()" style="width: 100%; margin-bottom: 10px;">
                             Download Current File
                        </button>
                        <button class="btn btn-danger" onclick="deleteExcelFile()" style="width: 100%;">
                             Delete Excel File
                        </button>
                    </div>
                </div>

                <!-- Excel Operations Panel -->
                <div class="excel-operations">
                    <!-- Enhanced Excel Features Section -->
                    <div class="excel-enhanced-features">
                        <h3> ENHANCED EXCEL MANAGEMENT</h3>
                        <p style="color: #92400e; margin-bottom: 15px;">
                            View all student data with attendance, fines, and results in one place.
                        </p>
                        <div class="enhanced-features-grid">
                            <div class="feature-card">
                                <h4> ALL STUDENT DATA</h4>
                                <p>View complete data of all students with every date's attendance</p>
                                <button class="btn btn-purple" onclick="showAllStudentDataMobile()" style="width: 100%; margin-top: 10px;">
                                     Show All Data
                                </button>
                            </div>
                            <div class="feature-card">
                                <h4> FINE CALCULATIONS</h4>
                                <p>Automatic fine calculation for each student (10 per absent day)</p>
                                <button class="btn btn-warning" onclick="showFineCalculations()" style="width: 100%; margin-top: 10px;">
                                     Show Fines
                                </button>
                            </div>
                            <div class="feature-card">
                                <h4> DELETE ALL ATTENDANCE</h4>
                                <p>Reset all attendance to present and fines to 0</p>
                                <button class="btn btn-danger" onclick="deleteAllAttendanceData()" style="width: 100%; margin-top: 10px;">
                                     Reset Attendance
                                </button>
                            </div>
                            <div class="feature-card">
                                <h4> STUDENT RESULTS</h4>
                                <p>View student exam results integrated with attendance</p>
                                <button class="btn btn-success" onclick="showStudentResults()" style="width: 100%; margin-top: 10px;">
                                     Show Results
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Upload Section -->
                    <div class="operation-section">
                        <h4> Upload Excel File</h4>
                        <p style="color: #666; margin-bottom: 15px;">
                            Upload your attendance Excel file. New attendance will be added to this file automatically.
                        </p>
                        
                        <div class="file-input-container">
                            <input type="file" id="excelFile" accept=".xlsx, .xls" style="flex: 1;">
                            <button class="btn btn-success" onclick="uploadExcelFileMobile()"> Upload Excel</button>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <button class="btn btn-secondary" onclick="downloadTemplate()" style="width: 100%;">
                                 Download Template
                            </button>
                        </div>
                    </div>

                    <!-- Data Preview Section -->
                    <div class="operation-section">
                        <div class="preview-header">
                            <h4> Data Preview</h4>
                            <button class="btn btn-purple" onclick="toggleDataPreview()" style="padding: 8px 15px; font-size: 0.9rem;">
                                 Toggle Preview
                            </button>
                        </div>
                        <div id="dataPreview" class="data-preview" style="display: none;">
                            <!-- Excel data will be previewed here -->
                        </div>
                    </div>

                    <!-- Advanced Operations -->
                    <div class="operation-section">
                        <h4> Advanced Operations</h4>
                        <div class="operation-buttons">
                            <button class="btn btn-warning" onclick="exportExcelSummary()">
                                 Export Summary
                            </button>
                            <button class="btn btn-info" onclick="cleanExcelData()">
                                 Clean Data
                            </button>
                            <button class="btn btn-danger" onclick="clearAllAttendance()">
                                 Clear All Attendance
                            </button>
                            <button class="btn btn-excel" onclick="generateMonthlyReport()">
                                 Monthly Report
                            </button>
                        </div>
                    </div>

                    <!-- Fine Management -->
                    <div class="operation-section">
                        <h4> Fine Management</h4>
                        <div class="form-group">
                            <label>Fine Rate Per Absent Day ()</label>
                            <input type="number" id="fineRate" value="10" min="1" max="100" style="width: 100%;">
                        </div>
                        <button class="btn btn-warning" onclick="calculateAllFines()" style="width: 100%; margin-bottom: 10px;">
                             Calculate All Fines
                        </button>
                        <button class="btn btn-success" onclick="exportFineReport()" style="width: 100%;">
                             Export Fine Report
                        </button>
                    </div>

                    <!-- Backup & Restore -->
                    <div class="operation-section">
                        <h4> Backup & Restore</h4>
                        <div class="operation-buttons">
                            <button class="btn btn-info" onclick="backupExcelData()">
                                 Backup to Cloud
                            </button>
                            <button class="btn btn-purple" onclick="restoreFromBackup()">
                                 Restore Backup
                            </button>
                            <button class="btn btn-secondary" onclick="createBackupFile()">
                                 Create Backup File
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Management Tab -->
        <div id="adminManagement" class="content admin-management">
            <!-- Class-wise Position Selection Section -->
            <div class="position-section">
                <h3> Select Top 3 Positions for Each Class</h3>
                <p style="color: #92400e; margin-bottom: 15px;">Select the top 3 students for each class. Positions will be displayed on their result cards.</p>
                
                <div class="form-group">
                    <label>Select Exam Month for Positions:</label>
                    <select id="positionMonth" onchange="loadClassPositionCandidates()">
                        <option value="January">January</option>
                        <option value="February">February</option>
                        <option value="March">March</option>
                        <option value="April">April</option>
                        <option value="May">May</option>
                        <option value="June">June</option>
                        <option value="July">July</option>
                        <option value="August">August</option>
                        <option value="September">September</option>
                        <option value="October">October</option>
                        <option value="November">November</option>
                        <option value="December">December</option>
                    </select>
                </div>
                
                <div class="class-position-grid" id="classPositionSelection">
                    <!-- Class-wise position cards will be loaded here -->
                </div>
                
                <button class="btn btn-warning" onclick="saveClassPositions()" style="width: 100%; margin-top: 20px;">
                     Save Positions for All Classes
                </button>
            </div>

            <!-- Export Data Section with Separate Buttons -->
            <div class="export-section">
                <h3> Export Data</h3>
                <p style="color: #666; margin-bottom: 15px;">Export data to Excel for backup and analysis.</p>
                <div class="export-buttons">
                    <button class="btn btn-secondary" onclick="exportStudentsToExcel()">
                         Export Students
                    </button>
                    <button class="btn btn-info" onclick="exportResultsToExcel()">
                         Export Results
                    </button>
                    <button class="btn btn-success" onclick="exportAttendanceToExcel()">
                         Export Attendance
                    </button>
                    <button class="btn btn-purple" onclick="exportPositionsToExcel()">
                         Export Positions
                    </button>
                    <button class="btn btn-excel" onclick="exportAllToExcel()">
                         Export All Data
                    </button>
                </div>
                <p style="margin-top: 15px; color: #666; font-size: 0.9rem;">
                    <strong>Note:</strong> You can export specific data or all data in separate sheets
                </p>
            </div>

            <div class="export-section">
                <h3> Admin Settings</h3>
                <div class="form-group">
                    <label>Change Admin Code</label>
                    <div class="form-row">
                        <div class="form-group">
                            <input type="password" id="newAdminCode" placeholder="New Admin Code (min 4 characters)">
                        </div>
                        <div class="form-group">
                            <input type="password" id="confirmAdminCode" placeholder="Confirm New Code">
                        </div>
                    </div>
                    <button class="btn btn-info" onclick="changeAdminCode()">Change Admin Code</button>
                    <p style="margin-top: 10px; color: #666; font-size: 0.9rem;">
                        Current Admin Code: <strong id="currentAdminCodeDisplay">FRM123</strong>
                    </p>
                </div>
            </div>

            <div class="export-section" style="border-color: #ef4444; background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);">
                <h3 style="color: #ef4444; display: flex; align-items: center; gap: 10px;"> Danger Zone</h3>
                <p style="color: #666; margin-bottom: 15px;">These actions cannot be undone. Please be careful.</p>
                <div class="export-buttons">
                    <button class="btn btn-danger" onclick="deleteAllResults()">
                         Delete All Results
                    </button>
                    <button class="btn btn-danger" onclick="deleteAllStudents()">
                         Delete All Students
                    </button>
                    <button class="btn btn-danger" onclick="deleteAllAttendance()">
                         Delete All Attendance
                    </button>
                    <button class="btn btn-danger" onclick="deleteAllPositions()">
                         Delete All Positions
                    </button>
                    <button class="btn btn-danger" onclick="deleteAllData()">
                         Delete All Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="adminLoginModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center; padding: 20px;">
        <div style="background: white; padding: 35px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; border: 3px solid #667eea; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);">
            <h3 style="color: #4b0082; margin-bottom: 25px; display: flex; align-items: center; justify-content: center; gap: 10px;"> Admin Login</h3>
            <div class="form-group">
                <input type="password" id="adminCode" placeholder="Enter Admin Code" 
                       style="text-align: center; font-size: 18px; letter-spacing: 2px; padding: 15px; border-radius: 10px; border: 2px solid #c4b5fd;">
            </div>
            <button class="btn" onclick="adminLogin()" style="width: 100%; margin-bottom: 15px; padding: 15px;">
                Login
            </button>
            <button onclick="hideAdminLogin()" style="background: none; border: none; color: #666; cursor: pointer; padding: 10px;">
                Cancel
            </button>
        </div>
    </div>

    <!-- Enhanced Data Preview Modal -->
    <div id="enhancedPreviewModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; align-items: center; justify-content: center; padding: 20px; overflow: auto;">
        <div style="background: white; padding: 25px; border-radius: 20px; width: 95%; max-width: 1800px; max-height: 90vh; overflow: auto; border: 3px solid #667eea; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #4b0082; font-size: 1.5rem; display: flex; align-items: center; gap: 10px;" id="previewTitle">
                     Complete Data Preview
                </h3>
                <button onclick="closeEnhancedPreview()" style="background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: bold;">
                     Close
                </button>
            </div>
            <div id="enhancedPreviewContent" style="max-height: 70vh; overflow: auto;">
                <!-- Enhanced preview content will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDp8fdbDJRs17iFgcj1lN1YAmhiWccEkuc",
            authDomain: "result-app-8cdd1.firebaseapp.com",
            databaseURL: "https://result-app-8cdd1-default-rtdb.firebaseio.com",
            projectId: "result-app-8cdd1",
            storageBucket: "result-app-8cdd1.firebasestorage.app",
            messagingSenderId: "1000820695282",
            appId: "1:1000820695282:web:82a4f0ee1e51de2305f06b"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Admin code (can be changed by admin)
        let ADMIN_CODE = "FRM123";

        // Global variables
        let selectedStudentId = null;
        let allStudents = [];
        let attendanceStatus = {};
        let lastAttendanceDate = null;
        let currentExcelFile = null;
        let currentExcelData = null;
        let excelStats = {
            totalStudents: 0,
            totalDays: 0,
            totalAbsent: 0,
            totalFine: 0
        };
        
        // Store positions for each class separately
        let classPositions = {
            "Separa": {1: null, 2: null, 3: null},
            "Noorani Qayda": {1: null, 2: null, 3: null}
        };

        // Initialize on page load
        window.onload = function() {
            checkAdminStatus();
            loadAllStudents();
            updateSubjectTotal('nazra');
            updateSubjectTotal('kalma');
            updateSubjectTotal('namaz');
            setupEventListeners();
            loadClassPositions();
            loadExcelFileFromStorage();
            
            // Initialize mobile features
            if (window.innerWidth <= 768) {
                initMobileExcelManagement();
            }
        };

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('nazraMarks').addEventListener('input', calculateTotal);
            document.getElementById('kalmaMarks').addEventListener('input', calculateTotal);
            document.getElementById('namazMarks').addEventListener('input', calculateTotal);
            document.getElementById('nazraTotal').addEventListener('input', calculateTotal);
            document.getElementById('kalmaTotal').addEventListener('input', calculateTotal);
            document.getElementById('namazTotal').addEventListener('input', calculateTotal);
            document.addEventListener('keydown', handleKeyboardShortcuts);
        }

        // Handle keyboard shortcuts
        function handleKeyboardShortcuts(event) {
            if (event.ctrlKey && event.key === 's') {
                event.preventDefault();
                const activeTab = document.querySelector('.content.active').id;
                if (activeTab === 'addResult') {
                    addResult();
                } else if (activeTab === 'addStudent') {
                    addStudent();
                } else if (activeTab === 'attendance') {
                    saveAttendanceToExcel();
                } else if (activeTab === 'adminManagement') {
                    saveClassPositions();
                }
            }
            if (event.key === 'Escape') {
                hideAdminLogin();
                closeEnhancedPreview();
            }
        }

        // Mobile-specific Excel management functions
        function initMobileExcelManagement() {
            // Add touch events for better mobile experience
            const excelSections = document.querySelectorAll('.excel-file-info, .excel-operations');
            
            excelSections.forEach(section => {
                section.addEventListener('touchstart', function(e) {
                    this.style.transform = 'scale(0.99)';
                });
                
                section.addEventListener('touchend', function(e) {
                    this.style.transform = 'scale(1)';
                });
            });
            
            // Handle file input on mobile
            const excelFileInput = document.getElementById('excelFile');
            if (excelFileInput) {
                excelFileInput.addEventListener('change', function() {
                    if (this.files && this.files[0]) {
                        const fileName = this.files[0].name;
                        showToast(`Selected file: ${fileName}`, 'info');
                    }
                });
            }
            
            // Load Excel data on mobile with better feedback
            document.querySelectorAll('[onclick="loadExcelData()"]').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        showMessage('Loading Excel data...', 'info');
                        setTimeout(() => {
                            loadExcelData();
                        }, 100);
                    }
                });
            });
            
            // Enhanced mobile preview
            document.querySelectorAll('[onclick="showAllStudentDataMobile()"]').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        showMessage('Loading all student data...', 'info');
                    }
                });
            });
            
            // Mobile-optimized excel operations
            setupMobileExcelOperations();
        }

        function setupMobileExcelOperations() {
            // Add swipe functionality for preview sections
            let touchStartX = 0;
            let touchEndX = 0;
            
            const previewDiv = document.getElementById('dataPreview');
            if (previewDiv) {
                previewDiv.addEventListener('touchstart', function(e) {
                    touchStartX = e.changedTouches[0].screenX;
                });
                
                previewDiv.addEventListener('touchend', function(e) {
                    touchEndX = e.changedTouches[0].screenX;
                    handleSwipe();
                });
            }
            
            function handleSwipe() {
                const swipeThreshold = 50;
                const swipeDistance = touchEndX - touchStartX;
                
                if (Math.abs(swipeDistance) > swipeThreshold) {
                    if (swipeDistance > 0) {
                        // Swipe right - show previous operation
                        navigateExcelOperations('prev');
                    } else {
                        // Swipe left - show next operation
                        navigateExcelOperations('next');
                    }
                }
            }
        }

        function navigateExcelOperations(direction) {
            const sections = document.querySelectorAll('.operation-section');
            const currentSection = document.querySelector('.operation-section.active');
            let currentIndex = 0;
            
            sections.forEach((section, index) => {
                if (section === currentSection) {
                    currentIndex = index;
                }
            });
            
            if (direction === 'next') {
                const nextIndex = (currentIndex + 1) % sections.length;
                sections[currentIndex].classList.remove('active');
                sections[nextIndex].classList.add('active');
                sections[nextIndex].scrollIntoView({ behavior: 'smooth' });
            } else {
                const prevIndex = (currentIndex - 1 + sections.length) % sections.length;
                sections[currentIndex].classList.remove('active');
                sections[prevIndex].classList.add('active');
                sections[prevIndex].scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Enhanced mobile data preview
        function showMobileExcelPreview() {
            if (!currentExcelData) {
                showToast('No Excel file loaded!', 'warning');
                return;
            }
            
            const previewDiv = document.getElementById('dataPreview');
            if (window.innerWidth <= 768) {
                previewDiv.style.maxHeight = '300px';
                previewDiv.style.fontSize = '0.8rem';
                previewDiv.style.overflow = 'auto';
                previewDiv.style.webkitOverflowScrolling = 'touch';
            }
            
            showDataPreview();
        }

        // Mobile-optimized file upload
        function uploadExcelFileMobile() {
            const fileInput = document.getElementById('excelFile');
            
            if (window.innerWidth <= 768) {
                // Create a mobile-friendly file picker
                fileInput.click();
                
                fileInput.onchange = function() {
                    if (this.files && this.files[0]) {
                        const file = this.files[0];
                        const fileSize = (file.size / 1024 / 1024).toFixed(2);
                        
                        if (fileSize > 5) {
                            showToast('File is too large! Max 5MB on mobile.', 'error');
                            return;
                        }
                        
                        showMessage('Uploading Excel file...', 'info');
                        uploadExcelFile();
                    }
                };
            } else {
                uploadExcelFile();
            }
        }

        function setupMobileTouchEvents() {
            // Add long press for excel operations
            const excelBtns = document.querySelectorAll('.excel-operations .btn');
            
            excelBtns.forEach(btn => {
                let pressTimer;
                
                btn.addEventListener('touchstart', function(e) {
                    pressTimer = setTimeout(() => {
                        showToast(this.textContent.trim(), 'info');
                    }, 1000);
                });
                
                btn.addEventListener('touchend', function(e) {
                    clearTimeout(pressTimer);
                });
                
                btn.addEventListener('touchmove', function(e) {
                    clearTimeout(pressTimer);
                });
            });
        }

        // Toggle mobile menu
        function toggleMobileMenu() {
            const tabs = document.getElementById('mobileTabs');
            tabs.classList.toggle('mobile-open');
        }

        // Check if admin is logged in
        function checkAdminStatus() {
            const savedCode = localStorage.getItem('mudrasaAdminCode');
            const isLoggedIn = localStorage.getItem('mudrasaAdminLoggedIn');
            
            if (savedCode) {
                ADMIN_CODE = savedCode;
            }
            
            document.getElementById('currentAdminCodeDisplay').textContent = ADMIN_CODE;
            
            if (isLoggedIn === 'true') {
                showAdminTabs();
            }
        }

        // Show admin login modal
        function showAdminLogin() {
            document.getElementById('adminLoginModal').style.display = 'flex';
            document.getElementById('adminCode').focus();
        }

        // Hide admin login modal
        function hideAdminLogin() {
            document.getElementById('adminLoginModal').style.display = 'none';
            document.getElementById('adminCode').value = '';
        }

        // Admin login
        function adminLogin() {
            const enteredCode = document.getElementById('adminCode').value;
            
            if (!enteredCode) {
                showToast('Please enter admin code!', 'error');
                return;
            }
            
            if (enteredCode === ADMIN_CODE) {
                localStorage.setItem('mudrasaAdminLoggedIn', 'true');
                showAdminTabs();
                hideAdminLogin();
                showToast('Admin login successful!', 'success');
            } else {
                showToast('Invalid admin code!', 'error');
            }
        }

        // Show admin tabs
        function showAdminTabs() {
            document.getElementById('adminTab1').style.display = 'flex';
            document.getElementById('adminTab2').style.display = 'flex';
            document.getElementById('adminTab3').style.display = 'flex';
            document.getElementById('adminTab4').style.display = 'flex';
            document.getElementById('adminTab5').style.display = 'flex';
            document.getElementById('logoutBtn').style.display = 'inline-flex';
            document.querySelector('.admin-panel .admin-btn').style.display = 'none';
        }

        // Logout
        function logout() {
            localStorage.removeItem('mudrasaAdminLoggedIn');
            document.getElementById('adminTab1').style.display = 'none';
            document.getElementById('adminTab2').style.display = 'none';
            document.getElementById('adminTab3').style.display = 'none';
            document.getElementById('adminTab4').style.display = 'none';
            document.getElementById('adminTab5').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'none';
            document.querySelector('.admin-panel .admin-btn').style.display = 'inline-flex';
            showTab('publicResults');
            showToast('Logged out successfully!', 'success');
        }

        // Change admin code
        function changeAdminCode() {
            const newCode = document.getElementById('newAdminCode').value;
            const confirmCode = document.getElementById('confirmAdminCode').value;
            
            if (!newCode || !confirmCode) {
                showToast('Please enter both fields!', 'error');
                return;
            }
            
            if (newCode !== confirmCode) {
                showToast('Codes do not match!', 'error');
                return;
            }
            
            if (newCode.length < 4) {
                showToast('Code must be at least 4 characters!', 'error');
                return;
            }
            
            const currentCode = prompt('Please enter current admin code to confirm change:');
            if (currentCode !== ADMIN_CODE) {
                showToast('Current admin code is incorrect!', 'error');
                return;
            }
            
            ADMIN_CODE = newCode;
            localStorage.setItem('mudrasaAdminCode', newCode);
            document.getElementById('currentAdminCodeDisplay').textContent = newCode;
            
            document.getElementById('newAdminCode').value = '';
            document.getElementById('confirmAdminCode').value = '';
            
            showToast('Admin code changed successfully!', 'success');
        }

        // Show tab content
        function showTab(tabName) {
            const tabs = document.getElementById('mobileTabs');
            tabs.classList.remove('mobile-open');
            
            const contentTabs = document.querySelectorAll('.content');
            contentTabs.forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            
            const tabHeaders = document.querySelectorAll('.tab');
            tabHeaders.forEach(header => header.classList.remove('active'));
            event.target.classList.add('active');
            
            if (tabName === 'addResult') {
                loadStudentList();
            } else if (tabName === 'addStudent') {
                loadAllStudentsTable();
            } else if (tabName === 'attendance') {
                document.getElementById('attendanceList').innerHTML = '<div class="message info">Click "Load Students" button to load students for attendance.</div>';
                updateFineSummary();
            } else if (tabName === 'excelManagement') {
                loadExcelData();
            } else if (tabName === 'adminManagement') {
                loadClassPositionCandidates();
            }
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span>${type === 'success' ? '' : type === 'error' ? '' : ''}</span>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideUp 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Show message
        function showMessage(text, type) {
            const messageContainer = document.getElementById('messageContainer');
            messageContainer.innerHTML = `
                <div class="message ${type}">
                    <span>${type === 'success' ? '' : type === 'error' ? '' : type === 'warning' ? '' : ''}</span>
                    <span>${text}</span>
                </div>
            `;
            setTimeout(() => {
                messageContainer.innerHTML = '';
            }, 4000);
        }

        // ==================== ENHANCED EXCEL FEATURES ====================

        // Show ALL student data with every date's attendance
        function showAllStudentData() {
            if (!currentExcelData) {
                showToast('No Excel file loaded!', 'warning');
                return;
            }

            showMessage('Loading complete student data...', 'info');
            
            try {
                const sheet = currentExcelData.Sheets[currentExcelData.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                
                if (jsonData.length === 0) {
                    showToast('No data in Excel file!', 'warning');
                    showMessage('', '');
                    return;
                }

                const headers = jsonData[0];
                const previewContent = document.getElementById('enhancedPreviewContent');
                previewContent.innerHTML = '';
                
                // Set title
                document.getElementById('previewTitle').textContent = ' ALL STUDENT DATA - EVERY DATE ATTENDANCE';
                
                // Create summary card
                const summaryCard = document.createElement('div');
                summaryCard.className = 'data-summary-card';
                summaryCard.innerHTML = `
                    <h4> Data Summary</h4>
                    <div class="summary-row">
                        <span class="summary-label">Total Students:</span>
                        <span class="summary-value">${jsonData.length - 1}</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Total Dates:</span>
                        <span class="summary-value">${headers.filter(h => h && typeof h === 'string' && h.match(/\d{4}-\d{2}-\d{2}/)).length}</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">File Name:</span>
                        <span class="summary-value">${document.getElementById('currentExcelFileNameInfo').textContent}</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Last Updated:</span>
                        <span class="summary-value">${document.getElementById('excelLastUpdatedInfo').textContent}</span>
                    </div>
                `;
                previewContent.appendChild(summaryCard);

                // Create table
                const table = document.createElement('table');
                table.className = 'full-data-preview';
                
                // Create header
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                
                // Add all headers
                headers.forEach((header, index) => {
                    const th = document.createElement('th');
                    th.textContent = header || `Column ${index + 1}`;
                    if (header && typeof header === 'string' && header.match(/\d{4}-\d{2}-\d{2}/)) {
                        th.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
                    } else if (header === 'Total Absent Days' || header === 'Total Fine') {
                        th.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                    }
                    headerRow.appendChild(th);
                });
                
                thead.appendChild(headerRow);
                table.appendChild(thead);
                
                // Create body
                const tbody = document.createElement('tbody');
                
                // Add all rows
                for (let i = 1; i < jsonData.length; i++) {
                    const row = document.createElement('tr');
                    const rowData = jsonData[i];
                    
                    for (let j = 0; j < headers.length; j++) {
                        const td = document.createElement('td');
                        let cellValue = rowData[j] || '';
                        
                        // Format attendance cells
                        if (headers[j] && typeof headers[j] === 'string' && headers[j].match(/\d{4}-\d{2}-\d{2}/)) {
                            if (cellValue === 'P' || cellValue === 'Present' || cellValue === 'present') {
                                td.className = 'attendance-present';
                                td.textContent = 'P';
                            } else if (cellValue === 'A' || cellValue === 'Absent' || cellValue === 'absent') {
                                td.className = 'attendance-absent';
                                td.textContent = 'A';
                            } else {
                                td.textContent = '';
                            }
                        } else if (headers[j] === 'Total Fine') {
                            td.style.color = '#ef4444';
                            td.style.fontWeight = 'bold';
                            td.textContent = cellValue ? '' + cellValue : '0';
                        } else if (headers[j] === 'Total Absent Days') {
                            td.style.color = cellValue > 0 ? '#ef4444' : '#10b981';
                            td.style.fontWeight = 'bold';
                            td.textContent = cellValue || '0';
                        } else {
                            td.textContent = cellValue;
                        }
                        
                        row.appendChild(td);
                    }
                    
                    tbody.appendChild(row);
                }
                
                table.appendChild(tbody);
                previewContent.appendChild(table);
                
                // Show modal
                document.getElementById('enhancedPreviewModal').style.display = 'flex';
                showMessage('', '');
                showToast('Complete student data loaded successfully!', 'success');
                
            } catch (error) {
                showToast('Error loading student data: ' + error.message, 'error');
                showMessage('', '');
            }
        }

        // Mobile-optimized enhanced preview
        function showAllStudentDataMobile() {
            if (window.innerWidth <= 768) {
                document.getElementById('enhancedPreviewModal').style.display = 'flex';
                document.getElementById('enhancedPreviewContent').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div class="spinner"></div>
                        <p style="margin-top: 20px; color: #666;">Loading student data...</p>
                    </div>
                `;
                
                setTimeout(() => {
                    showAllStudentData();
                }, 100);
            } else {
                showAllStudentData();
            }
        }

        // Show fine calculations for each student
        function showFineCalculations() {
            if (!currentExcelData) {
                showToast('No Excel file loaded!', 'warning');
                return;
            }

            showMessage('Loading fine calculations...', 'info');
            
            try {
                const sheet = currentExcelData.Sheets[currentExcelData.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                
                if (jsonData.length === 0) {
                    showToast('No data in Excel file!', 'warning');
                    showMessage('', '');
                    return;
                }

                const headers = jsonData[0];
                const previewContent = document.getElementById('enhancedPreviewContent');
                previewContent.innerHTML = '';
                
                // Set title
                document.getElementById('previewTitle').textContent = ' FINE CALCULATIONS - ALL STUDENTS';
                
                // Calculate total fine
                let totalFine = 0;
                let totalAbsentDays = 0;
                const fineRate = parseInt(document.getElementById('fineRate').value) || 10;
                
                // Create table
                const table = document.createElement('table');
                table.className = 'full-data-preview';
                
                // Create header
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                ['Roll No', 'Name', 'Class', 'Total Absent Days', 'Fine Rate', 'Total Fine'].forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    if (header.includes('Fine')) {
                        th.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
                    }
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                table.appendChild(thead);
                
                // Create body
                const tbody = document.createElement('tbody');
                
                // Calculate for each student
                for (let i = 1; i < jsonData.length; i++) {
                    const rowData = jsonData[i];
                    if (!rowData[0]) continue;
                    
                    // Calculate absent days
                    let absentDays = 0;
                    for (let j = 0; j < headers.length; j++) {
                        if (headers[j] && typeof headers[j] === 'string' && headers[j].match(/\d{4}-\d{2}-\d{2}/)) {
                            const cellValue = rowData[j];
                            if (cellValue === 'A' || cellValue === 'Absent' || cellValue === 'absent') {
                                absentDays++;
                            }
                        }
                    }
                    
                    // Check if fine is already calculated
                    const totalAbsentIndex = headers.indexOf('Total Absent Days');
                    const totalFineIndex = headers.indexOf('Total Fine');
                    
                    let calculatedFine = absentDays * fineRate;
                    totalAbsentDays += absentDays;
                    totalFine += calculatedFine;
                    
                    const row = document.createElement('tr');
                    
                    // Roll No
                    const tdRoll = document.createElement('td');
                    tdRoll.textContent = rowData[0] || '';
                    row.appendChild(tdRoll);
                    
                    // Name
                    const tdName = document.createElement('td');
                    tdName.textContent = rowData[1] || '';
                    row.appendChild(tdName);
                    
                    // Class
                    const tdClass = document.createElement('td');
                    tdClass.textContent = rowData[2] || '';
                    row.appendChild(tdClass);
                    
                    // Total Absent Days
                    const tdAbsent = document.createElement('td');
                    tdAbsent.textContent = absentDays;
                    tdAbsent.style.color = absentDays > 0 ? '#ef4444' : '#10b981';
                    tdAbsent.style.fontWeight = 'bold';
                    row.appendChild(tdAbsent);
                    
                    // Fine Rate
                    const tdRate = document.createElement('td');
                    tdRate.textContent = '' + fineRate + ' per day';
                    row.appendChild(tdRate);
                    
                    // Total Fine
                    const tdFine = document.createElement('td');
                    tdFine.textContent = '' + calculatedFine;
                    tdFine.style.color = calculatedFine > 0 ? '#ef4444' : '#10b981';
                    tdFine.style.fontWeight = 'bold';
                    row.appendChild(tdFine);
                    
                    tbody.appendChild(row);
                }
                
                table.appendChild(tbody);
                previewContent.appendChild(table);
                
                // Add summary
                const summaryCard = document.createElement('div');
                summaryCard.className = 'data-summary-card';
                summaryCard.innerHTML = `
                    <h4> Fine Summary</h4>
                    <div class="summary-row">
                        <span class="summary-label">Total Students:</span>
                        <span class="summary-value">${jsonData.length - 1}</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Total Absent Days:</span>
                        <span class="summary-value" style="color: #ef4444;">${totalAbsentDays}</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Fine Rate:</span>
                        <span class="summary-value">${fineRate} per day</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Total Fine Amount:</span>
                        <span class="summary-value" style="color: #ef4444; font-size: 1.2rem;">${totalFine}</span>
                    </div>
                `;
                previewContent.insertBefore(summaryCard, table);
                
                // Show modal
                document.getElementById('enhancedPreviewModal').style.display = 'flex';
                showMessage('', '');
                showToast('Fine calculations loaded successfully!', 'success');
                
            } catch (error) {
                showToast('Error loading fine calculations: ' + error.message, 'error');
                showMessage('', '');
            }
        }

        // Delete all attendance data (Reset to Present and 0 Fine)
        function deleteAllAttendanceData() {
            if (!currentExcelData) {
                showToast('No Excel file loaded!', 'warning');
                return;
            }

            if (!confirm(' WARNING: This will reset ALL attendance data!\n\nAll students will be marked as PRESENT for all dates.\nAll fines will be set to 0.\n\nThis action cannot be undone.\n\nEnter admin code to confirm:')) {
                return;
            }

            const adminCode = prompt('Enter admin code to confirm:');
            if (adminCode !== ADMIN_CODE) {
                showToast('Invalid admin code! Operation cancelled.', 'error');
                return;
            }

            showMessage('Resetting all attendance data...', 'warning');
            
            try {
                const sheet = currentExcelData.Sheets[currentExcelData.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                
                if (jsonData.length === 0) {
                    showToast('No data to reset!', 'warning');
                    showMessage('', '');
                    return;
                }

                const headers = jsonData[0];
                
                // Reset all attendance and fines
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    
                    // Reset attendance for all dates
                    for (let j = 0; j < headers.length; j++) {
                        if (headers[j] && typeof headers[j] === 'string' && headers[j].match(/\d{4}-\d{2}-\d{2}/)) {
                            row[j] = 'P'; // Mark as Present
                        }
                    }
                    
                    // Reset fine calculations
                    const totalAbsentIndex = headers.indexOf('Total Absent Days');
                    const totalFineIndex = headers.indexOf('Total Fine');
                    
                    if (totalAbsentIndex !== -1) {
                        row[totalAbsentIndex] = 0;
                    }
                    if (totalFineIndex !== -1) {
                        row[totalFineIndex] = 0;
                    }
                }
                
                // Save updated data
                const updatedWorksheet = XLSX.utils.aoa_to_sheet(jsonData);
                currentExcelData.Sheets[currentExcelData.SheetNames[0]] = updatedWorksheet;
                
                const fileName = document.getElementById('currentExcelFileNameInfo').textContent;
                saveExcelFileToStorage(fileName, currentExcelData);
                
                // Download updated file
                XLSX.writeFile(currentExcelData, fileName);
                
                showToast(' ALL attendance data reset successfully! All students marked as PRESENT, all fines set to 0.', 'success');
                showMessage('', '');
                
                // Update statistics
                updateExcelStats();
                
            } catch (error) {
                showToast('Error resetting attendance data: ' + error.message, 'error');
                showMessage('', '');
            }
        }

        // Show student results integrated with attendance
        function showStudentResults() {
            showMessage('Loading student results with attendance...', 'info');
            
            Promise.all([
                database.ref('students').once('value'),
                database.ref('results').once('value'),
                currentExcelData ? Promise.resolve(currentExcelData) : Promise.resolve(null)
            ]).then(([studentsSnap, resultsSnap, excelData]) => {
                const students = studentsSnap.val();
                const results = resultsSnap.val();
                
                if (!students && !results) {
                    showToast('No student or result data found!', 'warning');
                    showMessage('', '');
                    return;
                }

                const previewContent = document.getElementById('enhancedPreviewContent');
                previewContent.innerHTML = '';
                
                // Set title
                document.getElementById('previewTitle').textContent = ' STUDENT RESULTS WITH ATTENDANCE';
                
                // Get attendance data from Excel if available
                let attendanceData = {};
                if (excelData) {
                    try {
                        const sheet = excelData.Sheets[excelData.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(sheet);
                        
                        jsonData.forEach(row => {
                            if (row['Roll No']) {
                                attendanceData[row['Roll No']] = {
                                    totalAbsentDays: row['Total Absent Days'] || 0,
                                    totalFine: row['Total Fine'] || 0
                                };
                            }
                        });
                    } catch (e) {
                        console.error('Error reading attendance data:', e);
                    }
                }
                
                // Group results by student
                const studentResults = {};
                if (results) {
                    Object.values(results).forEach(result => {
                        if (!studentResults[result.studentRoll]) {
                            studentResults[result.studentRoll] = [];
                        }
                        studentResults[result.studentRoll].push(result);
                    });
                }
                
                // Create summary card
                const summaryCard = document.createElement('div');
                summaryCard.className = 'data-summary-card';
                summaryCard.innerHTML = `
                    <h4> Results Summary</h4>
                    <div class="summary-row">
                        <span class="summary-label">Total Students:</span>
                        <span class="summary-value">${students ? Object.keys(students).length : 0}</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Students with Results:</span>
                        <span class="summary-value">${Object.keys(studentResults).length}</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Total Results:</span>
                        <span class="summary-value">${results ? Object.keys(results).length : 0}</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Attendance Data:</span>
                        <span class="summary-value">${excelData ? 'Available' : 'Not Available'}</span>
                    </div>
                `;
                previewContent.appendChild(summaryCard);
                
                // Create container for student cards
                const studentsGrid = document.createElement('div');
                studentsGrid.className = 'results-grid';
                studentsGrid.style.marginTop = '20px';
                
                // Create cards for each student
                Object.values(students || {}).forEach(student => {
                    const studentCard = document.createElement('div');
                    studentCard.className = 'result-card';
                    
                    const studentResultsList = studentResults[student.rollNumber] || [];
                    const attendanceInfo = attendanceData[student.rollNumber] || { totalAbsentDays: 0, totalFine: 0 };
                    
                    let resultsHTML = '';
                    if (studentResultsList.length > 0) {
                        studentResultsList.forEach(result => {
                            resultsHTML += `
                                <div class="student-result-info">
                                    <p><strong>${result.examMonth}</strong></p>
                                    <p>Nazra: ${result.subjects.nazra.obtained}/${result.subjects.nazra.total}</p>
                                    <p>Kalma: ${result.subjects.kalma.obtained}/${result.subjects.kalma.total}</p>
                                    <p>Namaz: ${result.subjects.namaz.obtained}/${result.subjects.namaz.total}</p>
                                    <p>Total: ${result.totalObtained}/${result.overallTotal}</p>
                                    <p>Percentage: ${result.percentage}%</p>
                                    <p>Grade: <span class="grade-badge grade-${result.grade.charAt(0).toLowerCase()}">${result.grade}</span></p>
                                    <p>Fine: ${result.fine || 0}</p>
                                </div>
                            `;
                        });
                    } else {
                        resultsHTML = '<div class="student-result-info"><p>No results yet</p></div>';
                    }
                    
                    studentCard.innerHTML = `
                        <h3>${student.name}</h3>
                        <p><strong>Roll No:</strong> ${student.rollNumber}</p>
                        <p><strong>Class:</strong> ${student.class}</p>
                        
                        <div style="margin: 15px 0; padding: 12px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 8px; border: 1px solid #f59e0b;">
                            <h4 style="color: #92400e; margin-bottom: 8px;"> Attendance & Fine</h4>
                            <p><strong>Absent Days:</strong> ${attendanceInfo.totalAbsentDays}</p>
                            <p><strong>Total Fine:</strong> ${attendanceInfo.totalFine}</p>
                        </div>
                        
                        <div style="margin: 15px 0; padding: 12px; background: linear-gradient(135deg, #f3e8ff 0%, #e0f2fe 100%); border-radius: 8px; border: 1px solid #c4b5fd;">
                            <h4 style="color: #4b0082; margin-bottom: 8px;"> Exam Results (${studentResultsList.length})</h4>
                            ${resultsHTML}
                        </div>
                    `;
                    
                    studentsGrid.appendChild(studentCard);
                });
                
                previewContent.appendChild(studentsGrid);
                
                // Show modal
                document.getElementById('enhancedPreviewModal').style.display = 'flex';
                showMessage('', '');
                showToast('Student results with attendance loaded successfully!', 'success');
                
            }).catch(error => {
                showToast('Error loading student results: ' + error.message, 'error');
                showMessage('', '');
            });
        }

        // Close enhanced preview modal
        function closeEnhancedPreview() {
            document.getElementById('enhancedPreviewModal').style.display = 'none';
            document.getElementById('enhancedPreviewContent').innerHTML = '';
        }

        // Update subject total display
        function updateSubjectTotal(subject) {
            const totalInput = document.getElementById(subject + 'Total');
            const totalDisplay = document.getElementById(subject + 'TotalDisplay');
            const marksInput = document.getElementById(subject + 'Marks');
            
            const total = parseInt(totalInput.value) || 100;
            totalDisplay.textContent = total;
            marksInput.max = total;
            calculateTotal();
        }

        // Calculate total marks and percentage
        function calculateTotal() {
            const nazraMarks = parseFloat(document.getElementById('nazraMarks').value) || 0;
            const nazraTotal = parseFloat(document.getElementById('nazraTotal').value) || 100;
            const kalmaMarks = parseFloat(document.getElementById('kalmaMarks').value) || 0;
            const kalmaTotal = parseFloat(document.getElementById('kalmaTotal').value) || 100;
            const namazMarks = parseFloat(document.getElementById('namazMarks').value) || 0;
            const namazTotal = parseFloat(document.getElementById('namazTotal').value) || 100;
            
            const totalObtained = nazraMarks + kalmaMarks + namazMarks;
            const overallTotal = nazraTotal + kalmaTotal + namazTotal;
            
            document.getElementById('totalObtained').value = totalObtained;
            document.getElementById('overallTotal').value = overallTotal;
            
            if (overallTotal > 0) {
                const percentage = ((totalObtained / overallTotal) * 100).toFixed(2);
                document.getElementById('percentage').value = percentage + '%';
                
                if (percentage >= 90) document.getElementById('grade').value = 'A+';
                else if (percentage >= 80) document.getElementById('grade').value = 'A';
                else if (percentage >= 70) document.getElementById('grade').value = 'B';
                else if (percentage >= 60) document.getElementById('grade').value = 'C';
                else if (percentage >= 50) document.getElementById('grade').value = 'D';
                else document.getElementById('grade').value = 'F';
            }
        }

        // Load all students for result adding
        function loadStudentList() {
            showMessage('Loading students...', 'info');
            
            database.ref('students').once('value', snapshot => {
                const students = snapshot.val();
                const studentList = document.getElementById('studentList');
                studentList.innerHTML = '';
                
                if (!students) {
                    studentList.innerHTML = '<div class="message info">No students found. Please add students first.</div>';
                    showMessage('', '');
                    return;
                }
                
                allStudents = [];
                
                Object.keys(students).forEach(rollNumber => {
                    const student = students[rollNumber];
                    allStudents.push(student);
                    
                    const studentItem = document.createElement('div');
                    studentItem.className = 'student-item';
                    studentItem.innerHTML = `
                        <button class="delete-btn" onclick="deleteStudent('${rollNumber}', event)"></button>
                        <h4>${student.name}</h4>
                        <p><strong>Roll No:</strong> ${student.rollNumber}</p>
                        <p><strong>Class:</strong> ${student.class}</p>
                    `;
                    studentItem.onclick = () => selectStudent(student);
                    studentList.appendChild(studentItem);
                });
                
                showMessage('', '');
            });
        }

        // Delete individual student
        function deleteStudent(rollNumber, event) {
            event.stopPropagation();
            
            if (!confirm(`Are you sure you want to delete student with Roll Number: ${rollNumber}? This will also delete all their results!`)) {
                return;
            }
            
            const adminCode = prompt('Enter admin code to confirm deletion:');
            if (adminCode !== ADMIN_CODE) {
                showToast('Invalid admin code! Deletion cancelled.', 'error');
                return;
            }
            
            database.ref('students/' + rollNumber).remove()
                .then(() => {
                    return database.ref('results').once('value')
                        .then(snapshot => {
                            const updates = {};
                            snapshot.forEach(child => {
                                if (child.val().studentRoll === rollNumber) {
                                    updates[child.key] = null;
                                }
                            });
                            return database.ref('results').update(updates);
                        });
                })
                .then(() => {
                    showToast(`Student ${rollNumber} deleted successfully!`, 'success');
                    loadStudentList();
                    loadAllStudentsTable();
                    loadAllStudents();
                })
                .catch(error => {
                    showToast('Error deleting student: ' + error.message, 'error');
                });
        }

        // Filter students
        function filterStudents() {
            const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
            const studentItems = document.querySelectorAll('.student-item');
            
            studentItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Select student for result adding
        async function selectStudent(student) {
            selectedStudentId = student.rollNumber;
            
            document.querySelectorAll('.student-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.closest('.student-item').classList.add('selected');
            
            document.getElementById('resultStudentRoll').value = student.rollNumber;
            document.getElementById('resultStudentName').value = student.name;
            document.getElementById('selectedStudentName').textContent = student.name;
            
            document.getElementById('nazraMarks').value = '';
            document.getElementById('kalmaMarks').value = '';
            document.getElementById('namazMarks').value = '';
            
            calculateTotal();
            await calculateAndShowFine(student.rollNumber);
            
            showToast(`Selected student: ${student.name}`, 'success');
        }

        // Calculate and show fine information
        async function calculateAndShowFine(studentRoll) {
            const examMonth = document.getElementById('examMonth').value;
            const currentYear = new Date().getFullYear();
            const examDate = new Date(`${examMonth} 1, ${currentYear}`);
            const examMonthNum = examDate.getMonth() + 1;
            
            let absentDays = 0;
            
            if (currentExcelData) {
                const sheet = currentExcelData.Sheets[currentExcelData.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(sheet);
                
                const currentMonth = examMonthNum.toString().padStart(2, '0');
                
                jsonData.forEach(row => {
                    if (row['Roll No'] && row['Roll No'].toString() === studentRoll.toString()) {
                        for (let day = 1; day <= 31; day++) {
                            const dateStr = `${currentYear}-${currentMonth}-${day.toString().padStart(2, '0')}`;
                            if (row[dateStr] && (row[dateStr] === 'A' || row[dateStr] === 'Absent' || row[dateStr] === 'absent')) {
                                absentDays++;
                            }
                        }
                    }
                });
            }
            
            const totalFine = absentDays * 10;
            const fineInfoDiv = document.getElementById('fineInfoInAdd');
            if (absentDays > 0) {
                document.getElementById('absentDaysCount').textContent = absentDays;
                document.getElementById('fineAmount').textContent = totalFine;
                fineInfoDiv.style.display = 'block';
            } else {
                fineInfoDiv.style.display = 'none';
            }
        }

        // Add result with fine calculation
        async function addResult() {
            if (!selectedStudentId) {
                showToast('Please select a student first!', 'error');
                return;
            }
            
            const studentRoll = document.getElementById('resultStudentRoll').value;
            const studentName = document.getElementById('resultStudentName').value;
            const examMonth = document.getElementById('examMonth').value;
            
            const nazraMarks = parseFloat(document.getElementById('nazraMarks').value) || 0;
            const nazraTotal = parseFloat(document.getElementById('nazraTotal').value) || 100;
            const kalmaMarks = parseFloat(document.getElementById('kalmaMarks').value) || 0;
            const kalmaTotal = parseFloat(document.getElementById('kalmaTotal').value) || 100;
            const namazMarks = parseFloat(document.getElementById('namazMarks').value) || 0;
            const namazTotal = parseFloat(document.getElementById('namazTotal').value) || 100;
            
            const grade = document.getElementById('grade').value;
            const percentage = document.getElementById('percentage').value.replace('%', '');
            
            if (nazraMarks > nazraTotal || kalmaMarks > kalmaTotal || namazMarks > namazTotal) {
                showToast('Obtained marks cannot exceed total marks!', 'error');
                return;
            }
            
            if (!nazraMarks && !kalmaMarks && !namazMarks) {
                showToast('Please enter marks for at least one subject!', 'error');
                return;
            }
            
            let totalFine = 0;
            let absentDays = 0;
            const currentYear = new Date().getFullYear();
            const examDate = new Date(`${examMonth} 1, ${currentYear}`);
            const examMonthNum = examDate.getMonth() + 1;
            
            if (currentExcelData) {
                const sheet = currentExcelData.Sheets[currentExcelData.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(sheet);
                
                const currentMonth = examMonthNum.toString().padStart(2, '0');
                
                jsonData.forEach(row => {
                    if (row['Roll No'] && row['Roll No'].toString() === studentRoll.toString()) {
                        for (let day = 1; day <= 31; day++) {
                            const dateStr = `${currentYear}-${currentMonth}-${day.toString().padStart(2, '0')}`;
                            if (row[dateStr] && (row[dateStr] === 'A' || row[dateStr] === 'Absent' || row[dateStr] === 'absent')) {
                                absentDays++;
                            }
                        }
                    }
                });
                
                totalFine = absentDays * 10;
            }
            
            const resultData = {
                studentRoll: studentRoll,
                studentName: studentName,
                examMonth: examMonth,
                subjects: {
                    nazra: { obtained: nazraMarks, total: nazraTotal },
                    kalma: { obtained: kalmaMarks, total: kalmaTotal },
                    namaz: { obtained: namazMarks, total: namazTotal }
                },
                totalObtained: parseFloat(document.getElementById('totalObtained').value),
                overallTotal: parseFloat(document.getElementById('overallTotal').value),
                percentage: parseFloat(percentage),
                grade: grade,
                fine: totalFine,
                absentDays: absentDays,
                date: new Date().toISOString(),
                timestamp: Date.now()
            };
            
            const resultId = `RES-${Date.now()}`;
            
            database.ref('results/' + resultId).set(resultData)
                .then(() => {
                    showToast('Result saved successfully!', 'success');
                    
                    document.getElementById('nazraMarks').value = '';
                    document.getElementById('kalmaMarks').value = '';
                    document.getElementById('namazMarks').value = '';
                    document.getElementById('fineInfoInAdd').style.display = 'none';
                    
                    selectedStudentId = null;
                    document.querySelectorAll('.student-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    document.getElementById('resultStudentRoll').value = '';
                    document.getElementById('resultStudentName').value = '';
                    document.getElementById('selectedStudentName').textContent = '[Select Student]';
                    
                    loadStudentList();
                    
                })
                .catch(error => {
                    showToast('Error saving result: ' + error.message, 'error');
                });
        }

        // Add student
        function addStudent() {
            const rollNumber = document.getElementById('studentRoll').value.trim();
            const name = document.getElementById('studentName').value.trim();
            const studentClass = document.getElementById('studentClass').value;
            
            if (!rollNumber || !name || !studentClass) {
                showToast('Please fill in all required fields!', 'error');
                return;
            }
            
            database.ref('students').once('value', snapshot => {
                const students = snapshot.val();
                let rollExists = false;
                
                if (students) {
                    Object.keys(students).forEach(key => {
                        if (students[key].rollNumber === rollNumber) {
                            rollExists = true;
                        }
                    });
                }
                
                if (rollExists) {
                    showToast('Roll number already exists! Please use a different number.', 'error');
                    return;
                }
                
                const studentData = {
                    rollNumber: rollNumber,
                    name: name,
                    class: studentClass,
                    dateAdded: new Date().toISOString(),
                    status: 'Active'
                };
                
                database.ref('students/' + rollNumber).set(studentData)
                    .then(() => {
                        showToast(`Student ${name} registered successfully with Roll Number: ${rollNumber}`, 'success');
                        
                        document.getElementById('studentRoll').value = '';
                        document.getElementById('studentName').value = '';
                        
                        loadAllStudents();
                        loadStudentList();
                        loadAllStudentsTable();
                    })
                    .catch(error => {
                        showToast('Error adding student: ' + error.message, 'error');
                    });
            });
        }

        // Load all students for table
        function loadAllStudentsTable() {
            showMessage('Loading students list...', 'info');
            
            database.ref('students').once('value', snapshot => {
                const students = snapshot.val();
                const container = document.getElementById('allStudentsList');
                
                if (!students) {
                    container.innerHTML = '<div class="message info">No students registered yet.</div>';
                    showMessage('', '');
                    return;
                }
                
                let html = '<div class="students-table-container" style="overflow-x: auto;">';
                html += '<table class="students-table">';
                html += '<tr><th>Roll Number</th><th>Name</th><th>Class</th><th>Status</th><th>Action</th></tr>';
                
                Object.keys(students).forEach(rollNumber => {
                    const student = students[rollNumber];
                    html += `
                        <tr>
                            <td><strong>${student.rollNumber}</strong></td>
                            <td>${student.name}</td>
                            <td>${student.class}</td>
                            <td><span style="color: #10b981; font-weight: bold;">${student.status || 'Active'}</span></td>
                            <td>
                                <button class="btn-danger" onclick="deleteStudentFromTable('${rollNumber}')" style="padding: 8px 15px; font-size: 0.9rem;">
                                    Delete
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</table></div>';
                container.innerHTML = html;
                showMessage('', '');
            });
        }

        // Delete student from table
        function deleteStudentFromTable(rollNumber) {
            if (!confirm(`Are you sure you want to delete student with Roll Number: ${rollNumber}? This will also delete all their results!`)) {
                return;
            }
            
            const adminCode = prompt('Enter admin code to confirm deletion:');
            if (adminCode !== ADMIN_CODE) {
                showToast('Invalid admin code! Deletion cancelled.', 'error');
                return;
            }
            
            database.ref('students/' + rollNumber).remove()
                .then(() => {
                    return database.ref('results').once('value')
                        .then(snapshot => {
                            const updates = {};
                            snapshot.forEach(child => {
                                if (child.val().studentRoll === rollNumber) {
                                    updates[child.key] = null;
                                }
                            });
                            return database.ref('results').update(updates);
                        });
                })
                .then(() => {
                    showToast(`Student ${rollNumber} deleted successfully!`, 'success');
                    loadAllStudentsTable();
                    loadStudentList();
                    loadAllStudents();
                })
                .catch(error => {
                    showToast('Error deleting student: ' + error.message, 'error');
                });
        }

        // ==================== EXCEL MANAGEMENT FUNCTIONS ====================

        // Load Excel file from local storage
        function loadExcelFileFromStorage() {
            const savedFileInfo = localStorage.getItem('mudrasaExcelFileInfo');
            if (savedFileInfo) {
                try {
                    const fileInfo = JSON.parse(savedFileInfo);
                    document.getElementById('currentExcelFileNameInfo').textContent = fileInfo.name || 'No file uploaded';
                    document.getElementById('excelLastUpdatedInfo').textContent = fileInfo.lastUpdated || 'Never';
                    
                    const fileData = localStorage.getItem('mudrasaExcelFileData');
                    if (fileData) {
                        currentExcelData = JSON.parse(fileData);
                        updateExcelStats();
                    }
                } catch (e) {
                    console.error('Error loading Excel file info:', e);
                }
            }
        }

        // Save Excel file to local storage
        function saveExcelFileToStorage(fileName, fileData) {
            const fileInfo = {
                name: fileName,
                lastUpdated: new Date().toLocaleString(),
                timestamp: Date.now()
            };
            
            localStorage.setItem('mudrasaExcelFileInfo', JSON.stringify(fileInfo));
            localStorage.setItem('mudrasaExcelFileData', JSON.stringify(fileData));
            updateExcelFileInfo(fileInfo, fileData);
        }

        // Update Excel file information in UI
        function updateExcelFileInfo(fileInfo, fileData) {
            document.getElementById('currentExcelFileNameInfo').textContent = fileInfo.name || 'No file uploaded';
            document.getElementById('excelLastUpdatedInfo').textContent = fileInfo.lastUpdated || 'Never';
            
            const fileSize = JSON.stringify(fileData).length;
            const sizeInKB = (fileSize / 1024).toFixed(2);
            document.getElementById('excelFileSize').textContent = sizeInKB + ' KB';
            
            document.getElementById('excelFileStatus').textContent = 'Loaded';
            document.getElementById('excelFileStatus').style.color = '#10b981';
            updateExcelStats();
        }

        // Update Excel statistics
        function updateExcelStats() {
            if (!currentExcelData) {
                resetExcelStats();
                return;
            }
            
            try {
                const sheet = currentExcelData.Sheets[currentExcelData.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                
                if (jsonData.length === 0) {
                    resetExcelStats();
                    return;
                }
                
                const headers = jsonData[0];
                const dateColumns = headers.filter(h => h && typeof h === 'string' && h.match(/\d{4}-\d{2}-\d{2}/));
                
                let totalAbsent = 0;
                let totalFine = 0;
                
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (row && row[0]) {
                        for (let j = 0; j < dateColumns.length; j++) {
                            const cellValue = row[headers.indexOf(dateColumns[j])];
                            if (cellValue === 'A' || cellValue === 'Absent' || cellValue === 'absent') {
                                totalAbsent++;
                            }
                        }
                    }
                }
                
                const fineRate = parseInt(document.getElementById('fineRate').value) || 10;
                totalFine = totalAbsent * fineRate;
                
                excelStats.totalStudents = Math.max(0, jsonData.length - 1);
                excelStats.totalDays = dateColumns.length;
                excelStats.totalAbsent = totalAbsent;
                excelStats.totalFine = totalFine;
                
                document.getElementById('totalStudentsStat').textContent = excelStats.totalStudents;
                document.getElementById('totalDaysStat').textContent = excelStats.totalDays;
                document.getElementById('totalAbsentStat').textContent = excelStats.totalAbsent;
                document.getElementById('totalFineStat').textContent = '' + excelStats.totalFine;
                
            } catch (error) {
                console.error('Error updating Excel stats:', error);
                resetExcelStats();
            }
        }

        // Reset Excel statistics
        function resetExcelStats() {
            excelStats = {
                totalStudents: 0,
                totalDays: 0,
                totalAbsent: 0,
                totalFine: 0
            };
            
            document.getElementById('totalStudentsStat').textContent = '0';
            document.getElementById('totalDaysStat').textContent = '0';
            document.getElementById('totalAbsentStat').textContent = '0';
            document.getElementById('totalFineStat').textContent = '0';
            document.getElementById('excelFileSize').textContent = '0 KB';
            document.getElementById('excelFileStatus').textContent = 'Not Loaded';
            document.getElementById('excelFileStatus').style.color = '#ef4444';
        }

        // Load Excel data for management page
        function loadExcelData() {
            if (!currentExcelData) {
                showToast('No Excel file loaded! Please upload a file first.', 'warning');
                return;
            }
            
            updateExcelStats();
            showMobileExcelPreview();
            showToast('Excel data refreshed successfully!', 'success');
        }

        // Upload Excel file
        function uploadExcelFile() {
            const fileInput = document.getElementById('excelFile');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                showToast('Please select an Excel file first!', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    currentExcelFile = file;
                    currentExcelData = workbook;
                    saveExcelFileToStorage(file.name, workbook);
                    
                    showToast(`Excel file "${file.name}" uploaded successfully!`, 'success');
                    updateFineSummary();
                    showMobileExcelPreview();
                    fileInput.value = '';
                    
                } catch (error) {
                    showToast('Error reading Excel file: ' + error.message, 'error');
                }
            };
            
            reader.onerror = function() {
                showToast('Error reading file!', 'error');
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Delete Excel file from storage
        function deleteExcelFile() {
            if (!currentExcelData) {
                showToast('No Excel file to delete!', 'warning');
                return;
            }
            
            if (!confirm('Are you sure you want to delete the Excel file? This will remove all attendance data from storage.')) {
                return;
            }
            
            const adminCode = prompt('Enter admin code to confirm deletion:');
            if (adminCode !== ADMIN_CODE) {
                showToast('Invalid admin code! Deletion cancelled.', 'error');
                return;
            }
            
            document.getElementById('excelFile').value = '';
            localStorage.removeItem('mudrasaExcelFileInfo');
            localStorage.removeItem('mudrasaExcelFileData');
            
            currentExcelFile = null;
            currentExcelData = null;
            resetExcelStats();
            
            document.getElementById('dataPreview').innerHTML = '';
            document.getElementById('dataPreview').style.display = 'none';
            
            showToast('Excel file deleted successfully!', 'success');
        }

        // Download Excel template
        function downloadTemplate() {
            const workbook = XLSX.utils.book_new();
            const headers = ['Roll No', 'Name', 'Class'];
            
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth() + 1;
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${currentMonth.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                headers.push(dateStr);
            }
            
            headers.push('Total Absent Days', 'Fine Amount (10 per day)', 'Total Fine');
            
            const data = [headers];
            
            const sampleStudents = [
                { rollNo: '101', name: 'Student 1', class: 'Noorani Qayda' },
                { rollNo: '102', name: 'Student 2', class: 'Separa' },
                { rollNo: '103', name: 'Student 3', class: 'Noorani Qayda' }
            ];
            
            sampleStudents.forEach(student => {
                const row = [student.rollNo, student.name, student.class];
                
                for (let day = 1; day <= daysInMonth; day++) {
                    row.push('');
                }
                
                row.push('', '', '');
                data.push(row);
            });
            
            const worksheet = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Attendance');
            
            const fileName = `attendance_template_${currentYear}_${currentMonth.toString().padStart(2, '0')}.xlsx`;
            XLSX.writeFile(workbook, fileName);
            
            showToast('Template downloaded successfully!', 'success');
        }

        // Download current Excel file
        function downloadCurrentExcel() {
            if (!currentExcelData) {
                showToast('No Excel file to download!', 'warning');
                return;
            }
            
            const fileName = document.getElementById('currentExcelFileNameInfo').textContent || 'attendance_data.xlsx';
            XLSX.writeFile(currentExcelData, fileName);
            
            showToast('Excel file downloaded successfully!', 'success');
        }

        // Show data preview
        function showDataPreview() {
            if (!currentExcelData) {
                return;
            }
            
            const previewDiv = document.getElementById('dataPreview');
            previewDiv.innerHTML = '';
            
            try {
                const sheet = currentExcelData.Sheets[currentExcelData.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                
                if (jsonData.length === 0) {
                    previewDiv.innerHTML = '<p style="padding: 20px; text-align: center; color: #666;">No data available</p>';
                    return;
                }
                
                const table = document.createElement('table');
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                
                const maxColumns = Math.min(10, jsonData[0].length);
                
                for (let i = 0; i < maxColumns; i++) {
                    const th = document.createElement('th');
                    th.textContent = jsonData[0][i] || `Column ${i + 1}`;
                    headerRow.appendChild(th);
                }
                
                thead.appendChild(headerRow);
                table.appendChild(thead);
                
                const tbody = document.createElement('tbody');
                const maxRows = Math.min(10, jsonData.length - 1);
                
                for (let i = 1; i <= maxRows; i++) {
                    const row = document.createElement('tr');
                    
                    for (let j = 0; j < maxColumns; j++) {
                        const td = document.createElement('td');
                        td.textContent = jsonData[i][j] || '';
                        row.appendChild(td);
                    }
                    
                    tbody.appendChild(row);
                }
                
                table.appendChild(tbody);
                previewDiv.appendChild(table);
                
                const totalRows = jsonData.length - 1;
                const totalColumns = jsonData[0].length;
                const infoDiv = document.createElement('div');
                infoDiv.style.padding = '10px';
                infoDiv.style.backgroundColor = '#f8fafc';
                infoDiv.style.borderTop = '1px solid #e2e8f0';
                infoDiv.style.fontSize = '0.9rem';
                infoDiv.style.color = '#666';
                infoDiv.innerHTML = `
                    Showing ${maxRows} of ${totalRows} rows and ${maxColumns} of ${totalColumns} columns.
                    ${totalRows > maxRows ? 'Scroll to see more data.' : ''}
                `;
                previewDiv.appendChild(infoDiv);
                
                previewDiv.style.display = 'block';
                
            } catch (error) {
                previewDiv.innerHTML = '<p style="padding: 20px; text-align: center; color: #ef4444;">Error loading data preview</p>';
                console.error('Error showing data preview:', error);
            }
        }

        // Toggle data preview
        function toggleDataPreview() {
            const previewDiv = document.getElementById('dataPreview');
            if (previewDiv.style.display === 'none' || previewDiv.style.display === '') {
                showMobileExcelPreview();
            } else {
                previewDiv.style.display = 'none';
            }
        }

        // Calculate all fines
        function calculateAllFines() {
            if (!currentExcelData) {
                showToast('No Excel file loaded!', 'warning');
                return;
            }
            
            const fineRate = parseInt(document.getElementById('fineRate').value) || 10;
            
            try {
                const sheet = currentExcelData.Sheets[currentExcelData.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                
                if (jsonData.length === 0) {
                    showToast('No data in Excel file!', 'warning');
                    return;
                }
                
                const headers = jsonData[0];
                const dateColumns = headers.filter(h => h && typeof h === 'string' && h.match(/\d{4}-\d{2}-\d{2}/));
                const totalAbsentIndex = headers.indexOf('Total Absent Days');
                const totalFineIndex = headers.indexOf('Total Fine');
                
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (row && row[0]) {
                        let absentDays = 0;
                        
                        for (let j = 0; j < dateColumns.length; j++) {
                            const cellValue = row[headers.indexOf(dateColumns[j])];
                            if (cellValue === 'A' || cellValue === 'Absent' || cellValue === 'absent') {
                                absentDays++;
                            }
                        }
                        
                        if (totalAbsentIndex !== -1) {
                            row[totalAbsentIndex] = absentDays;
                        }
                        if (totalFineIndex !== -1) {
                            row[totalFineIndex] = absentDays * fineRate;
                        }
                    }
                }
                
                const updatedWorksheet = XLSX.utils.aoa_to_sheet(jsonData);
                currentExcelData.Sheets[currentExcelData.SheetNames[0]] = updatedWorksheet;
                
                const fileName = document.getElementById('currentExcelFileNameInfo').textContent;
                saveExcelFileToStorage(fileName, currentExcelData);
                updateExcelStats();
                
                showToast(`Fines calculated successfully! Fine rate: ${fineRate} per absent day`, 'success');
                
            } catch (error) {
                showToast('Error calculating fines: ' + error.message, 'error');
            }
        }

        // Export Excel summary
        function exportExcelSummary() {
            if (!currentExcelData) {
                showToast('No Excel file loaded!', 'warning');
                return;
            }
            
            const workbook = XLSX.utils.book_new();
            const today = new Date();
            const fileName = `Excel_Summary_${today.toISOString().split('T')[0]}.xlsx`;
            
            const summaryData = [
                ['Excel File Summary Report'],
                ['Generated on:', today.toLocaleDateString(), today.toLocaleTimeString()],
                [],
                ['File Information', ''],
                ['File Name:', document.getElementById('currentExcelFileNameInfo').textContent],
                ['Last Updated:', document.getElementById('excelLastUpdatedInfo').textContent],
                ['File Size:', document.getElementById('excelFileSize').textContent],
                [],
                ['Statistics', ''],
                ['Total Students:', excelStats.totalStudents],
                ['Total Days Tracked:', excelStats.totalDays],
                ['Total Absent Days:', excelStats.totalAbsent],
                ['Total Fine Amount:', '' + excelStats.totalFine],
                [],
                ['Fine Information', ''],
                ['Fine Rate Per Day:', '' + (document.getElementById('fineRate').value || 10)],
                [],
                ['Data Preview', 'Showing first 10 rows']
            ];
            
            try {
                const sheet = currentExcelData.Sheets[currentExcelData.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                
                const maxColumns = Math.min(10, jsonData[0].length);
                const headers = jsonData[0].slice(0, maxColumns);
                summaryData.push([], ['Headers:']);
                summaryData.push(headers);
                
                const maxRows = Math.min(10, jsonData.length - 1);
                summaryData.push([], [`First ${maxRows} rows:`]);
                
                for (let i = 1; i <= maxRows; i++) {
                    summaryData.push(jsonData[i].slice(0, maxColumns));
                }
                
            } catch (error) {
                summaryData.push([], ['Error loading data preview']);
            }
            
            const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(workbook, summarySheet, "Summary");
            
            XLSX.writeFile(workbook, fileName);
            showToast('Summary exported successfully!', 'success');
        }

        // Clean Excel data
        function cleanExcelData() {
            if (!currentExcelData) {
                showToast('No Excel file loaded!', 'warning');
                return;
            }
            
            if (!confirm('Clean the Excel data? This will remove empty rows and format the data.')) {
                return;
            }
            
            try {
                const sheet = currentExcelData.Sheets[currentExcelData.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                
                const cleanedData = jsonData.filter(row => {
                    return row && row.some(cell => cell !== null && cell !== '' && cell !== undefined);
                });
                
                const cleanedWorksheet = XLSX.utils.aoa_to_sheet(cleanedData);
                currentExcelData.Sheets[currentExcelData.SheetNames[0]] = cleanedWorksheet;
                
                const fileName = document.getElementById('currentExcelFileNameInfo').textContent;
                saveExcelFileToStorage(fileName, currentExcelData);
                
                showToast('Excel data cleaned successfully!', 'success');
                showDataPreview();
                
            } catch (error) {
                showToast('Error cleaning data: ' + error.message, 'error');
            }
        }

        // Clear all attendance
        function clearAllAttendance() {
            if (!currentExcelData) {
                showToast('No Excel file loaded!', 'warning');
                return;
            }
            
            if (!confirm('WARNING: This will clear ALL attendance data! This cannot be undone.\n\nEnter admin code to confirm:')) {
                return;
            }
            
            const adminCode = prompt('Enter admin code to confirm:');
            if (adminCode !== ADMIN_CODE) {
                showToast('Invalid admin code! Operation cancelled.', 'error');
                return;
            }
            
            try {
                const sheet = currentExcelData.Sheets[currentExcelData.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                
                if (jsonData.length === 0) {
                    showToast('No data to clear!', 'warning');
                    return;
                }
                
                const headers = jsonData[0];
                
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    for (let j = 0; j < headers.length; j++) {
                        if (headers[j] && typeof headers[j] === 'string' && headers[j].match(/\d{4}-\d{2}-\d{2}/)) {
                            row[j] = '';
                        }
                    }
                }
                
                const clearedWorksheet = XLSX.utils.aoa_to_sheet(jsonData);
                currentExcelData.Sheets[currentExcelData.SheetNames[0]] = clearedWorksheet;
                
                const fileName = document.getElementById('currentExcelFileNameInfo').textContent;
                saveExcelFileToStorage(fileName, currentExcelData);
                
                showToast('All attendance data cleared successfully!', 'success');
                showDataPreview();
                
            } catch (error) {
                showToast('Error clearing attendance: ' + error.message, 'error');
            }
        }

        // Generate monthly report
        function generateMonthlyReport() {
            if (!currentExcelData) {
                showToast('No Excel file loaded!', 'warning');
                return;
            }
            
            const month = prompt('Enter month (1-12) for report:', new Date().getMonth() + 1);
            if (!month || month < 1 || month > 12) {
                showToast('Invalid month!', 'error');
                return;
            }
            
            try {
                const sheet = currentExcelData.Sheets[currentExcelData.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                
                if (jsonData.length === 0) {
                    showToast('No data in Excel file!', 'warning');
                    return;
                }
                
                const headers = jsonData[0];
                const monthStr = month.toString().padStart(2, '0');
                const currentYear = new Date().getFullYear();
                
                const monthDates = headers.filter(h => 
                    h && typeof h === 'string' && h.startsWith(`${currentYear}-${monthStr}-`)
                );
                
                if (monthDates.length === 0) {
                    showToast('No data for selected month!', 'warning');
                    return;
                }
                
                const reportData = [
                    [`Monthly Attendance Report - ${new Date(currentYear, month - 1, 1).toLocaleString('default', { month: 'long' })} ${currentYear}`],
                    ['Generated on:', new Date().toLocaleDateString()],
                    [],
                    ['Roll No', 'Name', 'Class', 'Present Days', 'Absent Days', 'Total Days', 'Attendance %', 'Fine Amount']
                ];
                
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (row && row[0]) {
                        let presentDays = 0;
                        let absentDays = 0;
                        
                        for (const date of monthDates) {
                            const dateIndex = headers.indexOf(date);
                            const cellValue = row[dateIndex];
                            if (cellValue === 'P' || cellValue === 'Present' || cellValue === 'present') {
                                presentDays++;
                            } else if (cellValue === 'A' || cellValue === 'Absent' || cellValue === 'absent') {
                                absentDays++;
                            }
                        }
                        
                        const totalDays = presentDays + absentDays;
                        const attendancePercent = totalDays > 0 ? ((presentDays / totalDays) * 100).toFixed(2) : 0;
                        const fineRate = parseInt(document.getElementById('fineRate').value) || 10;
                        const fineAmount = absentDays * fineRate;
                        
                        reportData.push([
                            row[0],
                            row[1] || '',
                            row[2] || '',
                            presentDays,
                            absentDays,
                            totalDays,
                            attendancePercent + '%',
                            '' + fineAmount
                        ]);
                    }
                }
                
                const workbook = XLSX.utils.book_new();
                const worksheet = XLSX.utils.aoa_to_sheet(reportData);
                XLSX.utils.book_append_sheet(workbook, worksheet, "Monthly Report");
                
                const fileName = `Monthly_Report_${currentYear}_${monthStr}.xlsx`;
                XLSX.writeFile(workbook, fileName);
                
                showToast('Monthly report generated successfully!', 'success');
                
            } catch (error) {
                showToast('Error generating report: ' + error.message, 'error');
            }
        }

        // Export fine report
        function exportFineReport() {
            if (!currentExcelData) {
                showToast('No Excel file loaded!', 'warning');
                return;
            }
            
            try {
                const sheet = currentExcelData.Sheets[currentExcelData.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                
                if (jsonData.length === 0) {
                    showToast('No data in Excel file!', 'warning');
                    return;
                }
                
                const headers = jsonData[0];
                const totalAbsentIndex = headers.indexOf('Total Absent Days');
                const totalFineIndex = headers.indexOf('Total Fine');
                
                if (totalAbsentIndex === -1 || totalFineIndex === -1) {
                    showToast('Fine columns not found in Excel file!', 'warning');
                    return;
                }
                
                const reportData = [
                    ['Fine Report - All Students'],
                    ['Generated on:', new Date().toLocaleDateString()],
                    ['Fine Rate:', '' + (document.getElementById('fineRate').value || 10) + ' per absent day'],
                    [],
                    ['Roll No', 'Name', 'Class', 'Total Absent Days', 'Total Fine Amount']
                ];
                
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (row && row[0]) {
                        const absentDays = row[totalAbsentIndex] || 0;
                        const fineAmount = row[totalFineIndex] || 0;
                        
                        if (absentDays > 0) {
                            reportData.push([
                                row[0],
                                row[1] || '',
                                row[2] || '',
                                absentDays,
                                '' + fineAmount
                            ]);
                        }
                    }
                }
                
                const workbook = XLSX.utils.book_new();
                const worksheet = XLSX.utils.aoa_to_sheet(reportData);
                XLSX.utils.book_append_sheet(workbook, worksheet, "Fine Report");
                
                const fileName = `Fine_Report_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(workbook, fileName);
                
                showToast('Fine report exported successfully!', 'success');
                
            } catch (error) {
                showToast('Error exporting fine report: ' + error.message, 'error');
            }
        }

        // Backup Excel data to Firebase
        function backupExcelData() {
            if (!currentExcelData) {
                showToast('No Excel file to backup!', 'warning');
                return;
            }
            
            const adminCode = prompt('Enter admin code to backup data:');
            if (adminCode !== ADMIN_CODE) {
                showToast('Invalid admin code! Backup cancelled.', 'error');
                return;
            }
            
            showMessage('Backing up Excel data...', 'info');
            
            const backupData = {
                excelData: JSON.stringify(currentExcelData),
                fileInfo: localStorage.getItem('mudrasaExcelFileInfo'),
                timestamp: Date.now(),
                backedUpBy: 'Admin'
            };
            
            const backupId = `BACKUP-${Date.now()}`;
            
            database.ref('excelBackups/' + backupId).set(backupData)
                .then(() => {
                    showToast('Excel data backed up to cloud successfully!', 'success');
                    showMessage('', '');
                })
                .catch(error => {
                    showToast('Error backing up data: ' + error.message, 'error');
                    showMessage('', '');
                });
        }

        // Restore from backup
        function restoreFromBackup() {
            if (!confirm('Restore Excel data from backup? This will replace current Excel file.')) {
                return;
            }
            
            const adminCode = prompt('Enter admin code to restore backup:');
            if (adminCode !== ADMIN_CODE) {
                showToast('Invalid admin code! Restore cancelled.', 'error');
                return;
            }
            
            showMessage('Loading backups...', 'info');
            
            database.ref('excelBackups').once('value')
                .then(snapshot => {
                    const backups = snapshot.val();
                    if (!backups) {
                        showToast('No backups found!', 'warning');
                        showMessage('', '');
                        return;
                    }
                    
                    let backupList = 'Select backup to restore:\n\n';
                    const backupIds = [];
                    
                    Object.keys(backups).forEach((id, index) => {
                        const backup = backups[id];
                        const date = new Date(backup.timestamp).toLocaleString();
                        backupList += `${index + 1}. Backup from ${date}\n`;
                        backupIds.push(id);
                    });
                    
                    const choice = prompt(backupList + '\nEnter backup number:');
                    const index = parseInt(choice) - 1;
                    
                    if (isNaN(index) || index < 0 || index >= backupIds.length) {
                        showToast('Invalid selection!', 'error');
                        showMessage('', '');
                        return;
                    }
                    
                    const selectedBackup = backups[backupIds[index]];
                    
                    currentExcelData = JSON.parse(selectedBackup.excelData);
                    localStorage.setItem('mudrasaExcelFileInfo', selectedBackup.fileInfo);
                    localStorage.setItem('mudrasaExcelFileData', selectedBackup.excelData);
                    
                    loadExcelFileFromStorage();
                    showDataPreview();
                    
                    showToast('Backup restored successfully!', 'success');
                    showMessage('', '');
                })
                .catch(error => {
                    showToast('Error restoring backup: ' + error.message, 'error');
                    showMessage('', '');
                });
        }

        // Create backup file
        function createBackupFile() {
            if (!currentExcelData) {
                showToast('No Excel file to backup!', 'warning');
                return;
            }
            
            const today = new Date();
            const fileName = `Excel_Backup_${today.toISOString().split('T')[0]}_${today.getTime()}.json`;
            
            const backupData = {
                excelData: currentExcelData,
                fileInfo: JSON.parse(localStorage.getItem('mudrasaExcelFileInfo') || '{}'),
                timestamp: Date.now(),
                system: 'Mudrasa Attendance System'
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = fileName;
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showToast('Backup file created successfully!', 'success');
        }

        // ==================== ATTENDANCE FUNCTIONS ====================

        // Load students for attendance
        function loadAttendanceStudents() {
            const date = document.getElementById('attendanceDate').value;
            const selectedClass = document.getElementById('attendanceClass').value;
            
            if (!date) {
                showToast('Please select a date!', 'error');
                return;
            }
            
            if (!currentExcelData) {
                showToast('Please upload an Excel file first!', 'error');
                return;
            }
            
            showMessage('Loading students for attendance...', 'info');
            
            database.ref('students').once('value', snapshot => {
                const students = snapshot.val();
                const attendanceList = document.getElementById('attendanceList');
                
                if (!students) {
                    attendanceList.innerHTML = '<div class="message info">No students registered yet. Please add students first.</div>';
                    showMessage('', '');
                    return;
                }
                
                const sheet = currentExcelData.Sheets[currentExcelData.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(sheet);
                
                attendanceList.innerHTML = '';
                attendanceStatus = {};
                
                let presentCount = 0;
                let absentCount = 0;
                let totalCount = 0;
                
                Object.keys(students).forEach(rollNumber => {
                    const student = students[rollNumber];
                    
                    if (selectedClass !== 'all' && student.class !== selectedClass) {
                        return;
                    }
                    
                    totalCount++;
                    
                    let isPresent = true;
                    const excelRecord = jsonData.find(row => row['Roll No'] && row['Roll No'].toString() === rollNumber.toString());
                    if (excelRecord && excelRecord[date]) {
                        const status = excelRecord[date];
                        isPresent = !(status === 'A' || status === 'Absent' || status === 'absent');
                    }
                    
                    if (isPresent) presentCount++;
                    else absentCount++;
                    
                    attendanceStatus[rollNumber] = isPresent ? 'present' : 'absent';
                    
                    const attendanceCard = document.createElement('div');
                    attendanceCard.className = `attendance-card ${attendanceStatus[rollNumber]}`;
                    attendanceCard.id = `attendance-${rollNumber}`;
                    attendanceCard.innerHTML = `
                        <h4>${student.name}</h4>
                        <p><strong>Roll No:</strong> ${student.rollNumber}</p>
                        <p><strong>Class:</strong> ${student.class}</p>
                        <div class="status-toggle">
                            <button class="status-btn present-btn ${attendanceStatus[rollNumber] === 'present' ? 'active' : ''}" 
                                    onclick="markAttendance('${rollNumber}', 'present')">
                                 Present
                            </button>
                            <button class="status-btn absent-btn ${attendanceStatus[rollNumber] === 'absent' ? 'active' : ''}" 
                                    onclick="markAttendance('${rollNumber}', 'absent')">
                                 Absent
                            </button>
                        </div>
                    `;
                    attendanceList.appendChild(attendanceCard);
                });
                
                document.getElementById('presentCount').textContent = presentCount;
                document.getElementById('absentCount').textContent = absentCount;
                document.getElementById('totalCount').textContent = totalCount;
                
                showMessage('', '');
                showToast(`Loaded ${totalCount} students for attendance`, 'success');
                updateFineSummary();
            });
        }

        // Mark attendance
        function markAttendance(rollNumber, status) {
            attendanceStatus[rollNumber] = status;
            
            const card = document.getElementById(`attendance-${rollNumber}`);
            if (card) {
                card.className = `attendance-card ${status}`;
                
                const presentBtn = card.querySelector('.present-btn');
                const absentBtn = card.querySelector('.absent-btn');
                
                if (presentBtn) presentBtn.className = `status-btn present-btn ${status === 'present' ? 'active' : ''}`;
                if (absentBtn) absentBtn.className = `status-btn absent-btn ${status === 'absent' ? 'active' : ''}`;
            }
            
            updateAttendanceCounters();
        }

        // Mark all present
        function markAllPresent() {
            if (Object.keys(attendanceStatus).length === 0) {
                showToast('Please load students first!', 'error');
                return;
            }
            
            Object.keys(attendanceStatus).forEach(rollNumber => {
                markAttendance(rollNumber, 'present');
            });
            showToast('All students marked as Present', 'success');
        }

        // Mark all absent
        function markAllAbsent() {
            if (Object.keys(attendanceStatus).length === 0) {
                showToast('Please load students first!', 'error');
                return;
            }
            
            Object.keys(attendanceStatus).forEach(rollNumber => {
                markAttendance(rollNumber, 'absent');
            });
            showToast('All students marked as Absent', 'warning');
        }

        // Update attendance counters
        function updateAttendanceCounters() {
            let presentCount = 0;
            let absentCount = 0;
            
            Object.values(attendanceStatus).forEach(status => {
                if (status === 'present') presentCount++;
                if (status === 'absent') absentCount++;
            });
            
            document.getElementById('presentCount').textContent = presentCount;
            document.getElementById('absentCount').textContent = absentCount;
            document.getElementById('totalCount').textContent = presentCount + absentCount;
        }

        // Update fine summary
        function updateFineSummary() {
            if (!currentExcelData) {
                document.getElementById('fineSummary').style.display = 'none';
                return;
            }
            
            const sheet = currentExcelData.Sheets[currentExcelData.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(sheet);
            
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth() + 1;
            const currentMonthStr = currentMonth.toString().padStart(2, '0');
            
            let totalAbsentDays = 0;
            let totalFineAmount = 0;
            
            const monthlyData = {};
            
            for (let m = 1; m <= 12; m++) {
                monthlyData[m] = {
                    month: new Date(currentYear, m - 1, 1).toLocaleString('default', { month: 'long' }),
                    absentDays: 0,
                    fineAmount: 0
                };
            }
            
            jsonData.forEach(row => {
                if (row['Roll No']) {
                    for (let month = 1; month <= 12; month++) {
                        let monthAbsentDays = 0;
                        const monthStr = month.toString().padStart(2, '0');
                        
                        for (let day = 1; day <= 31; day++) {
                            const dateStr = `${currentYear}-${monthStr}-${day.toString().padStart(2, '0')}`;
                            if (row[dateStr] && (row[dateStr] === 'A' || row[dateStr] === 'Absent' || row[dateStr] === 'absent')) {
                                monthAbsentDays++;
                                totalAbsentDays++;
                            }
                        }
                        
                        monthlyData[month].absentDays += monthAbsentDays;
                        monthlyData[month].fineAmount += monthAbsentDays * 10;
                    }
                }
            });
            
            totalFineAmount = totalAbsentDays * 10;
            
            document.getElementById('totalAbsentDays').textContent = totalAbsentDays;
            document.getElementById('totalFineAmount').textContent = totalFineAmount;
            
            const monthlyContainer = document.getElementById('monthlyFineDetails');
            monthlyContainer.innerHTML = '';
            
            Object.values(monthlyData).forEach(monthData => {
                if (monthData.absentDays > 0) {
                    const card = document.createElement('div');
                    card.className = 'monthly-fine-card';
                    card.innerHTML = `
                        <h5>${monthData.month}</h5>
                        <p>Absent Days: <strong>${monthData.absentDays}</strong></p>
                        <p>Fine Amount: <strong>${monthData.fineAmount}</strong></p>
                    `;
                    monthlyContainer.appendChild(card);
                }
            });
            
            document.getElementById('fineSummary').style.display = 'block';
        }

        // Save attendance to Excel file
        function saveAttendanceToExcel() {
            const date = document.getElementById('attendanceDate').value;
            
            if (!date) {
                showToast('Please select a date!', 'error');
                return;
            }
            
            if (!currentExcelData) {
                showToast('Please upload an Excel file first!', 'error');
                return;
            }
            
            if (Object.keys(attendanceStatus).length === 0) {
                showToast('No attendance data to save! Please load students first.', 'error');
                return;
            }
            
            const sheetName = currentExcelData.SheetNames[0];
            const sheet = currentExcelData.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            
            const headerRow = jsonData[0];
            const dateColumnIndex = headerRow.indexOf(date);
            
            if (dateColumnIndex === -1) {
                headerRow.push(date);
            }
            
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                const rollNumber = row[0] ? row[0].toString() : '';
                
                if (rollNumber && attendanceStatus[rollNumber]) {
                    const status = attendanceStatus[rollNumber] === 'present' ? 'P' : 'A';
                    
                    if (dateColumnIndex === -1) {
                        row.push(status);
                    } else {
                        row[dateColumnIndex] = status;
                    }
                    
                    updateFineCalculations(row, headerRow);
                }
            }
            
            const updatedWorksheet = XLSX.utils.aoa_to_sheet(jsonData);
            currentExcelData.Sheets[sheetName] = updatedWorksheet;
            
            const fileName = document.getElementById('currentExcelFileNameInfo').textContent;
            saveExcelFileToStorage(fileName, currentExcelData);
            
            XLSX.writeFile(currentExcelData, fileName);
            
            showToast(`Attendance saved to ${fileName}`, 'success');
            updateFineSummary();
            updateExcelStats();
        }

        // Update fine calculations in Excel row
        function updateFineCalculations(row, headerRow) {
            const totalAbsentIndex = headerRow.indexOf('Total Absent Days');
            const finePerDayIndex = headerRow.indexOf('Fine Amount (10 per day)');
            const totalFineIndex = headerRow.indexOf('Total Fine');
            
            if (totalAbsentIndex === -1 || finePerDayIndex === -1 || totalFineIndex === -1) {
                if (totalAbsentIndex === -1) {
                    headerRow.push('Total Absent Days');
                    row.push(0);
                }
                if (finePerDayIndex === -1) {
                    headerRow.push('Fine Amount (10 per day)');
                    row.push(10);
                }
                if (totalFineIndex === -1) {
                    headerRow.push('Total Fine');
                    row.push(0);
                }
                
                const newTotalAbsentIndex = headerRow.indexOf('Total Absent Days');
                const newFinePerDayIndex = headerRow.indexOf('Fine Amount (10 per day)');
                const newTotalFineIndex = headerRow.indexOf('Total Fine');
                
                let absentDays = 0;
                for (let i = 3; i < newTotalAbsentIndex; i++) {
                    if (headerRow[i] && row[i] && (row[i] === 'A' || row[i] === 'Absent' || row[i] === 'absent')) {
                        absentDays++;
                    }
                }
                
                row[newTotalAbsentIndex] = absentDays;
                row[newTotalFineIndex] = absentDays * 10;
            } else {
                let absentDays = 0;
                for (let i = 3; i < totalAbsentIndex; i++) {
                    if (headerRow[i] && row[i] && (row[i] === 'A' || row[i] === 'Absent' || row[i] === 'absent')) {
                        absentDays++;
                    }
                }
                
                row[totalAbsentIndex] = absentDays;
                row[totalFineIndex] = absentDays * 10;
            }
        }

        // ==================== REST OF THE FUNCTIONS ====================

        // Load class positions from database
        function loadClassPositions() {
            database.ref('classPositions').once('value', snapshot => {
                const positions = snapshot.val();
                if (positions) {
                    classPositions = positions;
                }
            });
        }

        // Save class positions to database
        function saveClassPositions() {
            const examMonth = document.getElementById('positionMonth').value;
            const positionData = {
                month: examMonth,
                positions: classPositions,
                timestamp: Date.now()
            };
            
            database.ref('classPositions/' + examMonth).set(positionData)
                .then(() => {
                    showToast(`Class positions saved for ${examMonth}!`, 'success');
                })
                .catch(error => {
                    showToast('Error saving positions: ' + error.message, 'error');
                });
        }

        // Load position candidates for each class
        function loadClassPositionCandidates() {
            const examMonth = document.getElementById('positionMonth').value;
            
            database.ref('results').once('value', snapshot => {
                const results = snapshot.val();
                const positionDiv = document.getElementById('classPositionSelection');
                
                if (!results) {
                    positionDiv.innerHTML = '<div class="message info">No results found for position selection.</div>';
                    return;
                }
                
                const monthlyResults = [];
                Object.values(results).forEach(result => {
                    if (result.examMonth === examMonth) {
                        monthlyResults.push(result);
                    }
                });
                
                if (monthlyResults.length === 0) {
                    positionDiv.innerHTML = '<div class="message info">No results found for selected month.</div>';
                    return;
                }
                
                database.ref('classPositions/' + examMonth).once('value', posSnapshot => {
                    const savedPositions = posSnapshot.val();
                    let savedClassPositions = {
                        "Separa": {1: null, 2: null, 3: null},
                        "Noorani Qayda": {1: null, 2: null, 3: null}
                    };
                    
                    if (savedPositions && savedPositions.positions) {
                        savedClassPositions = savedPositions.positions;
                        classPositions = savedClassPositions;
                    }
                    
                    positionDiv.innerHTML = '';
                    
                    const separaResults = monthlyResults.filter(result => {
                        const studentClass = getStudentClass(result.studentRoll);
                        return studentClass === 'Separa';
                    }).sort((a, b) => b.percentage - a.percentage);
                    
                    const separaCard = document.createElement('div');
                    separaCard.className = 'class-position-card separa';
                    separaCard.innerHTML = `
                        <div class="class-header">Separa Class - Top 3 Positions</div>
                        ${[1, 2, 3].map(i => `
                            <div class="position-card">
                                <h4>
                                    <span class="position-badge position-${i}" style="position: static; width: 30px; height: 30px; display: inline-flex; margin-right: 10px;">
                                        ${i}
                                    </span>
                                    ${i === 1 ? ' First Position' : i === 2 ? ' Second Position' : ' Third Position'}
                                </h4>
                                <div class="position-selector">
                                    <select id="separaPosition${i}" onchange="updateClassPosition('Separa', ${i}, this.value)">
                                        <option value="">-- Select Student --</option>
                                        ${separaResults.map(result => `
                                            <option value="${result.studentRoll}" ${savedClassPositions['Separa'][i] === result.studentRoll ? 'selected' : ''}>
                                                ${result.studentName} (${result.percentage}%) - Roll: ${result.studentRoll}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>
                            </div>
                        `).join('')}
                    `;
                    positionDiv.appendChild(separaCard);
                    
                    const nooraniResults = monthlyResults.filter(result => {
                        const studentClass = getStudentClass(result.studentRoll);
                        return studentClass === 'Noorani Qayda';
                    }).sort((a, b) => b.percentage - a.percentage);
                    
                    const nooraniCard = document.createElement('div');
                    nooraniCard.className = 'class-position-card noorani';
                    nooraniCard.innerHTML = `
                        <div class="class-header">Noorani Qayda Class - Top 3 Positions</div>
                        ${[1, 2, 3].map(i => `
                            <div class="position-card">
                                <h4>
                                    <span class="position-badge position-${i}" style="position: static; width: 30px; height: 30px; display: inline-flex; margin-right: 10px;">
                                        ${i}
                                    </span>
                                    ${i === 1 ? ' First Position' : i === 2 ? ' Second Position' : ' Third Position'}
                                </h4>
                                <div class="position-selector">
                                    <select id="nooraniPosition${i}" onchange="updateClassPosition('Noorani Qayda', ${i}, this.value)">
                                        <option value="">-- Select Student --</option>
                                        ${nooraniResults.map(result => `
                                            <option value="${result.studentRoll}" ${savedClassPositions['Noorani Qayda'][i] === result.studentRoll ? 'selected' : ''}>
                                                ${result.studentName} (${result.percentage}%) - Roll: ${result.studentRoll}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>
                            </div>
                        `).join('')}
                    `;
                    positionDiv.appendChild(nooraniCard);
                });
            });
        }

        // Update class position in memory
        function updateClassPosition(className, positionNumber, studentRoll) {
            classPositions[className][positionNumber] = studentRoll || null;
        }

        // Search results (public access - individual only)
        function searchResults() {
            const query = document.getElementById('searchQuery').value.trim();
            const resultsDiv = document.getElementById('searchResults');
            
            if (!query) {
                showToast('Please enter roll number!', 'error');
                return;
            }
            
            showMessage('Searching results...', 'info');
            resultsDiv.innerHTML = '<div class="spinner"></div>';
            
            database.ref('results').once('value', snapshot => {
                const results = snapshot.val();
                resultsDiv.innerHTML = '';
                
                if (!results) {
                    resultsDiv.innerHTML = '<div class="result-card"><p>No results found for this roll number.</p></div>';
                    showMessage('', '');
                    return;
                }
                
                let foundResults = [];
                
                Object.keys(results).forEach(resultId => {
                    const result = results[resultId];
                    if (result.studentRoll === query) {
                        foundResults.push(result);
                    }
                });
                
                if (foundResults.length === 0) {
                    resultsDiv.innerHTML = '<div class="result-card"><p>No results found for Roll Number: ' + query + '</p></div>';
                    showMessage('', '');
                    return;
                }
                
                foundResults.sort((a, b) => b.timestamp - a.timestamp);
                const latestResult = foundResults[0];
                const studentClass = getStudentClass(latestResult.studentRoll);
                
                database.ref('classPositions').once('value', posSnapshot => {
                    const positions = posSnapshot.val();
                    let position = null;
                    
                    if (positions && positions[latestResult.examMonth] && positions[latestResult.examMonth].positions) {
                        const classPos = positions[latestResult.examMonth].positions[studentClass];
                        if (classPos) {
                            if (classPos[1] === latestResult.studentRoll) position = 1;
                            else if (classPos[2] === latestResult.studentRoll) position = 2;
                            else if (classPos[3] === latestResult.studentRoll) position = 3;
                        }
                    }
                    
                    displayResultCard(latestResult, position, studentClass);
                    
                    if (foundResults.length > 1) {
                        const infoCard = document.createElement('div');
                        infoCard.className = 'result-card';
                        infoCard.style.borderLeftColor = '#3b82f6';
                        infoCard.innerHTML = `
                            <p><strong> Note:</strong> Only the latest result is shown. 
                            Total ${foundResults.length} results found for this student.</p>
                        `;
                        resultsDiv.appendChild(infoCard);
                    }
                    
                    showMessage('', '');
                });
            });
        }

        // Display result card with position on right side and fine information
        function displayResultCard(result, position = null, studentClass = null) {
            const resultsDiv = document.getElementById('searchResults');
            const gradeClass = `grade-${result.grade.charAt(0).toLowerCase()}`;
            
            let positionBadge = '';
            if (position) {
                let positionText = '';
                if (position === 1) {
                    positionText = '1st Position';
                } else if (position === 2) {
                    positionText = '2nd Position';
                } else if (position === 3) {
                    positionText = '3rd Position';
                }
                
                positionBadge = `
                    <div class="position-badge position-${position}">
                        <div>${position}</div>
                        <div class="position-text">${positionText}</div>
                    </div>
                `;
            }
            
            let fineInfo = '';
            if (result.fine && result.fine > 0) {
                fineInfo = `
                    <div style="margin: 10px 0; padding: 12px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 8px; border: 1px solid #f59e0b;">
                        <p style="color: #92400e; font-weight: bold; margin: 0;">
                            Fine: ${result.fine} (${result.absentDays} absent days)
                        </p>
                    </div>
                `;
            }
            
            const resultCard = document.createElement('div');
            resultCard.className = 'result-card';
            resultCard.innerHTML = `
                ${positionBadge}
                <h3>${result.studentName}</h3>
                <p><strong>Roll Number:</strong> ${result.studentRoll}</p>
                <p><strong>Class:</strong> ${studentClass || getStudentClass(result.studentRoll)}</p>
                <p><strong>Exam Month:</strong> ${result.examMonth}</p>
                
                <div style="margin: 15px 0; padding: 18px; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 10px; border: 2px solid #e2e8f0;">
                    <h4 style="color: #4b0082; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;"> Subject-wise Marks:</h4>
                    <p><strong>Nazra:</strong> ${result.subjects.nazra.obtained}/${result.subjects.nazra.total}</p>
                    <p><strong>Kalma:</strong> ${result.subjects.kalma.obtained}/${result.subjects.kalma.total}</p>
                    <p><strong>Namaz:</strong> ${result.subjects.namaz.obtained}/${result.subjects.namaz.total}</p>
                </div>
                
                <div style="text-align: center; margin: 20px 0; padding: 15px; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-radius: 10px; border: 2px solid #3b82f6;">
                    <div style="font-size: 1.5rem; color: #1e40af; font-weight: bold; margin: 5px 0;">
                        Total: ${result.totalObtained}/${result.overallTotal}
                    </div>
                    ${fineInfo}
                    <div style="font-size: 2rem; color: #3b82f6; font-weight: bold; margin: 10px 0;">
                        ${result.percentage}%
                    </div>
                    <div style="font-size: 1.8rem; color: #667eea; font-weight: bold;">
                        Grade: <span class="grade-badge ${gradeClass}">${result.grade}</span>
                    </div>
                </div>
                
                <p style="margin-top: 15px; color: #666; font-size: 0.9rem; text-align: center;">
                     Date: ${new Date(result.date).toLocaleDateString('en-US', {
                        year: 'numeric', month: 'long', day: 'numeric'
                    })}
                </p>
            `;
            resultsDiv.appendChild(resultCard);
        }

        // Get student class by roll number
        function getStudentClass(rollNumber) {
            const student = allStudents.find(s => s.rollNumber === rollNumber);
            return student ? student.class : 'N/A';
        }

        // ==================== SEPARATE EXPORT FUNCTIONS ====================

        // Export Students to Excel
        function exportStudentsToExcel() {
            showMessage('Preparing students data for export...', 'info');
            
            database.ref('students').once('value', snapshot => {
                const students = snapshot.val();
                
                if (!students) {
                    showToast('No students data to export!', 'error');
                    showMessage('', '');
                    return;
                }
                
                const workbook = XLSX.utils.book_new();
                const fileName = `Mudrasa_Students_${new Date().toISOString().split('T')[0]}.xlsx`;
                
                const studentsData = [];
                studentsData.push(['Roll Number', 'Name', 'Class', 'Status', 'Date Added']);
                
                Object.keys(students).forEach(rollNumber => {
                    const student = students[rollNumber];
                    studentsData.push([
                        student.rollNumber,
                        student.name,
                        student.class,
                        student.status || 'Active',
                        new Date(student.dateAdded).toLocaleDateString()
                    ]);
                });
                
                const studentsSheet = XLSX.utils.aoa_to_sheet(studentsData);
                XLSX.utils.book_append_sheet(workbook, studentsSheet, "Students");
                
                XLSX.writeFile(workbook, fileName);
                showToast('Students data exported successfully!', 'success');
                showMessage('', '');
            }).catch(error => {
                showToast('Error exporting students data: ' + error.message, 'error');
                showMessage('', '');
            });
        }

        // Export Results to Excel
        function exportResultsToExcel() {
            showMessage('Preparing results data for export...', 'info');
            
            database.ref('results').once('value', snapshot => {
                const results = snapshot.val();
                
                if (!results) {
                    showToast('No results data to export!', 'error');
                    showMessage('', '');
                    return;
                }
                
                const workbook = XLSX.utils.book_new();
                const fileName = `Mudrasa_Results_${new Date().toISOString().split('T')[0]}.xlsx`;
                
                const resultsData = [];
                resultsData.push(['Roll No', 'Name', 'Month', 'Nazra', 'Kalma', 'Namaz', 'Total', 'Percentage', 'Grade', 'Fine', 'Absent Days', 'Date']);
                
                Object.keys(results).forEach(resultId => {
                    const result = results[resultId];
                    resultsData.push([
                        result.studentRoll,
                        result.studentName,
                        result.examMonth,
                        `${result.subjects.nazra.obtained}/${result.subjects.nazra.total}`,
                        `${result.subjects.kalma.obtained}/${result.subjects.kalma.total}`,
                        `${result.subjects.namaz.obtained}/${result.subjects.namaz.total}`,
                        `${result.totalObtained}/${result.overallTotal}`,
                        result.percentage + '%',
                        result.grade,
                        result.fine || 0,
                        result.absentDays || 0,
                        new Date(result.date).toLocaleDateString()
                    ]);
                });
                
                const resultsSheet = XLSX.utils.aoa_to_sheet(resultsData);
                XLSX.utils.book_append_sheet(workbook, resultsSheet, "Results");
                
                XLSX.writeFile(workbook, fileName);
                showToast('Results data exported successfully!', 'success');
                showMessage('', '');
            }).catch(error => {
                showToast('Error exporting results data: ' + error.message, 'error');
                showMessage('', '');
            });
        }

        // Export Attendance to Excel
        function exportAttendanceToExcel() {
            showMessage('Preparing attendance data for export...', 'info');
            
            Promise.all([
                database.ref('students').once('value'),
                database.ref('attendance').once('value')
            ]).then(([studentsSnap, attendanceSnap]) => {
                const students = studentsSnap.val();
                const attendance = attendanceSnap.val();
                
                if (!attendance) {
                    showToast('No attendance data to export!', 'error');
                    showMessage('', '');
                    return;
                }
                
                const workbook = XLSX.utils.book_new();
                const fileName = `Mudrasa_Attendance_${new Date().toISOString().split('T')[0]}.xlsx`;
                
                const attendanceData = [];
                attendanceData.push(['Date', 'Class', 'Roll No', 'Name', 'Status']);
                
                Object.keys(attendance).forEach(attendanceId => {
                    const record = attendance[attendanceId];
                    Object.keys(record.students || {}).forEach(rollNumber => {
                        let studentName = '';
                        if (students && students[rollNumber]) {
                            studentName = students[rollNumber].name;
                        }
                        
                        attendanceData.push([
                            record.date,
                            record.class,
                            rollNumber,
                            studentName,
                            record.students[rollNumber]
                        ]);
                    });
                });
                
                const attendanceSheet = XLSX.utils.aoa_to_sheet(attendanceData);
                XLSX.utils.book_append_sheet(workbook, attendanceSheet, "Attendance");
                
                XLSX.writeFile(workbook, fileName);
                showToast('Attendance data exported successfully!', 'success');
                showMessage('', '');
            }).catch(error => {
                showToast('Error exporting attendance data: ' + error.message, 'error');
                showMessage('', '');
            });
        }

        // Export Positions to Excel
        function exportPositionsToExcel() {
            showMessage('Preparing positions data for export...', 'info');
            
            Promise.all([
                database.ref('students').once('value'),
                database.ref('results').once('value'),
                database.ref('classPositions').once('value')
            ]).then(([studentsSnap, resultsSnap, positionsSnap]) => {
                const students = studentsSnap.val();
                const results = resultsSnap.val();
                const positions = positionsSnap.val();
                
                if (!positions) {
                    showToast('No positions data to export!', 'error');
                    showMessage('', '');
                    return;
                }
                
                const workbook = XLSX.utils.book_new();
                const fileName = `Mudrasa_Positions_${new Date().toISOString().split('T')[0]}.xlsx`;
                
                const positionsData = [];
                positionsData.push(['Month', 'Class', 'Position', 'Roll No', 'Name', 'Percentage']);
                
                Object.keys(positions).forEach(month => {
                    const classPos = positions[month].positions;
                    Object.keys(classPos).forEach(className => {
                        const pos = classPos[className];
                        for (let i = 1; i <= 3; i++) {
                            if (pos[i]) {
                                let studentName = '';
                                if (students && students[pos[i]]) {
                                    studentName = students[pos[i]].name;
                                }
                                
                                let percentage = '';
                                if (results) {
                                    Object.values(results).forEach(result => {
                                        if (result.studentRoll === pos[i] && result.examMonth === month) {
                                            percentage = result.percentage + '%';
                                        }
                                    });
                                }
                                
                                let positionText = '';
                                if (i === 1) positionText = '1st Position ';
                                else if (i === 2) positionText = '2nd Position ';
                                else if (i === 3) positionText = '3rd Position ';
                                
                                positionsData.push([
                                    month,
                                    className,
                                    positionText,
                                    pos[i],
                                    studentName,
                                    percentage
                                ]);
                            }
                        }
                    });
                });
                
                const positionsSheet = XLSX.utils.aoa_to_sheet(positionsData);
                XLSX.utils.book_append_sheet(workbook, positionsSheet, "Positions");
                
                XLSX.writeFile(workbook, fileName);
                showToast('Positions data exported successfully!', 'success');
                showMessage('', '');
            }).catch(error => {
                showToast('Error exporting positions data: ' + error.message, 'error');
                showMessage('', '');
            });
        }

        // Export All Data to Excel
        function exportAllToExcel() {
            showMessage('Preparing all data for export...', 'info');
            
            Promise.all([
                database.ref('students').once('value'),
                database.ref('results').once('value'),
                database.ref('attendance').once('value'),
                database.ref('classPositions').once('value')
            ]).then(([studentsSnap, resultsSnap, attendanceSnap, positionsSnap]) => {
                const students = studentsSnap.val();
                const results = resultsSnap.val();
                const attendance = attendanceSnap.val();
                const positions = positionsSnap.val();
                
                if (!students && !results && !attendance && !positions) {
                    showToast('No data to export!', 'error');
                    showMessage('', '');
                    return;
                }
                
                const workbook = XLSX.utils.book_new();
                const fileName = `Mudrasa_All_Data_${new Date().toISOString().split('T')[0]}.xlsx`;
                
                if (students) {
                    const studentsData = [];
                    studentsData.push(['Roll Number', 'Name', 'Class', 'Status', 'Date Added']);
                    
                    Object.keys(students).forEach(rollNumber => {
                        const student = students[rollNumber];
                        studentsData.push([
                            student.rollNumber,
                            student.name,
                            student.class,
                            student.status || 'Active',
                            new Date(student.dateAdded).toLocaleDateString()
                        ]);
                    });
                    
                    const studentsSheet = XLSX.utils.aoa_to_sheet(studentsData);
                    XLSX.utils.book_append_sheet(workbook, studentsSheet, "Students");
                }
                
                if (results) {
                    const resultsData = [];
                    resultsData.push(['Roll No', 'Name', 'Month', 'Nazra', 'Kalma', 'Namaz', 'Total', 'Percentage', 'Grade', 'Fine', 'Absent Days', 'Date']);
                    
                    Object.keys(results).forEach(resultId => {
                        const result = results[resultId];
                        resultsData.push([
                            result.studentRoll,
                            result.studentName,
                            result.examMonth,
                            `${result.subjects.nazra.obtained}/${result.subjects.nazra.total}`,
                            `${result.subjects.kalma.obtained}/${result.subjects.kalma.total}`,
                            `${result.subjects.namaz.obtained}/${result.subjects.namaz.total}`,
                            `${result.totalObtained}/${result.overallTotal}`,
                            result.percentage + '%',
                            result.grade,
                            result.fine || 0,
                            result.absentDays || 0,
                            new Date(result.date).toLocaleDateString()
                        ]);
                    });
                    
                    const resultsSheet = XLSX.utils.aoa_to_sheet(resultsData);
                    XLSX.utils.book_append_sheet(workbook, resultsSheet, "Results");
                }
                
                if (attendance) {
                    const attendanceData = [];
                    attendanceData.push(['Date', 'Class', 'Roll No', 'Name', 'Status']);
                    
                    Object.keys(attendance).forEach(attendanceId => {
                        const record = attendance[attendanceId];
                        Object.keys(record.students || {}).forEach(rollNumber => {
                            let studentName = '';
                            if (students && students[rollNumber]) {
                                studentName = students[rollNumber].name;
                            }
                            
                            attendanceData.push([
                                record.date,
                                record.class,
                                rollNumber,
                                studentName,
                                record.students[rollNumber]
                            ]);
                        });
                    });
                    
                    const attendanceSheet = XLSX.utils.aoa_to_sheet(attendanceData);
                    XLSX.utils.book_append_sheet(workbook, attendanceSheet, "Attendance");
                }
                
                if (positions) {
                    const positionsData = [];
                    positionsData.push(['Month', 'Class', 'Position', 'Roll No', 'Name', 'Percentage']);
                    
                    Object.keys(positions).forEach(month => {
                        const classPos = positions[month].positions;
                        Object.keys(classPos).forEach(className => {
                            const pos = classPos[className];
                            for (let i = 1; i <= 3; i++) {
                                if (pos[i]) {
                                    let studentName = '';
                                    if (students && students[pos[i]]) {
                                        studentName = students[pos[i]].name;
                                    }
                                    
                                    let percentage = '';
                                    if (results) {
                                        Object.values(results).forEach(result => {
                                            if (result.studentRoll === pos[i] && result.examMonth === month) {
                                                percentage = result.percentage + '%';
                                            }
                                        });
                                    }
                                    
                                    let positionText = '';
                                    if (i === 1) positionText = '1st Position ';
                                    else if (i === 2) positionText = '2nd Position ';
                                    else if (i === 3) positionText = '3rd Position ';
                                    
                                    positionsData.push([
                                        month,
                                        className,
                                        positionText,
                                        pos[i],
                                        studentName,
                                        percentage
                                    ]);
                                }
                            }
                        });
                    });
                    
                    const positionsSheet = XLSX.utils.aoa_to_sheet(positionsData);
                    XLSX.utils.book_append_sheet(workbook, positionsSheet, "Positions");
                }
                
                XLSX.writeFile(workbook, fileName);
                showToast('All data exported successfully!', 'success');
                showMessage('', '');
            }).catch(error => {
                showToast('Error exporting data: ' + error.message, 'error');
                showMessage('', '');
            });
        }

        // ==================== DELETE FUNCTIONS ====================

        // Delete all results
        function deleteAllResults() {
            const confirmation = confirm('Are you sure you want to delete ALL results? This action cannot be undone!\n\nEnter admin code to confirm:');
            if (!confirmation) return;
            
            const enteredCode = prompt('Enter admin code to confirm deletion:');
            if (enteredCode !== ADMIN_CODE) {
                showToast('Invalid admin code! Deletion cancelled.', 'error');
                return;
            }
            
            showMessage('Deleting results...', 'warning');
            
            database.ref('results').remove()
                .then(() => {
                    showToast('All results deleted successfully!', 'success');
                    showMessage('', '');
                })
                .catch(error => {
                    showToast('Error deleting results: ' + error.message, 'error');
                    showMessage('', '');
                });
        }

        // Delete all students
        function deleteAllStudents() {
            const confirmation = confirm('Are you sure you want to delete ALL students? This will also remove all their results!\n\nEnter admin code to confirm:');
            if (!confirmation) return;
            
            const enteredCode = prompt('Enter admin code to confirm deletion:');
            if (enteredCode !== ADMIN_CODE) {
                showToast('Invalid admin code! Deletion cancelled.', 'error');
                return;
            }
            
            showMessage('Deleting students...', 'warning');
            
            database.ref('students').remove()
                .then(() => {
                    showToast('All students deleted successfully!', 'success');
                    loadAllStudentsTable();
                    loadStudentList();
                    showMessage('', '');
                })
                .catch(error => {
                    showToast('Error deleting students: ' + error.message, 'error');
                    showMessage('', '');
                });
        }

        // Delete all attendance
        function deleteAllAttendance() {
            const confirmation = confirm('Are you sure you want to delete ALL attendance records?\n\nEnter admin code to confirm:');
            if (!confirmation) return;
            
            const enteredCode = prompt('Enter admin code to confirm deletion:');
            if (enteredCode !== ADMIN_CODE) {
                showToast('Invalid admin code! Deletion cancelled.', 'error');
                return;
            }
            
            showMessage('Deleting attendance...', 'warning');
            
            database.ref('attendance').remove()
                .then(() => {
                    showToast('All attendance records deleted successfully!', 'success');
                    showMessage('', '');
                })
                .catch(error => {
                    showToast('Error deleting attendance: ' + error.message, 'error');
                    showMessage('', '');
                });
        }

        // Delete all positions
        function deleteAllPositions() {
            const confirmation = confirm('Are you sure you want to delete ALL positions records?\n\nEnter admin code to confirm:');
            if (!confirmation) return;
            
            const enteredCode = prompt('Enter admin code to confirm deletion:');
            if (enteredCode !== ADMIN_CODE) {
                showToast('Invalid admin code! Deletion cancelled.', 'error');
                return;
            }
            
            showMessage('Deleting positions...', 'warning');
            
            database.ref('classPositions').remove()
                .then(() => {
                    showToast('All positions records deleted successfully!', 'success');
                    showMessage('', '');
                })
                .catch(error => {
                    showToast('Error deleting positions: ' + error.message, 'error');
                    showMessage('', '');
                });
        }

        // Delete all data
        function deleteAllData() {
            const confirmation = confirm('WARNING: This will delete ALL students, results, attendance and positions! This action cannot be undone!\n\nEnter admin code to confirm:');
            if (!confirmation) return;
            
            const enteredCode = prompt('Enter admin code to confirm deletion:');
            if (enteredCode !== ADMIN_CODE) {
                showToast('Invalid admin code! Deletion cancelled.', 'error');
                return;
            }
            
            showMessage('Deleting all data...', 'warning');
            
            Promise.all([
                database.ref('students').remove(),
                database.ref('results').remove(),
                database.ref('attendance').remove(),
                database.ref('classPositions').remove(),
                database.ref('excelBackups').remove()
            ]).then(() => {
                localStorage.removeItem('mudrasaExcelFileInfo');
                localStorage.removeItem('mudrasaExcelFileData');
                localStorage.removeItem('mudrasaAdminCode');
                localStorage.removeItem('mudrasaAdminLoggedIn');
                
                currentExcelFile = null;
                currentExcelData = null;
                
                showToast('All data deleted successfully!', 'success');
                loadAllStudentsTable();
                loadStudentList();
                showMessage('', '');
            }).catch(error => {
                showToast('Error deleting data: ' + error.message, 'error');
                showMessage('', '');
            });
        }

        // Load all students (global)
        function loadAllStudents() {
            database.ref('students').once('value', snapshot => {
                const students = snapshot.val();
                allStudents = students ? Object.values(students) : [];
            });
        }
    </script>
</body>
</html>